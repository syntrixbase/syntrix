# Task: Trigger Evaluator Integration with Puller

## Status
- [ ] Draft
- [ ] In Progress
- [ ] Completed

## Context
Currently, in Standalone mode, both the `Puller` service and the `TriggerEvaluator` independently watch MongoDB change streams. This results in:
1.  **Redundant Connections**: Double the number of connections to MongoDB (one for Puller, one for Trigger).
2.  **Redundant Processing**: Both services deserialize and process the same raw BSON events.
3.  **Resource Waste**: Unnecessary network bandwidth and CPU usage.

Since `Puller` is designed to be the central "Change Data Capture" (CDC) component, it should be the single source of truth for change events. Other components like `TriggerEvaluator` should consume from `Puller`, especially in Standalone mode where this can be done efficiently in-memory.

## Objective
Optimize `TriggerEvaluator` to consume events directly from the `Puller` service when running in Standalone mode.

## Design

### 1. Architecture
*   **Current**: `TriggerEngine` -> `DefaultWatcher` -> `Storage.Watch` -> `MongoDB`
*   **Target**: `TriggerEngine` -> `PullerWatcher` -> `Puller.Subscribe` -> `Puller Internal Buffer` -> `MongoDB`

### 2. New Watcher Implementation (`PullerWatcher`)
We will create a new implementation of the `DocumentWatcher` interface in `internal/trigger/internal/watcher/puller_watcher.go`.

**Responsibilities:**
1.  **Subscription**: Call `puller.Service.Subscribe(ctx, "trigger-evaluator", lastCheckpoint)`.
2.  **Adaptation**: Convert `events.NormalizedEvent` (Puller model) to `types.Event` (Storage/Trigger model).
3.  **Checkpointing**:
    *   The `TriggerEvaluator` persists its progress in `sys/checkpoints`.
    *   When using `PullerWatcher`, the "resume token" will be the Puller's `EventID` (string) instead of the raw MongoDB resume token.
    *   The adapter must handle this distinction transparently.

**Event Mapping:**
*   `NormalizedEvent.EventID` -> `Event.ResumeToken` (as string)
*   `NormalizedEvent.TenantID` -> `Event.TenantID`
*   `NormalizedEvent.Collection` -> `Event.Collection`
*   `NormalizedEvent.Type` -> `Event.Type` (Map `insert`->`create`, etc.)
*   `NormalizedEvent.FullDocument` -> `Event.Document`
*   `NormalizedEvent.DocumentID` -> `Event.Id`

### 3. Factory Updates
Modify `internal/trigger/engine/factory.go`:
*   Add `WithPuller(p puller.Service)` option to `FactoryOption`.
*   In `Engine()`, check if `puller` is configured.
    *   If **Yes**: Instantiate `PullerWatcher`.
    *   If **No**: Fallback to `DefaultWatcher` (direct MongoDB watch).

### 4. Service Manager Integration
Modify `internal/services/manager_init.go`:
*   In `initTriggerServices`, check if `m.pullerService` (LocalService) is available.
*   If available, pass it to `trigger.NewFactory` using `WithPuller`.

## Implementation Steps

1.  **Create Adapter (`internal/trigger/internal/watcher/puller_watcher.go`)**
    *   Implement `DocumentWatcher` interface.
    *   Implement event conversion logic.
    *   Implement `Watch` loop to bridge Puller channel to Trigger channel.

2.  **Update Trigger Factory (`internal/trigger/engine/factory.go`)**
    *   Add `puller` field to factory struct.
    *   Add `WithPuller` option.
    *   Update `Engine()` to select the correct watcher.

3.  **Update Service Manager (`internal/services/manager_init.go`)**
    *   Inject `pullerService` into Trigger factory when initializing in Standalone mode (or whenever Puller is enabled locally).

4.  **Verification**
    *   Unit tests for `PullerWatcher` (mocking Puller).
    *   Integration test: Run in standalone mode, insert document, verify Trigger fires without `TriggerEvaluator` opening its own MongoDB stream (can verify via logs or connection counts, or by mocking the storage layer).

## Dependencies
*   `internal/puller` package (for `Service` interface and `events` package).
*   `internal/trigger` package.

## Notes
*   This change makes `TriggerEvaluator` dependent on `Puller` when configured. Ensure `Puller` is started *before* `TriggerEvaluator` (Service Manager already handles this order, but double-check).
*   The `Puller` must be configured to watch the collections that Triggers are interested in. Currently, Puller watches everything by default (except system collections), which matches Trigger requirements.
