# Task: Trigger Evaluator Integration with Puller

## Status
- [ ] Draft
- [ ] In Progress
- [ ] Completed

## Context
Currently, in Standalone mode, both the `Puller` service and the `TriggerEvaluator` independently watch MongoDB change streams. This results in:
1.  **Redundant Connections**: Double the number of connections to MongoDB (one for Puller, one for Trigger).
2.  **Redundant Processing**: Both services deserialize and process the same raw BSON events.
3.  **Resource Waste**: Unnecessary network bandwidth and CPU usage.

Since `Puller` is designed to be the central "Change Data Capture" (CDC) component, it should be the single source of truth for change events. Other components like `TriggerEvaluator` should consume from `Puller`, especially in Standalone mode where this can be done efficiently in-memory.

## Objective
Optimize `TriggerEvaluator` to consume events directly from the `Puller` service when running in Standalone mode.

## Design

### 1. Architecture
*   **Current**: `TriggerEngine` -> `DefaultWatcher` -> `Storage.Watch` -> `MongoDB`
*   **Target**: `TriggerEngine` -> `PullerWatcher` -> `Puller.Subscribe` -> `Puller Internal Buffer` -> `MongoDB`

### 2. New Watcher Implementation
We will **rewrite** `internal/trigger/internal/watcher/watcher.go` to consume from the Puller service instead of watching MongoDB directly.

**Changes:**
*   **Delete** the existing `defaultWatcher` struct and its direct MongoDB watching logic.
*   Implement the new watcher logic using `puller.Service`.

**Responsibilities:**
1.  **Subscription**: Call `puller.Service.Subscribe(ctx, consumerID, lastCheckpoint)`.
    *   `consumerID` should be unique per watcher instance, e.g., `"trigger-evaluator-<tenant>"`.
2.  **Filtering**: **Crucial**: The Watcher must filter events to only pass through those where `PullerEvent.Change.TenantID` matches the Watcher's configured `tenant`.
3.  **Adaptation**: Convert `events.PullerEvent` (Puller model) to `types.Event` (Storage/Trigger model).
4.  **Checkpointing**:
    *   The `TriggerEvaluator` persists its progress in `sys/checkpoints`.
    *   The "resume token" will be the Puller's `Progress` (string) instead of the raw MongoDB resume token.

**Event Mapping:**
*   `PullerEvent.Progress` -> `Event.ResumeToken` (as string)
*   `PullerEvent.Change.TenantID` -> `Event.TenantID`
*   `PullerEvent.Change.OpType` -> `Event.Type`
    *   `insert` -> `create`
    *   `update`, `replace`:
        *   If `FullDocument.Deleted == true` -> `delete` (Soft Delete)
        *   Else if `OpType == replace` -> `create` (Re-creation/Overwrite)
        *   Else -> `update`
    *   `delete` -> `delete` (Hard Delete)
*   `PullerEvent.Change.FullDocument` -> `Event.Document`
*   `PullerEvent.Change.MgoDocID` -> `Event.Id`
*   **Special Handling for Delete**:
    *   Since `Puller` does not provide the "before" document, and `Event.Collection` does not exist on the `Event` struct (it's on the `Document`), we must construct a minimal `Event.Before` document for Delete events.
    *   `Event.Before` = `&storage.Document{Collection: PullerEvent.Change.MgoColl, Id: PullerEvent.Change.MgoDocID, TenantID: PullerEvent.Change.TenantID}`.
    *   This ensures the Trigger Evaluator can correctly match the collection.

### 3. Factory Updates
Modify `internal/trigger/engine/factory.go`:
*   Add `WithPuller(p puller.Service)` option to `FactoryOption`.
*   In `Engine()`, check if `puller` is configured.
    *   If **Yes**: Instantiate the new `Watcher` with the puller service.
    *   If **No**: Return error. **Puller is now mandatory** for the Trigger Engine.

### 4. Service Manager Integration
Modify `internal/services/manager_init.go`:
*   Ensure `m.pullerService` is initialized before `initTriggerServices`.
*   Pass `m.pullerService` to `trigger.NewFactory` using `WithPuller`.
*   If `m.pullerService` is not available (e.g. Puller disabled in config), `initTriggerServices` should fail or skip trigger initialization with a warning.

## Implementation Steps

1.  **Rewrite Watcher (`internal/trigger/internal/watcher/watcher.go`)**
    *   **Delete** `defaultWatcher` struct and methods.
    *   Update `NewWatcher` signature to accept `puller.Service`.
    *   Implement `Watch` using `puller.Subscribe`.
    *   Implement filtering by tenant.
    *   Implement event conversion logic.

2.  **Update Watcher Tests (`internal/trigger/internal/watcher/watcher_test.go`)**
    *   Update tests to mock `puller.Service` instead of `storage.DocumentStore` for the watch stream.
    *   Verify filtering and event mapping logic.

3.  **Update Trigger Factory (`internal/trigger/engine/factory.go`)**
    *   Add `puller` field to factory struct.
    *   Add `WithPuller` option.
    *   Update `Engine()` to enforce `puller` presence and pass it to `NewWatcher`.

4.  **Update Service Manager (`internal/services/manager_init.go`)**
    *   Ensure Puller is started before Triggers.
    *   Inject `pullerService` into Trigger factory.

5.  **Verification**
    *   Run unit tests.
    *   **Integration test**: Update integration tests to spin up the `Puller` service alongside the Trigger service. Verify that Triggers receive events via the Puller.

## Dependencies
*   `internal/puller` package (for `Service` interface and `events` package).
*   `internal/trigger` package.

## Notes
*   **Mandatory Dependency**: `TriggerEvaluator` now strictly depends on `Puller`.
*   The `Puller` must be configured to watch the collections that Triggers are interested in.
