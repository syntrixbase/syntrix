# Task 032: Query Service gRPC Migration

**Created**: 2026-01-08
**Status**: Completed
**Design Doc**: [docs/design/server/query/001.grpc-migration.md](../docs/design/server/query/001.grpc-migration.md)

## Objective

Migrate the Query service from HTTP/JSON to gRPC/Protocol Buffers, aligning with existing Puller and Streamer services for architectural consistency and performance.

## Background

The Query service currently uses HTTP/JSON while Puller and Streamer use gRPC. This migration unifies the internal communication protocol and provides:
- 30-50% smaller payloads (binary vs JSON)
- Better connection reuse (HTTP/2 multiplexing)
- Compile-time type safety
- Architectural consistency

## Files to Create

| File | Description |
|------|-------------|
| `api/proto/query.proto` | Protocol Buffers definition |
| `api/gen/query/v1/*.go` | Generated gRPC code |
| `internal/query/internal/grpc/server.go` | gRPC server adapter |
| `internal/query/internal/grpc/server_test.go` | Server tests |
| `internal/query/internal/grpc/convert.go` | Proto ↔ Domain conversion |
| `internal/query/internal/grpc/convert_test.go` | Conversion tests |

## Files to Modify

| File | Change |
|------|--------|
| `internal/query/interface.go` | Add `NewGRPCServer()`, `NewGRPCClient()` factories |
| `internal/query/internal/client/client.go` | Replace HTTP with gRPC implementation |
| `internal/query/internal/client/client_test.go` | Update tests for gRPC |
| `internal/services/manager_init.go` | Use gRPC server instead of HTTP |
| `internal/api/rest/handler.go` | Update query service usage |
| `internal/api/realtime/server.go` | Update query service usage |
| `internal/identity/internal/authz/engine.go` | Update query service usage |

## Files to Delete (Phase 3)

| File | Reason |
|------|--------|
| `internal/query/internal/httphandler/handler.go` | Replaced by gRPC |
| `internal/query/internal/httphandler/handler_test.go` | Replaced by gRPC |
| `internal/query/internal/httphandler/mock_service_test.go` | Replaced by gRPC |

## Tasks

### Phase 1: Proto Definition and Code Generation

- [ ] **1.1** Create `api/proto/query.proto`
  - Define `QueryService` with 8 RPC methods
  - Define message types: Document, Filter, Query, OrderBy
  - Define request/response messages for each RPC

- [ ] **1.2** Generate Go code
  - Run `protoc` to generate `api/gen/query/v1/*.go`
  - Update Makefile if needed

### Phase 2: gRPC Server Implementation

- [ ] **2.1** Create `internal/query/internal/grpc/convert.go`
  - `documentToProto(model.Document) *pb.Document`
  - `protoToDocument(*pb.Document) model.Document`
  - `filterToProto(model.Filter) *pb.Filter`
  - `protoToFilter(*pb.Filter) model.Filter`
  - `queryToProto(model.Query) *pb.Query`
  - `protoToQuery(*pb.Query) model.Query`
  - `errorToStatus(error) error` - domain error to gRPC status

- [ ] **2.2** Create `internal/query/internal/grpc/server.go`
  - Implement `pb.QueryServiceServer` interface
  - Wrap `query.Service` and delegate to it
  - Convert proto ↔ domain types
  - Handle errors with proper gRPC status codes

- [ ] **2.3** Add unit tests
  - `convert_test.go` for conversion functions
  - `server_test.go` for gRPC server

### Phase 3: gRPC Client Implementation

- [ ] **3.1** Rewrite `internal/query/internal/client/client.go`
  - Replace HTTP client with gRPC client
  - Implement `query.Service` interface
  - Handle gRPC status to domain error conversion

- [ ] **3.2** Update client tests
  - Mock gRPC server for testing
  - Test all 8 RPC methods
  - Test error handling

### Phase 4: Interface Updates

- [ ] **4.1** Update `internal/query/interface.go`
  - Add `NewGRPCServer(s Service) pb.QueryServiceServer`
  - Update `NewClient(addr string) Service` to use gRPC

### Phase 5: Integration

- [ ] **5.1** Update `internal/services/manager_init.go`
  - Register gRPC server instead of HTTP server
  - Update port configuration if needed

- [ ] **5.2** Update consumers
  - `internal/api/rest/handler.go`
  - `internal/api/realtime/server.go`
  - `internal/identity/internal/authz/engine.go`

### Phase 6: Testing and Cleanup

- [ ] **6.1** Run all tests
  - `make test`
  - `make coverage`

- [ ] **6.2** Integration testing
  - Test distributed mode with gRPC
  - Test standalone mode (local service)

- [ ] **6.3** Remove deprecated HTTP handler
  - Delete `internal/query/internal/httphandler/`
  - Update any remaining references

## Reference Implementation

Refer to existing gRPC implementations:
- **Streamer**: `internal/streamer/grpc_adapter.go`, `internal/streamer/convert.go`
- **Puller**: `internal/puller/internal/grpc/server.go`, `internal/puller/client.go`
- **Proto files**: `api/proto/streamer.proto`, `api/proto/puller.proto`

## Acceptance Criteria

- [ ] All 8 Query service methods available via gRPC
- [ ] gRPC client implements `query.Service` interface
- [ ] Error handling maps domain errors to gRPC status codes
- [ ] All tests pass (`make test`)
- [ ] Coverage maintained or improved
- [ ] HTTP handler removed (Phase 3)
- [ ] Manager uses gRPC in distributed mode
