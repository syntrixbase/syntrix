# Query Surface Encapsulation & HTTP Adapter Refactor

Date: December 26, 2025
Status: In Progress
Scope: Reduce query surface to interface-only, hide implementations behind internal packages, and align constructors/HTTP adapters for local and remote use.

## Goals
- Expose only the `Service` interface and factory functions; keep engine/server/client implementations internal.
- Provide clear construction paths for local (in-process) and remote (HTTP) usage with minimal public API.
- Normalize HTTP handler exposure via a single entry-point and tighten coupling to `Service`.
- Update docs/tests so behavior and contracts remain verifiable and discoverable.
- Enforce multi-tenant isolation end-to-end (Service, HTTP, replication, watch) with explicit tenant on requests and no cross-tenant reads/writes.

## Current Gaps
1) Exported `Engine`, `Server`, and `Client` reveal implementation details; callers can depend on internals directly.
2) HTTP adapter is a concrete `Server` type; no public handler factory accepting a `Service` abstraction.
3) Constructors are inconsistent (local uses `NewEngine`, remote uses `NewClient` but both expose structs). No facade enforcing interface-only usage.
4) Tests rely on concrete types and internal fields; coverage for interface/adapter contracts is thin.
5) Design docs lag behind current behavior and public surface decisions.
6) Multi-tenant behavior is implemented in code (tenant argument across Service/HTTP) but not yet captured in design docs or test matrices (edge validation, default tenant fallback, per-tenant isolation of index/change streams).

## Decisions Needed
- Public surface: keep `Service` interface plus `NewService(storage.DocumentStore, cspURL string) Service`, `NewClient(baseURL string) Service`, and `NewHTTPHandler(s Service) http.Handler`.
- Implementation layout: move concrete structs into `internal/query/internal/{engine,http,client}` with unexported types.
- Backward compatibility: provide shims if needed (prefer breaking concretes now to enforce interface usage).
- Testing approach: migrate to testify; focus on interface contract tests, HTTP black-box tests, and client/handler parity tests.
- Documentation: add design notes capturing “Why” (encapsulation, alignment with identity) and “How” (factories, routing, tests).

## Plan
- Add factories in `query` package: `NewService`, `NewClient`, `NewHTTPHandler`; keep `Service` interface in place.
- Relocate concrete implementations into internal subpackages; rename structs to unexported types and adjust imports.
- Update command wiring and call sites to use factories (no direct struct refs).
- Refresh tests: interface contract tests, handler black-box tests via `httptest`, client-to-handler parity tests; use testify.
- Documentation: add/refresh query design docs to record reasoning and API surface; update task index/status as work proceeds.
- Multi-tenant checks: ensure tenant is required on public entrypoints (with temporary `DefaultTenantID` for dev), index/rebuild/checkpoint partitioning per tenant, and watch/replication routing stays tenant-scoped.

## Execution Steps (detailed)
1) **Package encapsulation**
	- Move engine/server/client concretes under `internal/engine/internal/{query,data,index,http,client}` with unexported types; keep only `Service` + factories exported.
	- Sweep imports to remove direct struct references; enforce interface use in cmd wiring.
2) **Tenant propagation**
	- Ensure `Service` methods, HTTP payloads, replication/watch requests all accept `tenant` and default only to `model.DefaultTenantID` in dev/tests.
	- Validate tenant early in handlers/clients; prevent cross-tenant access in data/index/change-stream checkpoints and rebuild state.
3) **Factories and wiring**
	- Implement `NewService(storage.DocumentStore, cspURL string) Service`, `NewClient(baseURL string) Service`, `NewHTTPHandler(s Service) http.Handler`.
	- Update `cmd/syntrix` and `cmd/syntrix-cli` to construct via factories; ensure HTTP handler uses `NewHTTPHandler`.
4) **Query execution policies**
	- Enforce index-first with bounded fallback: honor `fallback_docs_max` (default 500 docs, counts tombstones/filtered rows); `index-required` is hardcoded true (no config/branch). Return `IndexNotReady` when cap exceeded/disabled.
	- Wire `Data` scan batching (500) and `Query` batch fetch (128) configs; plumb into config structs/env.
5) **Cursor/OrderKey versioning**
	- Add encoding-version byte to cursor/order key; on mismatch, return `IndexNotReady` and trigger rebuild flow (no new template).
	- Keep cursor opaque on wire; consider optional structured form later (open item).
6) **Index templates and includeDeleted**
	- Implement template matching/validation (path patterns, tie-break rules, dedupe fields); includeDeleted always true.
	- Ensure apply/upsert encodes order keys with version byte; startAfter reuse same encoding.
7) **Change stream puller**
	- Implement single/pool puller fan-out with checkpoints, backpressure, and lag→rebuild signals; default JetStream params (retention ~10m, replicas 1/3, max_ack_pending=200, ack_wait=5s) when NATS enabled.
8) **HTTP/Client behavior**
	- Map `IndexNotReady` consistently; no retries for mutating ops; allow bounded fallback transparently only when under cap.
	- Keep routes/JSON stable; watch streaming unchanged.
9) **Tests (testify)**
	- Service interface contract, HTTP handler black-box (status/body/errors), client↔handler parity, query index-hit/fallback ordering+limits+startAfter, cursor version mismatch → `IndexNotReady`, puller lag/backpressure/rebuild trigger.
	- Multi-tenant coverage: tenant required on handlers/clients, default tenant only when empty, isolation across tenants for query/read/write/watch/replication, per-tenant index/checkpoint partitioning.
10) **Docs & task updates**
	- Keep design docs in sync (engine 000–007); add operator support table if needed; mark 003_query as legacy once migration finishes.

## Execution Decisions (locked)
- **Config placement & defaults**: Add under `config.yml` → `query`: `fallback_docs_max`=500 (int), `data_scan_batch`=500, `query_fetch_batch`=128, `jetstream` block `{enabled: false, url: env NATS_URL, retention: 10m, replicas: 1, max_ack_pending: 200, ack_wait: 5s}`. Read on startup; no hot-reload in this iteration. CLI flags may override for tests. `index_required` is hardcoded true in code (not configurable).
- **Call-site migration**: Sweep for exported `Engine`/`Server`/`Client` usage (grep `NewEngine`, struct names) across `cmd/`, `internal/`, `pkg/`; replace with `Service` factories and remove direct struct deps. Add a lint note in PR to reject new imports.
- **Cursor/OrderKey encoding**: Prefix 1-byte version, then tuple-encode fields (big-endian nums, length-prefixed strings), append direction bit per field (asc=0, desc=1) or invert sortable bytes for desc. Serialize cursor as URL-safe base64. Version mismatch → `IndexNotReady`; rebuild existing index with new encoding (no new template).
- **Index hinting**: For now, responses remain minimal; do not emit index suggestions. Log/metric only. (Optional hint surface can be added later without breaking change.)
- **Operator matrix**: Allow `==`, `!=`, `>`, `>=`, `<`, `<=`, `in` (array), `exists` (bool). OrderBy allowed only on indexed fields; initial support single-field order (composite later). Post-filter permitted for non-indexable filters only when index provides candidates.
- **JetStream optionality**: Default `jetstream.enabled=false`. If enabled and URL missing → fail fast. When disabled, use storage change stream direct path. Keep config validation.
- **Test prioritization**: P0: Service contract, HTTP black-box, client↔handler parity, query index-hit/fallback (caps, startAfter), cursor version mismatch → IndexNotReady. P1: puller lag/backpressure/rebuild triggers, JetStream happy/error paths, hot/warm/cold hooks.
- **Metrics/observability**: Add counters for IndexNotReady, fallback served/blocked, index hits/misses, puller lag/backpressure events. Keep interface hooks internal; expose via existing metrics sink.

## Implementation Notes / Risks
- Ensure HTTP routes stay stable (`/internal/v1/*`, replication paths) while hiding types.
- Watch streaming behavior and replication CAS semantics remain unchanged after refactor.
- Beware of downstream packages importing concrete types; need a sweep to replace with `Service` usage.

## Verification
- Unit tests (testify) for `Service` contract, HTTP handler behaviors, client/handler parity, replication flows.
- Lint/build once refactor lands.

## Status Log
- 2025-12-26: Task created, status set to In Progress.
- 2025-12-26: Added engine design drafts (requirements, architecture) under docs/design/server/engine.
- 2025-12-26: Documented index store placement (kept under query internals, not primary storage).
- 2025-12-26: Refined architecture (change event schema, query batching/fallback, rebuild throttling, watch strategy) in docs/design/server/engine/001_architecture.md.
- 2025-12-26: Added per-module responsibilities/interfaces/tests to docs/design/server/engine/001_architecture.md.
- 2025-12-26: Added detailed module docs (data/index/query/http/client) under docs/design/server/engine/002-006.*.md.
- 2025-12-26: Further refined open points (hash/payload policy, hot/warm/cold rules, cursor/order encoding, error/backoff guidance) across module docs and architecture.
- 2025-12-26: Added actionable defaults (batch sizes, throttles, timeouts, retries, guardrails) to module docs for execution readiness.
- 2025-12-26: Documented change-stream fan-out/checkpoint/backpressure strategy for index consumers (003.index.md) and added to architecture open items.
- 2025-12-26: Added puller design (change stream pull + fan-out, checkpoints, lag/backpressure) in docs/design/server/engine/007.puller.md.
- 2025-12-26: Added NATS/JetStream option with retention (5–10m), ordering, flow control to puller design.
- 2025-12-26: Fixed puller defaults formatting and added explicit JetStream defaults (retention 10m, storage=file, replicas 1/3, max_ack_pending=200, ack_wait=5s).
- 2025-12-26: Clarified JetStream semantics (single-subject ordering, idempotent apply, external checkpoints, gap→rebuild) in puller design.
- 2025-12-26: Added JetStream vs Kafka tradeoff notes (latency, retention/cost, ops weight, when to pick Kafka) in puller design.
- 2025-12-26: Added index template format/matching/encoding/apply rules to docs/design/server/engine/003.index.md.
- 2025-12-26: Set index-required=true (no fallback scans), clarified IndexNotReady handling, includeDeleted=true for templates, cold-collection hook reserved, removed duplicate change-stream section.
- 2025-12-26: Locked in policy values (hash caps, batch sizes, QPS limits, lag thresholds, timeouts, retries, buffers) across module docs for executability.
- 2025-12-27: Multi-tenant support landed in code (tenant required on Service/HTTP/replication/watch with DefaultTenant fallback); design docs now need alignment and tests must cover tenant isolation/validation.
