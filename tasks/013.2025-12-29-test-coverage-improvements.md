# Test Coverage Improvements

Date: 2025-12-29
Status: Completed
Scope: Improve unit test coverage for critical components (Trigger Engine, CSP, Services).

## Objectives

- Fix 0% coverage in `internal/trigger/engine/factory.go`.
- Improve coverage in `internal/csp/server.go` (error handling).
- Improve coverage in `internal/services` (startup/shutdown error handling).

## Changes

### Trigger Engine
- Added `WithStreamName` test case in `internal/trigger/engine/factory_test.go`.

### CSP
- Added `TestServerHandleWatch_WatchError` and `TestServerHandleWatch_ContextCancel` in `internal/csp/server_test.go`.
- Added `errorStorage` and `blockingStorage` mocks.

### Services
- Added `TestManager_Start_RealtimeRetry` in `internal/services/manager_start_test.go` to test retry logic.
- Added `TestManager_Shutdown_Timeout` in `internal/services/manager_shutdown_test.go` to test shutdown timeout.
- Added `MockQueryService` to support realtime server mocking.

## Results

- `internal/trigger/engine` coverage increased to 95.4%.
- `internal/csp` coverage increased to 95.0%.
- `internal/services` coverage improved (added error path tests).
