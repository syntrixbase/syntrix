# Storage Architecture Implementation Plan

Date: 2025-12-25
Status: Completed
Scope: Storage Factory, Configuration, Manager Refactoring

## 1. Objective

Implement the configuration-driven storage architecture defined in `docs/design/server/002_storage/`. This involves creating a `Storage Factory` that reads the configuration, initializes the appropriate `Providers` (backends), and wires them into `Routers` and `RoutedStores`.

## 2. Implementation Steps

### Phase 1: Configuration & Interfaces

- [x] **Update Config Structure**: Modify `internal/config/config.go`.
    - Define `BackendConfig` struct (Type, MongoConfig, etc.).
    - Update `StorageConfig` to include `Backends map[string]BackendConfig`.
    - Update `StorageConfig` to include `Document`, `User`, `Revocation` fields of type `RoutingConfig`.
    - `RoutingConfig` should have `Strategy` (string) and `Backends` (map[OpKind]string or similar, e.g., `Primary`, `Replica`).
- [x] **Define Factory Interface**: Create `internal/storage/factory.go` (or package `factory`).
    - Interface `StorageFactory` with methods: `Document() DocumentStore`, `User() UserStore`, `Revocation() TokenRevocationStore`, `Close() error`.

**Verification**:
- `go test ./internal/config/...` passes.
- Verify `config.yaml` parsing with new structure using a small test case.

### Phase 2: Storage Factory Implementation

- [x] **Implement Factory Logic**: Create `internal/storage/factory_impl.go`.
    - **Provider Registry**: Maintain a `map[string]Provider` to ensure we only initialize each named backend once (connection reuse).
    - **Initialization Loop**: Iterate through configured backends, initialize `MongoProvider` (etc.), and store in registry.
    - **Router Assembly**: For each store type (Doc/User/Rev), look up the strategy.
        - If `single`: Get the provider for the "primary" backend, create `SingleRouter`.
        - If `read_write_split`: Get providers for "primary" and "replica", create `SplitRouter` (need to implement `SplitRouter` types if not exists).
    - **Store Creation**: Wrap routers in `RoutedStore`.
- [x] **Lifecycle**: `Close()` method must iterate over the Provider Registry and close all unique providers.

**Verification**:
- Create unit tests for `Factory`:
    - Mock providers to avoid real DB connections.
    - Test "single" strategy: verify correct provider is selected.
    - Test connection reuse: configure two stores to use same backend, verify provider initialized once.
    - Test `Close()`: verify all providers are closed.

### Phase 3: Manager Refactoring

- [x] **Update Manager Struct**: Replace individual `docProvider`/`authProvider` fields with a single `StorageFactory` or just the `Stores` + `Closer`.
- [x] **Update Manager Init**: Change `initStorage` to use `storage.NewFactory(cfg)`.
- [x] **Update Manager Shutdown**: Ensure `m.storageFactory.Close()` is called.

**Verification**:
- `go test ./internal/services/...` passes.
- Verify `Manager` initializes successfully with the new config.

### Phase 4: Cleanup & Testing

- [x] **Remove Old Wiring**: Delete `router_factory.go` (the temporary one we made) and old manual wiring code.
- [x] **Unit Tests**: Test the Factory with different configurations (mocking the actual providers if possible, or just testing the logic).
- [x] **Integration Tests**: Verify the full stack works with the new wiring.

**Verification**:
- Full suite `go test ./...` passes.
- Manual run of `syntrix` binary with updated `config.local.yml` to ensure startup.


## 3. Verification

- `go test ./internal/storage/...` should pass.
- `go test ./internal/services/...` should pass.
- The application should start successfully with the new configuration structure.
