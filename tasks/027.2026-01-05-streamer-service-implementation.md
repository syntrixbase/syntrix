# Task 027: Streamer Service Implementation (Replace CSP)

**Date**: 2026-01-05
**Status**: In Progress (Phase 1-6 Complete)
**Scope**: internal/streamer, internal/csp, internal/api/realtime, internal/services, api/proto
**Design Doc**: [docs/design/server/streamer](../docs/design/server/streamer/)

---

## Progress Summary

### Completed ‚úÖ
- **Phase 1**: Proto definitions (`api/proto/streamer/streamer.proto`, generated Go code)
- **Phase 2**: Subscription Manager (`internal/streamer/internal/manager/`)
- **Phase 3**: CEL Matching Engine (`internal/streamer/internal/cel/`)
- **Phase 4**: Event Ingestion (`internal/streamer/internal/ingest/`)
- **Phase 5**: gRPC Server (`internal/streamer/service.go`)
- **Phase 6**: Streamer Client (`internal/streamer/client.go`)
- **Puller Integration**: `internal/streamer/puller_integration.go`

### Pending üîÑ
- **Phase 7**: Refactor Realtime Server (requires detailed design)
- **Phase 8**: Cleanup CSP and wire-up in service manager

---

## Implementation Notes (2026-01-05)

### Files Created

**Proto & Generated Code**:
- `api/proto/streamer/streamer.proto` - gRPC service definition
- `api/streamer/v1/streamer.pb.go` - Generated message types
- `api/streamer/v1/streamer_grpc.pb.go` - Generated gRPC service

**Core Package** (`internal/streamer/`):
- `interface.go` - Service and Client interfaces
- `service.go` - StreamerService implementation (gRPC server + ProcessEvent)
- `service_test.go` - 8 test cases for service
- `client.go` - StreamerClient for Gateway consumption
- `puller_integration.go` - Puller event consumption

**Internal Packages**:
- `internal/manager/manager.go` - SubscriptionManager with O(1) exact match + CEL
- `internal/manager/subscriber.go` - Subscriber and GatewaySubscriptions types
- `internal/manager/manager_test.go` - 11 test cases
- `internal/cel/cel.go` - CEL Compiler with Filter support
- `internal/cel/cel_test.go` - 21 test cases
- `internal/ingest/ingest.go` - Transform puller.ChangeEvent ‚Üí InternalEvent
- `internal/ingest/ingest_test.go` - 9 test cases

### Design Deviations ‚ö†Ô∏è

| Aspect | Design Doc | Implementation | Notes |
|--------|------------|----------------|-------|
| Filter format | Structured `Filter` message with field/op/value | CEL string expression | Simpler, more flexible |
| Directory structure | `internal/core/`, `internal/grpc/`, `internal/client/` | Flat: `service.go`, `client.go` | Simplified |
| Soft Delete transform | Required in Ingest | **Not implemented** | TODO |
| Recreation handling | Required in Ingest | **Not implemented** | TODO |
| Subscription TTL | Auto-expire on Gateway crash | Heartbeat only, no TTL | TODO if needed |
| Backpressure | Buffer with limit, then drop | Drop immediately if full | Simpler |
| Micro-batching | Optional <1ms batching | **Not implemented** | TODO if perf needed |

### Test Results
- All 49 new tests pass
- All existing project tests pass
- No coverage regression

---

## 1. Objective

Replace `internal/csp` with a new Streamer service that provides:
- **Centralized fan-out**: O(1) DB load via single Puller stream
- **Centralized CEL matching**: Match once, route to many Gateways
- **Clean proto contracts**: No `storage.Event` dependency in realtime layer

---

## 2. Architecture

### Before (CSP)
```
Realtime Server ‚îÄ‚îÄ> engine.WatchCollection() ‚îÄ‚îÄ> csp.Watch() ‚îÄ‚îÄ> MongoDB
       ‚îÇ
       ‚îî‚îÄ‚îÄ Hub does local CEL matching per client
```
**Problems**: Connection explosion, duplicate matching, tight coupling

### After (Streamer)
```
MongoDB ‚îÄ‚îÄ> Puller ‚îÄ‚îÄgRPC‚îÄ‚îÄ> Streamer ‚îÄ‚îÄgRPC‚îÄ‚îÄ> Realtime Server (Gateway)
                                ‚îÇ                       ‚îÇ
                                ‚îî‚îÄ‚îÄ CEL matching here   ‚îî‚îÄ‚îÄ Pre-matched events
```

---

## 3. Key Decisions

| # | Decision | Choice | Rationale |
|---|----------|--------|-----------|
| D1 | Primary consumer | `internal/api/realtime/` | Realtime Server is actual CSP consumer, not Engine |
| D2 | CEL location | `internal/streamer/internal/cel/` | Centralized matching in Streamer |
| D3 | Event types | Define `StreamerEvent` in proto | No dependency on `internal/storage` |
| D4 | Migration | Direct cutover | CSP is internal, no external consumers |
| D5 | Puller dependency | Accept `storage.StoredDoc` in Puller | Streamer converts to proto at Gateway boundary |
| D6 | CEL data format | Decode JSON ‚Üí map in Streamer | `puller.ChangeEvent.FullDocument.Data` already a map |
| D7 | Operation type mapping | `INSERT‚Üícreate`, `UPDATE‚Üíupdate`, `DELETE‚Üídelete` | Map proto enum to client JSON |

---

## 4. Event Type Flow

```
puller.ChangeEvent (Go struct, contains storage.StoredDoc)
       ‚Üì Streamer Ingest
InternalEvent {
    StreamerEvent  *pb.StreamerEvent  // For wire
    DocMap         map[string]interface{}  // For CEL
}
       ‚Üì CEL Match & Send
StreamerEvent (proto) ‚Üí Gateway
       ‚Üì Gateway converts
Client JSON: {"type": "create", ...}
```

---

## 5. Implementation Phases

### Phase 1: Proto Definitions (3 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 1.1 | Create streamer.proto | `api/proto/streamer/streamer.proto` |
| 1.2 | Generate Go code | `api/streamer/v1/*.go`, Makefile |
| 1.3 | Create interface.go | `internal/streamer/interface.go` |

<details>
<summary>Proto Schema</summary>

```protobuf
service StreamerService {
  rpc Stream(stream GatewayMessage) returns (stream StreamerMessage);
}

message StreamerEvent {
  string event_id = 1;
  string tenant = 2;
  string collection = 3;
  string document_id = 4;
  OperationType operation = 5;
  bytes document_data = 6;
  int64 timestamp = 7;
}

enum OperationType {
  INSERT = 0;
  UPDATE = 1;
  DELETE = 2;
}

message GatewayMessage {
  oneof payload {
    SubscribeRequest subscribe = 1;
    UnsubscribeRequest unsubscribe = 2;
    Heartbeat heartbeat = 3;
  }
}

message StreamerMessage {
  oneof payload {
    EventDelivery delivery = 1;
    HeartbeatAck heartbeat_ack = 2;
  }
}
```
</details>

---

### Phase 2: Subscription Manager (3 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 2.1 | Create SubscriptionManager | `internal/streamer/internal/manager/manager.go` |
| 2.2 | Define Subscriber types | `internal/streamer/internal/manager/subscriber.go` |
| 2.3 | Unit tests | `internal/streamer/internal/manager/manager_test.go` |

<details>
<summary>Data Structure</summary>

```go
type SubscriptionManager struct {
    exactMatches map[string]map[string][]*Subscriber  // Collection ‚Üí DocID ‚Üí Subs
    expressions  map[string][]*ExpressionSubscriber   // Collection ‚Üí CEL subs
    gatewaySubs  map[string]map[string]struct{}       // GatewayID ‚Üí SubIDs
    mu           sync.RWMutex
}
```
</details>

---

### Phase 3: CEL Matching Engine (4 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 3.1 | Extract CEL logic | `internal/streamer/internal/cel/cel.go` |
| 3.2 | Fast path (exact match) | O(1) lookup by Collection+DocID |
| 3.3 | Slow path (CEL expressions) | Iterate and evaluate |
| 3.4 | Benchmarks | Target: 100k+ subs, <10ms p99 |

---

### Phase 4: Event Ingestion (3 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 4.1 | Create ingest service | `internal/streamer/internal/ingest/ingest.go` |
| 4.2 | Event transformation | `puller.ChangeEvent` ‚Üí `InternalEvent` |
| 4.3 | Progress tracking | Save/resume progress marker |

**Transform logic (Decision D5, D6)**:
```go
func transform(e *puller.ChangeEvent) *InternalEvent {
    return &InternalEvent{
        StreamerEvent: &pb.StreamerEvent{
            EventId:      e.EventID,
            Tenant:       e.TenantID,
            Collection:   e.MgoColl,
            DocumentId:   e.MgoDocID,
            Operation:    mapOperation(e.OpType),
            DocumentData: marshal(e.FullDocument.Data),
            Timestamp:    e.Timestamp,
        },
        DocMap: e.FullDocument.Data,  // Already map[string]interface{}
    }
}
```

---

### Phase 5: gRPC Transport (3 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 5.1 | gRPC server | `internal/streamer/internal/grpc/server.go` |
| 5.2 | gRPC client | `internal/streamer/internal/client/client.go` |
| 5.3 | Public constructors | `internal/streamer/service.go`, `client.go` |

---

### Phase 6: Service Core (2 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 6.1 | Event loop | `internal/streamer/internal/core/service.go` |
| 6.2 | Graceful shutdown | Close streams, save progress |

---

### Phase 7: Refactor Realtime Server ‚ö†Ô∏è CRITICAL (5 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 7.1 | Update server.go | Add `streamerClient`, new `StartBackgroundTasks()` |
| 7.2 | Update hub.go | Remove CEL, handle `StreamerEvent`, add type mapping |
| 7.3 | Update client.go | Sync subscriptions with Streamer |
| 7.4 | Delete cel.go | Moved to streamer |
| 7.5 | Update constructor | Add `streamerClient` param |

**Type mapping (Decision D7)**:
```go
func operationToEventType(op pb.OperationType) string {
    switch op {
    case pb.OperationType_INSERT: return "create"
    case pb.OperationType_UPDATE: return "update"
    case pb.OperationType_DELETE: return "delete"
    }
    return ""
}
```

---

### Phase 8: Service Manager & Cleanup (8 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 8.1 | Update initStandalone() | Create Streamer service |
| 8.2 | Update initDistributed() | Create Streamer client |
| 8.3 | Update initAPIServer() | Pass Streamer to Realtime |
| 8.4 | Add Streamer methods | `createStreamerService()`, `createStreamerClient()` |
| 8.5 | Update Manager struct | Add Streamer fields, remove RunCSP |
| 8.6 | Delete internal/csp/ | All files |
| 8.7 | Update internal/engine/ | Remove WatchCollection, CSP dependency |
| 8.8 | Update config | Remove CSP, add Streamer section |

---

### Phase 9: Testing (4 tasks)

| Task | Description | Files |
|------|-------------|-------|
| 9.1 | Unit tests for streamer | All `*_test.go` in new packages |
| 9.2 | Integration test | `tests/integration/streamer_test.go` |
| 9.3 | Update realtime tests | Replace `storage.Event` with `StreamerEvent` |
| 9.4 | Run coverage | `make coverage`, no regression |

---

## 6. File Changes Summary

### New Files (11)
```
api/proto/streamer/streamer.proto
api/streamer/v1/*.go
internal/streamer/interface.go
internal/streamer/service.go
internal/streamer/client.go
internal/streamer/internal/manager/*
internal/streamer/internal/cel/*
internal/streamer/internal/ingest/*
internal/streamer/internal/core/*
internal/streamer/internal/grpc/*
internal/streamer/internal/client/*
```

### Modified Files (9)
```
internal/services/manager_init.go    ‚Üí Replace CSP with Streamer init
internal/services/manager.go         ‚Üí Add Streamer fields, remove RunCSP
internal/api/realtime/server.go      ‚Üí Use Streamer client
internal/api/realtime/hub.go         ‚Üí Remove CEL, use StreamerEvent
internal/api/realtime/client.go      ‚Üí Sync subscriptions
internal/engine/interface.go         ‚Üí Remove WatchCollection
internal/engine/internal/core/engine.go ‚Üí Remove cspService
internal/config/config.go            ‚Üí Remove CSP, add Streamer
config/config.yml                    ‚Üí Remove CSP, add Streamer
```

### Deleted Files (7)
```
internal/csp/interface.go
internal/csp/csp_service.go
internal/csp/csp_client.go
internal/csp/server.go
internal/csp/*_test.go
internal/api/realtime/cel.go
```

---

## 7. Success Criteria

| # | Criterion | Metric |
|---|-----------|--------|
| S1 | Throughput | 10k+ events/sec per node |
| S2 | Latency | <10ms p99 (ingest ‚Üí match ‚Üí send) |
| S3 | Tests | All realtime tests pass |
| S4 | Coverage | No regression from `make coverage` |
| S5 | Cleanup | `internal/csp/` deleted |
| S6 | Decoupling | No `storage.Event` in realtime layer |

---

## 8. Dependencies

| Dependency | Status |
|------------|--------|
| Puller Service | ‚úÖ Implemented ([Task 022](022.2026-01-01-trigger-puller-integration.md)) |

---

## 9. Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| CEL performance | Benchmark in Phase 3.4; pre-filter if needed |
| Circular dependency | Keep `streamer.Service` interface minimal |
| Test breakage | Update tests in Phase 9.3 before cleanup |
| Event format mismatch | Clear proto definitions in Phase 1 |

---

## 10. Dry Run Verification ‚úÖ

**Date**: 2026-01-05

| Issue | Severity | Resolution |
|-------|----------|------------|
| Puller uses `storage.StoredDoc` | üü° Medium | Accept; convert at Gateway boundary (D5) |
| 3 event types in system | ‚úÖ Clarified | Clear mapping defined |
| CEL needs decoded map | üü° Medium | `FullDocument.Data` already a map (D6) |
| Operation type enum vs string | üü° Medium | Mapping function in Phase 7.2 (D7) |
| 14 test files to update | üü¢ Low | ~300 lines, manageable |

**Verdict**: ‚úÖ READY TO PROCEED
