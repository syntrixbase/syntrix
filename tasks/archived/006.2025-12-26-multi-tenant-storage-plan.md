# Multi-Tenant Storage Implementation Plan

Date: 2025-12-26
Status: Completed
Scope: Storage layer multi-tenancy (tenant-aware IDs, routing, indexes, Mongo implementation, tests)
Reference Design: docs/design/server/storage/005.multi-tenant.md

## Objectives

- Enforce tenant-aware IDs and routing to prevent cross-tenant data access.
- Add tenant-scoped indexing (collection_hash) and Mongo filters.
- Provide per-tenant backend binding with fail-closed defaults.
- Deliver unit tests for isolation and index guarantees.

## Plan

1) Update config structures to add `tenants` binding map and enforce default tenant presence.
2) Refactor storage interfaces to require `tenant string`; introduce tenant-aware ID helpers; deprecate path-only helpers.
3) Mongo implementation: add `tenant_id` field handling, tenant-aware `_id` generation (prefix format `tenant_id:hash(...)`), `collection_hash` population, filters, watch guards (using prefix match), and indexes.
4) Routing/factory: lookup tenant→backend before op-kind routing; error on missing/empty tenant; keep read/write split per backend.
5) Tests: isolation across tenants for CRUD/query/watch; per-tenant uniqueness for users/revocations; index existence checks (`collection_hash`, TTL); tenant-aware `_id` difference for same path across tenants.
6) Docs: update design to reflect tenant-aware ID strategy and routing requirements (tracked in 005.multi-tenant.md).

### Suggested Order / Milestones

- M1: Interfaces + helpers become tenant-aware; add new ID generators; deprecate path-only helpers.
- M2: Mongo documents add `tenant_id`, tenant-aware `_id`, filters, `(tenant_id, collection_hash)` index; EnsureIndexes updated; watch adds tenant guard.
- M3: Routing/Factory enforce tenant mandatory, tenant→backend binding (default required), empty/missing errors; config structs gain `storage.tenants` with validation.
- M4: User/Revocation models gain `tenant_id`, tenant-aware `_id`, per-tenant unique `(tenant_id, username)`; revocation per-tenant TTL/index; migrate call sites.
- M5: Migration/backfill guidance (dev/test data): add `tenant_id`/`collection_hash` and rerun EnsureIndexes.
- M6: Tests: cross-tenant isolation (CRUD/query/watch), empty-tenant fail, index presence, tenant-aware `_id` difference, user/revocation per-tenant uniqueness.

## Deliverables

- Code changes in storage interfaces, Mongo stores, routers/factory.
- Config updates with tenant bindings.
- Unit tests covering isolation, indexes, and ID behavior.
- Updated design doc reflecting final implementation details.

## Risks & Mitigations

- Risk: Caller forgets tenant; Mitigation: storage layer fails closed on empty tenant, add middleware to inject/validate default.
- Risk: Legacy helpers still path-based; Mitigation: deprecate and migrate all call sites.
- Risk: Index drift in existing envs; Mitigation: EnsureIndexes migration step and tests to assert presence.

## Open Issues / Actions

- Align design vs implementation: refactor code to tenant-aware IDs and `tenant` parameters on storage interfaces; remove path-only helpers usage.
- Update config example to include `storage.tenants` default binding and dedicated bindings; ensure validation for missing default.
- Watch behavior: implement server-side regex filter on `documentKey._id` for delete events.
- TODO: Define Read/Write split strategy for dedicated tenants.
- Backfill/EnsureIndexes: define handling for existing dev/test data (add `tenant_id`, `collection_hash`); EnsureIndexes to enforce required indexes.
- Migration list: inventory and replace all uses of `CalculateID`/`NewDocument` to tenant-aware helpers.
- Risk/rollback: decide whether a temporary compatibility layer or feature flag is needed during helper/ID migration; add if necessary.
