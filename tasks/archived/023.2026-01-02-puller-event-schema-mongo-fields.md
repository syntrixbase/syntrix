# Puller Event Schema: Mongo Field Renames and FullDocument Contract

**Date:** January 2, 2026
**Status:** Completed
**Scope:** `internal/puller`, `api/puller/v1`, `docs/design`
**Depends On:** [020.2025-12-31-puller-design-alignment.md](020.2025-12-31-puller-design-alignment.md)

## Context

Puller currently emits `NormalizedEvent` with `collection` and `documentId` names that read as Syntrix-level identifiers, while they are actually Mongo change-stream namespace/documentKey values. `fullDocument` is a loose `map[string]any`, and tenant extraction is heuristic. We must:
- Rename `NormalizedEvent` to `ChangeEvent` and introduce `PullerEvent` wrapper that carries both `ChangeEvent` and `Progress` (so progress is not embedded in the event payload).
- Move `ProgressMarker` out of gRPC into core (business layer) and keep gRPC as transport only.
- Encode Mongo provenance in field names via explicit prefixes and shorter JSON keys.
- Enforce `fullDocument` to be the storage `Document` shape (alias in `storage` package; the collection being watched stores these documents).
- Require `UpdateLookup` so update events always carry the full document; missing payloads must be rejected.
- Make tenant derive solely from `fullDocument.TenantID`.

## Goals

- Rename `NormalizedEvent` -> `ChangeEvent` with Mongo-prefixed short field names; introduce `PullerEvent` (wraps `ChangeEvent` + `Progress`).
- Enforce `FullDocument` as `*storage.Document`; reject events without it when required.
- Require `UpdateLookup` for update operations; treat missing `fullDocument` as errors.
- Update protocol/serialization paths (gRPC, buffer, public interfaces/aliases) to match the new schema and wrapper.
- Document the `fullDocument` contract in design/README.

## Deliverables

- Updated type definitions in `internal/puller/events/types.go` (rename `NormalizedEvent` to `ChangeEvent`, add `PullerEvent` wrapper with Progress) and downstream usages (normalizer, buffer, gRPC server/client, public aliases in `internal/puller/interface.go`) to use `*storage.Document` and renamed Mongo fields with short JSON keys.
- Validation: update normalization to source tenant only from `FullDocument.TenantID`; reject update events lacking `fullDocument` (no `UpdateLookup`).
- Updated API schema (proto/Go bindings) to reflect new JSON/proto field names and the PullerEvent wrapper.
- Docs: design/README add `fullDocument` semantics (must be `storage.Document` JSON shape; update requires `UpdateLookup`).
- Tests adjusted/added to cover new schema, tenant extraction rule, missing `fullDocument` error for updates, and progress propagation via wrapper.

## Plan

## Steps

1) Rename event schema (code)
- In `internal/puller/events/types.go`: rename `NormalizedEvent` to `ChangeEvent`; add `PullerEvent` wrapper `{Change *ChangeEvent, Progress string}`; fields to `mgoColl`, `mgoDocId`, `opType`, `fullDoc`, `updateDesc`; `fullDoc` type `*storage.Document`; adjust JSON tags to short names.
- Update tests in `internal/puller/events/types_test.go` for `ChangeEvent` JSON and wrapper serialization.
- Update public aliases in `internal/puller/interface.go` (Service Subscribe return type, exported type aliases) to use `PullerEvent`/`ChangeEvent`.

2) Enforce normalization rules
- In `internal/puller/internal/normalizer/normalizer.go`: decode `raw.FullDocument` into `storage.Document`; tenant only from `fullDoc.TenantID`; error if empty/missing; require `fullDoc` for update/replace (UpdateLookup), else return error; map to new field names.
- Adjust normalizer unit tests to cover tenant-only-from-fullDoc and missing fullDoc error on update.

3) Protocol schema
- Update `api/proto/puller.proto` field names to short versions (`mgoColl`, `mgoDocId`, `opType`, `fullDoc`, `updateDesc`) and add `progress` at the wrapper level (e.g., a `PullerEvent` message containing `change_event` + `progress`); regenerate `api/puller/v1/puller.pb.go`.
- Track ripple to any generated SDKs (e.g., TS client) if applicable.

4) gRPC conversions
- Server: `internal/puller/internal/grpc/server.go` marshal `storage.Document`, use new proto fields, and populate `progress` in the wrapper.
- Client: `internal/puller/internal/client/client.go` unmarshal `fullDoc` bytes into `storage.Document`, populate new fields, and expose `progress` via `PullerEvent`; handle errors.
- Update related tests to match new names/types/wrapper; ensure `DecodeProgressMarker` call sites consume the core-owned type.

5) Buffer and iteration
- `internal/puller/internal/buffer/buffer.go`: ensure JSON marshal/unmarshal works with `PullerEvent` (wrapping `ChangeEvent`), `*storage.Document`, and renamed fields; adjust iterators if needed.
- Update buffer-related tests accordingly; update any iterator types/aliases consuming `NormalizedEvent`.

6) Documentation
- Add/modify design/README section: `fullDoc` must be `storage.Document` JSON shape, update requires `UpdateLookup`, tenant only from `fullDoc.TenantID`, Mongo provenance of `mgoColl/mgoDocId`.

7) Progress handling & exposure
- Move `ProgressMarker` from gRPC to core (or a core subpackage) as the business-owned type; gRPC only transports encoded progress; update all call sites to import from core.
- `Service.Subscribe` returns `PullerEvent` (or channel thereof) carrying `ChangeEvent` + `Progress`; existing Metadata (`clusterTime`, `txnNumber`, `timestamp`, `backend`) stay on `ChangeEvent`.
- Run unit tests + `make coverage` per AGENTS.md; ensure new/updated tests pass.

## Risks / Notes

- Proto/regeneration may ripple to SDKs; confirm no external consumers depend on old field names before release.
- Enforcing `UpdateLookup` may require configuration checks to fail fast; ensure logging is clear.
