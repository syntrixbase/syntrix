# Unit Test Suite Optimization

Date: December 27, 2025
Status: Completed
Scope: Reduce redundant unit tests, keep critical coverage, and improve test run efficiency without losing regression protection.

## Goals
- Lower duplication across packages while preserving intent and coverage depth.
- Shorten average unit test runtime and stabilize flakiness budget.
- Establish a repeatable process for test inventory, deduplication, and maintenance.

## Current Observations
- Suites have overlapping scenarios (same behaviors covered in multiple layers) which slow runs and complicate maintenance.
- Some tests assert broad integration-like flows in unit suites, increasing coupling and brittleness.
- Parallelism and fixture reuse are inconsistent across packages, inflating setup costs.

## Why / How
- Why: Faster, sharper tests reduce feedback time and lower maintenance overhead.
- How: Inventory coverage, collapse duplicate cases, focus unit tests on local behavior, move cross-component flows to higher-level suites, and standardize fixtures/mocks.

## Proposed Approach
- Inventory & Tagging: Catalog unit tests by behavior/feature and mark overlaps; map to requirements to avoid accidental coverage loss.
- Boundary Coverage First: Keep edge cases for security/auth, tenant isolation, data integrity, concurrency/timeouts, and failure paths; use table-driven valid/invalid/empty/extreme inputs; ensure at least one black-box guard remains when deduping.
- Deduplicate & Merge: Consolidate semantically identical cases; parameterize where variation is minor; drop redundant assertions already guarded by higher-level tests.
- Fixture Hygiene: Extract shared builders/mocks, ensure deterministic seeds, and remove hidden global state leaks.
- Scope Discipline: Keep unit tests local; push cross-component paths to integration/black-box suites; forbid deep internal plumbing in unit layers.
- Performance: Enable table-driven parallel tests where safe; cache expensive fixtures; trim timeouts/sleeps; prefer fakes over real I/O.
- Quality Gates: Define package-level coverage targets tied to risk; add lint/check to flag duplicate test names and overly broad assertions.

### Planned Adds: identity/authz rule engine
- Coverage of empty/invalid rules: Evaluate returns false when rules missing; LoadRules/UpdateRules fail fast on bad YAML or CEL without polluting existing rules.
- Path matching: verify {var=**} deep capture, parent + child vars merge, deterministic ordering (concrete vs wildcard vs length vs alpha), and unmatched/empty allow paths return false.
- Action handling: aliases already covered; add mixed spacing/case robustness and unknown action returns false without panic.
- CEL condition errors: missing vars or compile/runtime errors propagate; existingRes nil is safe; multiple allow clauses continue after failures.
- Custom functions: exists/get with ErrNotFound vs other errors, non-string args error, database prefix stripping to internal path, get strips protected fields.
- Resource data edge cases: wrong types/missing fields deny or error per current behavior; confirm multi-allow fallthrough.

### Integration Suite Redundancy (findings & proposals)
- API vs Microservices: both create/update/read via API; microservices adds gateway→internal query verification. Proposal: keep microservices for cross-path check, slim API test to smoke CRUD or share helpers to avoid duplicated full flows.
- API CRUD vs Document System Fields: overlapping create/update/patch flows. Proposal: keep detailed system-field assertions in document_fields; reduce API test to minimal happy path, or share creation helper to cut duplicate setup/sleeps.
- Replication full vs delete: both spin SSE + push/pull; differ only on action (create vs delete). Proposal: merge into table-driven cases sharing SSE setup and push/pull helpers; avoid duplicate service bring-up.
- Realtime WS/SSE vs Multitenant realtime: both repeat WS/SSE handshake/subscription/event receipt; multitenant focuses on tenant isolation. Proposal: extract WS/SSE helper; multitenant uses helper to assert cross-tenant isolation without redoing full flow.
- General: multiple tests each start full service env; consider shared fixtures or batched table-driven subtests to reduce startup overhead.

## Candidate Targets to Review
- HTTP/API handlers vs service-layer tests covering the same validation logic.
- Query layer tests that reassert storage behaviors already covered in storage unit suites.
- Storage provider tests that duplicate core model validation already checked in model/unit tests.
- Flaky time-based tests relying on sleeps instead of deterministic clocks.

## Acceptance Criteria
- Documented inventory of unit suites with noted duplicates and removals, reviewed by owners.
- Measurable runtime reduction (target ≥15%) without coverage drop on critical paths.
- No loss of branch/behavior coverage for auth, tenancy, and data integrity rules.
- CI includes a guardrail to catch duplicate test names and long-running cases.

## Risks / Mitigations
- Risk: Removing tests could hide gaps. Mitigation: Require owner review and map removals to alternative coverage.
- Risk: Over-parallelization might introduce flakiness. Mitigation: Parallelize only pure/test-isolated cases; add race detection where helpful.

## Project Directory Inventory
(Generated on 2025-12-27 to assist with Test Inventory)

### Core Components (`internal/`)
- **api/**: HTTP API handlers and middleware.
- **config/**: Configuration loading and validation logic.
- **csp/**: Content Security Policy implementation.
- **identity/**: Authentication, authorization (RBAC/ABAC), and identity management.
- **query/**: Query parsing and execution engine.
- **services/**: Service lifecycle management and orchestration.
- **storage/**: Storage backend implementations and interfaces.
- **trigger/**: Event trigger system and rule processing.

### Public Packages (`pkg/`)
- **model/**: Core data models and validation logic.
- **syntrix/**: Main library entry points and shared types.

### Testing (`tests/`)
- **integration/**: Black-box integration tests covering API, replication, and complex flows.

### Entry Points (`cmd/`)
- **syntrix/**: Main server application.
- **syntrix-cli/**: Command-line interface tool.

### SDKs (`sdk/`)
- **syntrix-client-ts/**: TypeScript client SDK.

## Detailed Analysis & Optimization Log

### 1. `internal/api/rest`
- **Status**: Completed
- **Files**: `handler_document_test.go`, `handler_admin_test.go`, `handler_auth_test.go`, etc.
- **Initial Observations**:
    - `handler_document_test.go` currently uses separate test functions for each HTTP method (`TestHandleGetDocument`, `TestHandleCreateDocument`, etc.).
    - There is repetitive setup of `MockQueryService` and `createTestServer` in each test.
- **Optimization Plan**:
    - Consolidate individual handler tests into table-driven tests where appropriate (e.g., `TestDocumentHandlers`).
    - Centralize mock setup to reduce boilerplate.
    - Verify coverage of edge cases (NotFound, Invalid JSON, Server Error).
- **Progress**:
    - [x] `handler_document_test.go` replaced with `handler_document_table_test.go`.
    - [x] `handler_query_test.go` replaced with `handler_query_table_test.go`.
    - [x] `handler_admin_test.go` refactored to use shared mocks.
- **Status**: Completed

### 2. `internal/api/realtime`
- **Status**: Completed
- **Files**: `client_message_test.go`, `hub_test.go`, `server_test.go`
- **Initial Observations**:
    - `client_message_test.go` had separate tests for Auth, Subscribe, Unsubscribe.
    - `hub_test.go` had separate tests for Broadcast, Filter, Tenant Isolation.
    - `server_test.go` had separate tests for WS and SSE handling.
- **Optimization Plan**:
    - Convert `client_message_test.go` to `client_message_table_test.go`.
    - Convert `hub_test.go` to `hub_table_test.go`.
    - Convert `server_test.go` to `server_table_test.go`.
- **Progress**:
    - [x] `client_message_test.go` replaced with `client_message_table_test.go`.
    - [x] `hub_test.go` replaced with `hub_table_test.go`.
    - [x] `server_test.go` replaced with `server_table_test.go`.

### 3. `internal/engine`
- **Status**: Completed
- **Files**: `engine_test.go`
- **Initial Observations**:
    - `engine_test.go` contained many individual tests for CRUD operations (`GetDocument`, `CreateDocument`, `ReplaceDocument`, `PatchDocument`, `Pull`, `Push`).
    - High duplication of mock setup and assertions.
- **Optimization Plan**:
    - Consolidate all CRUD tests into `engine_table_test.go`.
    - Use table-driven tests for each operation type.
- **Progress**:
    - [x] `engine_test.go` replaced with `engine_table_test.go`.
    - [x] `client_test.go` updated with comprehensive error path coverage (network errors, bad status, decode errors) for all methods.
- **Status**: Completed

### 4. `internal/storage`
- **Status**: Completed
- **Files**: `helpers_test.go`
- **Initial Observations**:
    - `helpers_test.go` contained simple tests for helper functions.
- **Optimization Plan**:
    - Convert `helpers_test.go` to `helpers_table_test.go`.
- **Progress**:
    - [x] `helpers_test.go` replaced with `helpers_table_test.go`.


### 5. `internal/identity`
- **Status**: Completed
- **Files**: `internal/authn/service_test.go`
- **Initial Observations**:
    - `service_test.go` contained individual tests for SignUp and SignIn scenarios.
    - `internal/identity/internal/authn` had low coverage (< 70%).
- **Optimization Plan**:
    - Convert `service_test.go` to `service_table_test.go`.
    - Add missing test cases for `Refresh`, `Logout`, `Middleware`, `ListUsers`, and `UpdateUser` to improve coverage.
- **Progress**:
    - [x] `service_test.go` replaced with `service_table_test.go`.
    - [x] Added table-driven tests for `Refresh`, `Logout`, `Middleware`, `MiddlewareOptional`, `ListUsers`, and `UpdateUser`.
    - [x] Increased `internal/identity/internal/authn` coverage from 52.0% to 81.1%.


## Status Log
- 2025-12-27: Task created; status set to In Progress; outlined objectives and guardrails for deduplication.
- 2025-12-27: Completed optimization plan.
    - Enhanced `internal/identity/internal/authz` unit tests with `engine_extended_test.go` covering edge cases and CEL validation.
    - Refactored `tests/integration/api_test.go` and `tests/integration/document_fields_test.go` to use shared helpers in `env_helper.go`.
    - Merged `tests/integration/microservices_test.go` into `api_test.go` and deleted the redundant file.
    - Merged `tests/integration/replication_delete_test.go` into `replication_test.go` and deleted the redundant file.
    - Extracted WebSocket connection and authentication logic into `env_helper.go` and refactored `realtime_test.go` and `multitenant_test.go` to use it.
    - Reviewed `internal/services` and replaced flaky `time.Sleep` calls with `assert.Eventually` in `manager_start_test.go`.
    - Verified all refactored tests pass.
- 2025-12-27: Scanned project structure and added "Project Directory Inventory" to the document to assist with test inventory.
- 2025-12-27: Optimized `internal/api/rest` unit tests.
    - Refactored `handler_document_test.go` and `handler_query_test.go` to table-driven tests.
    - Refactored `handler_admin_test.go` to use shared `MockAuthService` and `MockAuthzService` from `mock_service_test.go`, removing redundant mock definitions.
    - Verified all tests in `internal/api/rest` pass.
- 2025-12-27: Expanded `internal/identity/internal/authn` coverage.
    - Identified low coverage (52.0%) in `authn` package.
    - Implemented table-driven tests for `Refresh`, `Logout`, `Middleware`, `ListUsers`, and `UpdateUser`.
    - Achieved 81.1% coverage for `internal/identity/internal/authn`.
    - Marked task as Completed.
- 2025-12-28: Improved `internal/engine` coverage.
    - Added comprehensive error path tests to `client_test.go` covering network failures, invalid URLs, and unexpected status codes for all client methods.
- 2025-12-28: Improved `internal/storage` coverage.
    - Added error path tests to `factory_test.go` covering provider initialization failures, router configuration errors (missing backends, unsupported strategies), and close errors.
    - Replaced magic string "default" with `model.DefaultTenantID` in `factory_impl.go` and added `TestNewFactory_DefaultTenantSkipped` to verify the skip logic.
    - Added `TestFactory_GetMongoProvider_Errors` to cover internal error paths where a backend is missing or is not a mongo provider.
- 2025-12-28: Improved `internal/api/rest` coverage.
    - Added `utils_coverage_test.go` to cover `flattenDocument` edge cases (`nil` document, `deleted` flag).
- 2025-12-28: Improved `internal/identity/internal/authn` coverage.
    - Added `token_error_test.go` to cover error paths in `token.go` including invalid key paths, malformed PEM, invalid signing methods, and missing tenant IDs.
- 2025-12-28: Improved `internal/api/rest` coverage.
    - Added `handler_error_test.go` to cover error paths in `handler_auth.go` (SignUp, Login, Refresh, Logout), `handler_admin.go` (ListUsers, UpdateUser, PushRules), and `handler_replication.go` (Pull, Push).
    - Verified all tests pass, including validation of invalid inputs and service errors.
