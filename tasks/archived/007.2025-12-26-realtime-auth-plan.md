# Realtime Auth (WS/SSE)

Date: December 26, 2025
Status: Completed
Scope: Add token + database validation for realtime WS and SSE endpoints, align CORS for credentialed SSE.

## Goals

- Require the same AuthN (token) and database enforcement on realtime WS/SSE as REST.
- Prevent cross-database data leaks by scoping subscriptions and broadcasts.
- Keep EventSource clients usable while enforcing auth and CORS for credentialed requests.

## Current Gaps

- WS/SSE accept connections without token or database checks; WS `TypeAuth` is TODO.
- `queryService` calls use database "default" in realtime, ignoring caller database.
- SSE sets `Access-Control-Allow-Origin: *`, which blocks credentialed requests and is too permissive for auth.

## Decisions (answered)

- EventSource auth: Use Authorization header in the HTTP request; internal clients can set it via request construction. (Why: avoids token leakage in URLs; How: require header and reject missing/invalid tokens.)
- Background watch: Can continue watching all collections for now. (Why: reduces fan-out complexity; How: central watcher + per-client filtering.)
- CORS: Tighten to support credentialed SSE. (Why: auth requires credentials; How: restrict allowed origins, expose needed headers, and enable credentials.)
- Token transport for SSE: Only Authorization header; cookies not supported; explicitly reject query-string tokens. (Why: avoid CSRF and token leakage; How: header-only, query denied.)
- WS frame vs HTTP auth: HTTP header is authoritative; `TypeAuth` is fallback for clients without headers. If frame token conflicts with header, close with error and prefer header result.
- Origin policy: Maintain allowlist from config/env; echo origin only when present in allowlist; when `Origin` missing and credentials are present, reject; allow wildcard only for local dev flag.
- Event database source: rely on `storage.Event.DatabaseID` (and `Document.DatabaseID` when present); events lacking database are treated as invalid and dropped.

## Proposed Approach (Why / How)

- Authenticate at HTTP upgrade/connection time for WS and at initial SSE request.
  - Why: fail fast before allocating hub resources; ensure database available in context.
  - How: wrap ServeWs/ServeSSE with AuthN middleware; close connection on 401/403.
- Propagate database into realtime operations.
  - Why: avoid cross-database visibility; align with REST contract.
  - How: pass database from context into queryService calls (WatchCollection, Pull) and filter events per database when broadcasting; drop events lacking database or with mismatched database.
- Keep frame-level `TypeAuth` optional for clients that cannot send headers.
  - Why: backwards compatibility; How: validate token in first frame, then mark client authenticated or close.
- CORS for SSE with credentials.
  - Why: EventSource with Authorization/cookies requires `Allow-Credentials` and non-wildcard origin.
  - How: configure allowed origins list (configurable), echo request origin when allowed, set `Access-Control-Allow-Credentials: true`, expose `Authorization` and `Content-Type` headers, set `Vary: Origin`; reject credentialed requests with missing/disallowed origin; optional dev-mode wildcard.

## Plan

- Add AuthN middleware hooks to realtime HTTP handlers (WS upgrade, SSE) with 401/403 handling.
- Inject database/user context into realtime flow; use database instead of "default" for queryService calls; add per-event database filtering to Hub; log/drop events missing database.
- Implement optional WS `TypeAuth` handshake for header-less clients; enforce single successful auth per connection.
- Update SSE response headers for credentialed use: allow-listed origins, `Access-Control-Allow-Credentials`, `Vary: Origin`, drop `*`; reject credentialed SSE when origin not allowed; add dev override flag.
- Add config knobs: allowed-origins list, dev-mode wildcard, enable/disable realtime auth (feature flag), and max connection thresholds for auth failures; emit metrics/logs on rejects.
- Tests (testify):
  - WS/SSE reject missing/invalid token (401/close).
  - Valid token with database succeeds and receives only its database events.
  - SSE CORS headers present for allowed origin with credentials; absent for disallowed origins.
  - Credentialed SSE with missing origin is rejected; disallowed origin is rejected without leaking headers.
  - WS frame auth fallback works; conflict between header and frame closes connection with error.
  - Events with missing/mismatched database are dropped and not delivered.
  - Per-database filtering: when hub receives mixed-database events, clients only see their own database; privileged CSP watcher path covered separately.
  - Dev-mode wildcard: allowed only when flag enabled; disabled by default; verify credentialed SSE blocked when wildcard disabled.
  - Metrics/logs hooks are invoked on auth/CORS rejects (can be mocked).
  - SSE denies query-string tokens and any cookie-based auth attempts.
  - Failure-closed behavior when `DatabaseID` missing in events (except explicit CSP/system path).

## Acceptance Criteria

- 401 on missing/invalid token before WS upgrade/SSE stream; connection closed on auth failure.
- No cross-database delivery: only events matching client database are sent; events without database are dropped.
- SSE responses for allowed origins include `Access-Control-Allow-Credentials: true`, `Vary: Origin`, and the echoed origin; disallowed/missing origins with credentials are rejected.
- Optional WS frame auth works only when header absent and does not override a valid header; conflicts close the connection.
- Configurable allowlist/dev-mode and realtime-auth enable flag are documented and honored.
- Event pipeline supplies `DatabaseID`; events missing database are logged and dropped.

## Open Questions

- For local dev wildcard, should we limit to localhost/127.0.0.1 only?
- Do we need to enforce/validate that upstream watchers always populate `DatabaseID` (and fail closed if missing)? â†’ Yes for normal paths; only privileged system/CSP watcher may omit database to see all changes (must be explicitly gated and non-default).

## Risks / Follow-ups

- Performance: filtering all-database watch may add per-event checks; revisit per-database hubs later if needed.
- Compatibility: tightening CORS may require clients to supply explicit origin; document migration.
- Token-in-frame support increases complexity; ensure clear precedence (HTTP auth preferred).

## Status Log

- 2025-12-26: Task created, status set to In Progress. Collected decisions on EventSource auth, watch scope, and CORS tightening.
