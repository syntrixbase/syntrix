# Query Surface Encapsulation & HTTP Adapter Refactor

Date: December 26, 2025
Status: Completed
Scope: Reduce query surface to interface-only, hide implementations behind internal packages, and align constructors/HTTP adapters for local and remote use.

## Follow-up Tasks

| Task | Description | Depends On |
|------|-------------|------------|
| [017.index-layer-implementation](017.2025-12-29-index-layer-implementation.md) | Index layer with btree, OrderKey encoding, templates, rebuild | Task 016 |
| [016.change-stream-puller](016.2025-12-29-change-stream-puller.md) | Change stream puller, fan-out, checkpoints, JetStream | This task (014) |

## Related Design Documents

| Doc | Path | Description |
|-----|------|-------------|
| Requirements | [000.requirements.md](../docs/design/server/engine/000.requirements.md) | Functional requirements, public API surface, constraints |
| Architecture | [001.architecture.md](../docs/design/server/engine/001.architecture.md) | Overall architecture, package layout, data flows, layering |
| Data Layer | [002.data.md](../docs/design/server/engine/002.data.md) | Data adapters, CAS CRUD, change stream emission |
| Index Layer | [003.index.md](../docs/design/server/engine/003.index.md) | Index templates, OrderKey encoding, rebuild/WAL, in-memory shape |
| Query Layer | [004.query.md](../docs/design/server/engine/004.query.md) | Query planning/execution, index-first + fallback, cursor versioning |
| HTTP Adapter | [005.http.md](../docs/design/server/engine/005.http.md) | HTTP handler, routes, error mapping, retry policy |
| Client | [006.client.md](../docs/design/server/engine/006.client.md) | HTTP client implementation, timeouts, retry/backoff |
| Puller | [007.puller.md](../docs/design/server/engine/007.puller.md) | Change stream puller, fan-out, checkpoints, JetStream option |

## Goals
- Expose only the `Service` interface and factory functions; keep engine/server/client implementations internal.
- Provide clear construction paths for local (in-process) and remote (HTTP) usage with minimal public API.
- Normalize HTTP handler exposure via a single entry-point and tighten coupling to `Service`.
- Update docs/tests so behavior and contracts remain verifiable and discoverable.
- Enforce multi-tenant isolation end-to-end (Service, HTTP, replication, watch) with explicit tenant on requests and no cross-tenant reads/writes.

## Current Gaps
1) Exported `Engine`, `Server`, and `Client` reveal implementation details; callers can depend on internals directly.
2) HTTP adapter is a concrete `Server` type; no public handler factory accepting a `Service` abstraction.
3) Constructors are inconsistent (local uses `NewEngine`, remote uses `NewClient` but both expose structs). No facade enforcing interface-only usage.
4) Tests rely on concrete types and internal fields; coverage for interface/adapter contracts is thin.
5) Design docs lag behind current behavior and public surface decisions.
6) Multi-tenant behavior is implemented in code (tenant argument across Service/HTTP) but not yet captured in design docs or test matrices (edge validation, default tenant fallback, per-tenant isolation of index/change streams).

## Dry Run Analysis (2025-12-29)

### Potential Issues & Resolutions

| # | Issue | Impact | Resolution |
|---|-------|--------|------------|
| 1 | **Design doc path mismatch** | Docs say `internal/engine/internal/{data,index,...}` but code is in `internal/engine/` | **Keep `internal/engine/` as package root**; use `internal/engine/internal/{engine,http,client}` for unexported types. Update design docs to match. |
| 2 | **No Index layer exists** | Design requires index-first query; current Engine calls storage directly | **Defer to Task 015**. This task focuses on encapsulation only; Index layer is new functionality. |
| 3 | **No Data layer abstraction** | Design requires Data adapter with change stream emission | **Defer to Task 015**. Add Data layer when implementing Index. |
| 4 | **Missing `model.ErrIndexNotReady`** | Design requires this error for index unavailable scenarios | **Add placeholder error** in `pkg/model/errors.go`. Actual usage deferred to Task 015. |
| 5 | **No query config block** | Design requires `fallback_docs_max`, `data_scan_batch` etc. | **Defer config expansion to Task 015**. This task only does encapsulation. |
| 6 | **WatchCollection signature differs** | Current: `(ctx, tenant, collection)` vs Design: `Watch(ctx, tenant, collection, filters, startAfter)` | **Keep current signature** for this task. Expand in Task 015 when adding filter pushdown. |
| 7 | **NewServer accepts concrete Engine** | `NewServer(engine *Engine)` instead of `Service` interface | **Fix in this task**: Change to `NewHTTPHandler(s Service) http.Handler`. |

### Scope Clarification

This task (014) focuses on **pure refactoring**:
- ✅ Encapsulate Engine/Server/Client as unexported types
- ✅ Add factory functions (`NewService`, `NewClient`, `NewHTTPHandler`)
- ✅ Migrate call sites in `manager_init.go`
- ✅ Add `model.ErrIndexNotReady` placeholder
- ✅ Update tests to use interface, not concrete types

**New functionality deferred**:
- ❌ Index layer (btree, OrderKey, templates) → Task 016
- ❌ Data layer (change stream emission) → Task 016
- ❌ Query config expansion → Task 016
- ❌ Change stream puller → Task 015

## Decisions Needed
- Public surface: keep `Service` interface plus `NewService(storage.DocumentStore, cspURL string) Service`, `NewClient(baseURL string) Service`, and `NewHTTPHandler(s Service) http.Handler`.
- Implementation layout: move concrete structs into `internal/engine/internal/{engine,http,client}` with unexported types.
- Backward compatibility: provide shims if needed (prefer breaking concretes now to enforce interface usage).
- Testing approach: migrate to testify; focus on interface contract tests, HTTP black-box tests, and client/handler parity tests.
- Documentation: add design notes capturing “Why” (encapsulation, alignment with identity) and “How” (factories, routing, tests).

## Plan
- Add factories in `query` package: `NewService`, `NewClient`, `NewHTTPHandler`; keep `Service` interface in place.
- Relocate concrete implementations into internal subpackages; rename structs to unexported types and adjust imports.
- Update command wiring and call sites to use factories (no direct struct refs).
- Refresh tests: interface contract tests, handler black-box tests via `httptest`, client-to-handler parity tests; use testify.
- Documentation: add/refresh query design docs to record reasoning and API surface; update task index/status as work proceeds.
- Multi-tenant checks: ensure tenant is required on public entrypoints (with temporary `DefaultTenantID` for dev), index/rebuild/checkpoint partitioning per tenant, and watch/replication routing stays tenant-scoped.

## Execution Steps (this task - pure refactoring)
1) **Package encapsulation**
	- Move Engine/Server/Client concretes to `internal/engine/internal/{engine,http,client}` with unexported types.
	- Keep `internal/engine/` as package root with exported `Service` interface + factories.
	- Sweep imports to remove direct struct references; enforce interface use in cmd wiring.
2) **Factories and wiring**
	- Implement `NewService(storage.DocumentStore, cspURL string) Service` (wraps engine).
	- Implement `NewClient(baseURL string) Service` (wraps client).
	- Implement `NewHTTPHandler(s Service) http.Handler` (accepts interface, not concrete Engine).
	- Update `internal/services/manager_init.go` to construct via factories.
3) **Error placeholder**
	- Add `model.ErrIndexNotReady` in `pkg/model/errors.go` for future use.
4) **Tests (testify)**
	- Service interface contract tests.
	- HTTP handler black-box tests via `httptest`.
	- Client↔handler parity tests.
	- Ensure no test depends on concrete Engine/Server/Client types.
5) **Docs update**
	- Correct design doc paths (`internal/engine/internal/...` not `internal/engine/internal/...`).
	- Mark Index/Data/Puller as deferred to follow-up tasks.

## Deferred Execution Steps (Task 016 - Index Layer)
4) **Query execution policies** - index-first with bounded fallback
5) **Cursor/OrderKey versioning** - encoding-version byte
6) **Index templates and includeDeleted** - template matching/validation
8) **HTTP/Client behavior updates** - `IndexNotReady` mapping

## Deferred Execution Steps (Task 015 - Puller)
7) **Change stream puller** - fan-out, checkpoints, JetStream

## Execution Decisions (locked)
- **Config placement & defaults**: Add under `config.yml` → `query`: `fallback_docs_max`=500 (int), `data_scan_batch`=500, `query_fetch_batch`=128, `jetstream` block `{enabled: false, url: env NATS_URL, retention: 10m, replicas: 1, max_ack_pending: 200, ack_wait: 5s}`. Read on startup; no hot-reload in this iteration. CLI flags may override for tests. `index_required` is hardcoded true in code (not configurable).
- **Call-site migration**: Sweep for exported `Engine`/`Server`/`Client` usage (grep `NewEngine`, struct names) across `cmd/`, `internal/`, `pkg/`; replace with `Service` factories and remove direct struct deps. Add a lint note in PR to reject new imports.
- **Cursor/OrderKey encoding**: Prefix 1-byte version, then tuple-encode fields (big-endian nums, length-prefixed strings), append direction bit per field (asc=0, desc=1) or invert sortable bytes for desc. Serialize cursor as URL-safe base64. Version mismatch → `IndexNotReady`; rebuild existing index with new encoding (no new template).
- **Index hinting**: For now, responses remain minimal; do not emit index suggestions. Log/metric only. (Optional hint surface can be added later without breaking change.)
- **Operator matrix**: Allow `==`, `!=`, `>`, `>=`, `<`, `<=`, `in` (array), `exists` (bool). OrderBy allowed only on indexed fields; initial support single-field order (composite later). Post-filter permitted for non-indexable filters only when index provides candidates.
- **JetStream optionality**: Default `jetstream.enabled=false`. If enabled and URL missing → fail fast. When disabled, use storage change stream direct path. Keep config validation.
- **Test prioritization**: P0: Service contract, HTTP black-box, client↔handler parity, query index-hit/fallback (caps, startAfter), cursor version mismatch → IndexNotReady. P1: puller lag/backpressure/rebuild triggers, JetStream happy/error paths, hot/warm/cold hooks.
- **Metrics/observability**: Add counters for IndexNotReady, fallback served/blocked, index hits/misses, puller lag/backpressure events. Keep interface hooks internal; expose via existing metrics sink.

---

## Key Execution Details (extracted from design docs)

### Public API Surface
```go
// Factories (exported)
func NewService(store storage.DocumentStore, cspURL string) Service
func NewClient(baseURL string) Service
func NewHTTPHandler(s Service) http.Handler

// Service interface (exported) - every method takes explicit tenant
type Service interface {
    GetDocument(ctx, tenant, fullpath) (Document, error)
    CreateDocument(ctx, tenant, doc, filters) error
    ReplaceDocument(ctx, tenant, doc, filters) error
    PatchDocument(ctx, tenant, doc, filters) error
    DeleteDocument(ctx, tenant, fullpath, filters) error
    ExecuteQuery(ctx, tenant, model.Query) ([]Document, error)
    Watch(ctx, tenant, collection, filters, startAfter) (<-chan Event, error)
    Pull/Push(ctx, tenant, ...) // replication
}
```

### Package Layout
```
internal/engine/internal/
├── data/     # Data adapters over storage.DocumentStore
├── index/    # Index manager, templates, btree shards
├── query/    # Planner/executor
├── http/     # HTTP handler (NewHTTPHandler)
└── client/   # HTTP client impl of Service
```

### Data Layer Defaults
| Parameter | Value | Notes |
|-----------|-------|-------|
| DataHash | xxhash64 | Canonical JSON; payload cap 32KB when enabled |
| Scan batch | 500 docs | Per-collection |
| Rebuild QPS cap | 5k ops/s | Per collection |
| Max concurrent rebuilds | 2 global | Queue overflow → wait |
| Change stream buffer | 10 events | Overflow → rebuild flag |

### Index Layer Defaults
| Parameter | Value | Notes |
|-----------|-------|-------|
| Soft lag | 30s or 50k versions | Warn threshold |
| Hard lag | 2m or 200k versions | Force rebuild |
| Consumer buffer | 100 events | Per-consumer channel |
| Batch apply | 256 events or 1MB | Whichever first |
| WAL buffer (if enabled) | 10k events or 32MB | Overflow → restart rebuild |
| Checkpoint cadence | 1s or 1k events | Whichever first |

### Index Template Format (YAML)
```yaml
templates:
  - name: chats_by_name_age
    collectionPattern: users/{uid}/chats  # collection-scoped only
    fields:
      - { field: name, order: asc }
      - { field: age,  order: desc }
    includeDeleted: true  # fixed true for replication
```

### OrderKey Encoding (bytes)
```
[ver:1B][field1...][field2...][id_len:uvarint][id bytes][optional deleted/version bits]

string (asc): [len:uvarint][utf8 bytes]
string (desc): invert each byte after length
number: big-endian sortable; desc → invert bytes
bool: 0x00/0x01; desc → invert
cursor/startAfter: same bytes, base64-url on wire
```

### In-Memory Index Shape
```
Index Manager
    └── map[string]*Shard  // key: (normalizedPattern, templateIdentity)
            ├── Pattern: "users/*/chats"
            ├── TemplateID: "name:asc,age:desc"
            ├── Mu (RW lock)
            ├── ByID: map[id] -> OrderKey
            └── Tree (btree): OrderKey -> DocRef{ID, OrderKey}
```

### Query Layer Defaults
| Parameter | Value | Notes |
|-----------|-------|-------|
| Data batch size | 128 doc refs | Per fetch |
| Fallback doc cap | 500 docs | Config `fallback_docs_max` |
| Index required | true | Hardcoded, not configurable |

### HTTP Adapter Defaults
| Parameter | Value | Notes |
|-----------|-------|-------|
| CRUD timeout | 5s | Server-side |
| Query timeout | 30s | Server-side |
| Watch idle timeout | 2m | With heartbeat |
| Error shape | `{"code":"...", "message":"..."}` | Backward-compatible opt-in |

**Routes**: `/internal/v1/document/*`, `/internal/v1/query/execute`, `/internal/v1/watch`, `/internal/replication/v1/*`, `/health`

**Retry Policy**:
- Safe to retry: `GetDocument`, `ExecuteQuery`, `Watch`, `Pull`
- Not safe (no idempotency keys): `Create/Replace/Patch/Delete`, `Push`

### Client Defaults
| Parameter | Value | Notes |
|-----------|-------|-------|
| CRUD timeout | 5s | |
| Query timeout | 30s | |
| Watch read timeout | 2m | |
| Retry max | 5 | 5xx/network errors only |
| Backoff | base 200ms, factor 2.0, jitter ±20% | Max total 30s |

### Puller/JetStream Defaults
| Parameter | Value | Notes |
|-----------|-------|-------|
| Batch size | 256 events or 1MB | |
| Retention | 10m | Short window, rebuild on lag |
| Storage | File | |
| Replicas | 1 (dev) / 3 (prod) | |
| max_ack_pending | 200 | |
| ack_wait | 5s | |

### Change Event Schema
```go
type Event struct {
    Tenant     string
    Fullpath   string
    Collection string
    Version    int64
    Deleted    bool
    UpdatedAt  int64
    CreatedAt  int64
    DataHash   string         // xxhash64
    Payload    map[string]any // optional, cap 32KB
}
```

### Error Handling
| Condition | Response |
|-----------|----------|
| Index missing/unready | `IndexNotReady` (retriable after backoff) |
| Cursor version mismatch | `IndexNotReady` (rebuild required) |
| Fallback exceeds cap | `IndexNotReady` (no scan) |
| Cross-tenant access | Reject early at handler |

## Implementation Notes / Risks
- Ensure HTTP routes stay stable (`/internal/v1/*`, replication paths) while hiding types.
- Watch streaming behavior and replication CAS semantics remain unchanged after refactor.
- Beware of downstream packages importing concrete types; need a sweep to replace with `Service` usage.

## Verification
- Unit tests (testify) for `Service` contract, HTTP handler behaviors, client/handler parity, replication flows.
- Lint/build once refactor lands.

## Status Log
- 2025-12-26: Task created, status set to In Progress.
- 2025-12-26: Added engine design drafts (requirements, architecture) under docs/design/server/engine.
- 2025-12-26: Documented index store placement (kept under query internals, not primary storage).
- 2025-12-26: Refined architecture (change event schema, query batching/fallback, rebuild throttling, watch strategy) in docs/design/server/engine/001_architecture.md.
- 2025-12-26: Added per-module responsibilities/interfaces/tests to docs/design/server/engine/001_architecture.md.
- 2025-12-26: Added detailed module docs (data/index/query/http/client) under docs/design/server/engine/002-006.*.md.
- 2025-12-26: Further refined open points (hash/payload policy, hot/warm/cold rules, cursor/order encoding, error/backoff guidance) across module docs and architecture.
- 2025-12-26: Added actionable defaults (batch sizes, throttles, timeouts, retries, guardrails) to module docs for execution readiness.
- 2025-12-26: Documented change-stream fan-out/checkpoint/backpressure strategy for index consumers (003.index.md) and added to architecture open items.
- 2025-12-26: Added puller design (change stream pull + fan-out, checkpoints, lag/backpressure) in docs/design/server/engine/007.puller.md.
- 2025-12-26: Added NATS/JetStream option with retention (5–10m), ordering, flow control to puller design.
- 2025-12-26: Fixed puller defaults formatting and added explicit JetStream defaults (retention 10m, storage=file, replicas 1/3, max_ack_pending=200, ack_wait=5s).
- 2025-12-26: Clarified JetStream semantics (single-subject ordering, idempotent apply, external checkpoints, gap→rebuild) in puller design.
- 2025-12-26: Added JetStream vs Kafka tradeoff notes (latency, retention/cost, ops weight, when to pick Kafka) in puller design.
- 2025-12-26: Added index template format/matching/encoding/apply rules to docs/design/server/engine/003.index.md.
- 2025-12-26: Set index-required=true (no fallback scans), clarified IndexNotReady handling, includeDeleted=true for templates, cold-collection hook reserved, removed duplicate change-stream section.
- 2025-12-26: Locked in policy values (hash caps, batch sizes, QPS limits, lag thresholds, timeouts, retries, buffers) across module docs for executability.
- 2025-12-27: Multi-tenant support landed in code (tenant required on Service/HTTP/replication/watch with DefaultTenant fallback); design docs now need alignment and tests must cover tenant isolation/validation.
