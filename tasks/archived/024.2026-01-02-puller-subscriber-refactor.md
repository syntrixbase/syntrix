# Puller Subscriber Refactoring

Date: 2026-01-02
Status: Completed
Scope: Puller Service (Core, gRPC)

## Context & Analysis

Current analysis of the Puller architecture reveals several structural improvements needed for `Subscriber`, `ProgressMarker`, and event propagation.

### 1. Subscriber Location (`grpc` -> `core`)

*   **Reason**: `Subscriber` encapsulates subscription state management (Progress Marker maintenance), flow control (Overflow handling), and event distribution. These are core domain logic of the Puller service, not just transport logic for gRPC.
*   **Current Status**: Currently, `core.Subscribe` manually implements a simplified subscription logic (creating channels, maintaining local `pm`), while the `grpc` package has a more robust `Subscriber` struct.
*   **Benefit**: Moving `Subscriber` to `core` allows `core.Subscribe` (in-process calls) and `grpc.Server` (remote calls) to reuse the same robust subscription management logic, eliminating code duplication and unifying flow control behavior.

### 2. ProgressMarker Visibility (`events` -> `internal`)

*   **Reason**: The specific structure of `ProgressMarker` (`map[string]string`) is an implementation detail. To external consumers (including the `services` layer), it should be an opaque token.
*   **Current Status**: `ProgressMarker` is exposed in the `events` package.
*   **Benefit**: Moving it to `internal` forces external callers to interact only via `Encode/Decode` interfaces, preventing external code from relying on its internal structure. This facilitates future changes to the Resume Token storage format (e.g., binary or compressed) without breaking compatibility.

### 3. Redundant Progress Calculation

*   **Analysis**: Currently, `core.Subscribe` maintains a local `pm` variable in its callback closure and updates it with every event. This overlaps completely with the `currentPos` maintenance inside `Subscriber`.
*   **Benefit**: Eliminating this redundancy simplifies `SetEventHandler` to just routing, leaving progress tracking to the `Subscriber`.

### 4. Redundant Types (`backendEvent`)

*   **Analysis**: `backendEvent` currently exists solely to carry the `backend` (string) context. `PullerEvent` is an output DTO.
*   **Discovery**: The `ChangeEvent` struct already contains a `Backend string` field.
*   **Benefit**: Removing `backendEvent` and populating `ChangeEvent.Backend` at the source simplifies the internal pipeline and reduces object allocations.

## Goals

1.  **Centralize Subscription Logic**: Move `Subscriber` to `internal/puller/internal/core` to be shared between local and remote (gRPC) consumers.
2.  **Encapsulate Progress**: Move `ProgressMarker` to `internal/puller/internal/cursor` to enforce opaque usage.
3.  **Simplify Event Flow**: Remove `backendEvent` and ensure `ChangeEvent.Backend` is populated at source.
4.  **Unify Implementation**: Use the same `Subscriber` implementation for both `core.Subscribe` and `grpc.Server`.

## Implementation Plan

### Phase 1: ProgressMarker Refactoring

- [x] Create `internal/puller/internal/cursor` package.
- [x] Move `internal/puller/events/progress.go` to `internal/puller/internal/cursor/progress.go`.
- [x] Update `events` package to alias `cursor.ProgressMarker` or expose necessary interfaces if needed, but preferably keep it internal and only expose opaque strings in `PullerEvent`.
    - *Correction*: `PullerEvent` uses `string` for Progress. `Subscriber` uses `ProgressMarker` struct. The struct should be internal.
- [x] Update all references in `core`, `grpc`, and `tests`.

### Phase 2: Event Flow Optimization

- [x] Verify/Update `internal/puller/internal/core` to populate `ChangeEvent.Backend` field immediately when reading from Change Stream or Buffer.
- [x] Remove `backendEvent` struct from `grpc` package.
- [x] Update `grpc.Server` to use `*events.ChangeEvent` directly in channels.

### Phase 3: Subscriber Relocation & Refactoring

- [x] Move `internal/puller/internal/grpc/subscriber.go` to `internal/puller/internal/core/subscriber.go`.
- [x] Update `Subscriber` struct:
    - [x] Change channel type from `backendEvent` to `*events.ChangeEvent`.
    - [x] Remove `backendEvent` usage.
    - [x] Ensure `UpdatePosition` uses `event.Backend`.
- [x] Update `SubscriberManager` to work with the moved `Subscriber`.

### Phase 4: Unification

- [x] Refactor `grpc.Server` to use `core.Subscriber` and `core.SubscriberManager`.
- [x] Refactor `core.Puller.Subscribe` method:
    - [x] Instead of creating a raw channel and ad-hoc loop, instantiate a `Subscriber`.
    - [x] Register the subscriber with a `SubscriberManager` (which needs to be added to `Puller` struct).
    - [x] Ensure `SetEventHandler` (or the internal dispatch mechanism) broadcasts to the `SubscriberManager`.

### Phase 5: Cleanup & Verification

- [x] Remove ad-hoc subscription logic from `core/puller.go`.
- [x] Verify all tests pass (`go test ./internal/puller/...`).
- [x] Verify `services` integration tests pass.
