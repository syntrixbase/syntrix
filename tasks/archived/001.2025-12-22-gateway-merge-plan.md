# Gateway Unification Plan (REST + Replication + Realtime WS/SSE)

Date: December 22, 2025
Status: Done
Scope: Merge API gateway and realtime gateway into a single server on one port; REST/Replication keep `/api/v1/...`; realtime uses `/realtime/ws` (WebSocket) and `/realtime/sse` (SSE); unify config and manager wiring.

## Objectives
- Single gateway service (one port) for REST/Replication and Realtime.
- Single config node (no legacy realtime fields/flags/env).
- Clear routing: `/api/v1/...` for REST/Replication; `/realtime/ws|sse` for realtime.
- Code layout under `internal/api/` with `rest/` and `realtime/` subdirectories.
- Manager only manages one gateway service; no separate realtime service.
- Graceful startup/shutdown covering REST and WS/SSE.

## Work Breakdown (Step-by-Step)

### 1) Config Unification
- Define unified gateway config schema (single node, e.g., `gateway.*` or `api.*`).
- Fields: `port`, `tls` (enable/cert/key), `auth` (issuer/audience/jwks/cacheTTL), `limits` (HTTP per-tenant/IP QPS/burst; WS maxConnections/maxSubscriptionsPerConn), `timeouts` (HTTP read/write/idle; WS pingInterval/idleTimeout/writeWait/maxMessageSize), `cors`, `gzip`, `realtime` (transport ws/sse/both, perMessageDeflate), optional `replication` limits (pull/push rate/batch).
- Remove legacy realtime fields and flags/env (`--realtime-*` etc.); new flags/env only.
- Update config validation and defaults.

### 2) Directory/Layout
- Under `internal/api/` ensure two subfolders:
  - `rest/`: existing REST + replication handlers/routers/middleware (currently under api).
  - `realtime/`: connection/auth/heartbeat/subscription/push/limits (from old realtime gateway).
- Keep `internal/api/server.go` as the unified assembly point.

### 3) Server Assembly
- In `internal/api/server.go` compose a single mux/server:
  - Register REST/Replication routes under `/api/v1/...` (CRUD, query, replication pull/push, admin/health/trigger, etc.).
  - Register realtime handlers: `GET /realtime/ws` (WS upgrade), `GET /realtime/sse` (text/event-stream).
- Share middleware: auth, tracing, metrics, cors, gzip, rate limit. WS handshake also passes through auth/limits; connection/subscription limits enforced in realtime module.
- Use unified config for timeouts/limits/TLS.
- Graceful shutdown: stop accepting new conns; close WS/SSE with notice; allow REST in-flight to finish or time out.

### 4) Manager Wiring
- In `internal/services`: register only one `GatewayService`; remove realtime-specific service entries and health checks.
- Service lifecycle: start unified gateway; stop/shutdown unified gateway.

### 5) Command Entry
- `cmd/syntrix/main.go`: start the unified gateway using the new config/flags; drop old realtime flags/env wiring.
- If a combined `--all` exists, it should start this unified gateway variant.

### 6) Routing & Protocol Notes
- REST/Replication unchanged paths: `/api/v1/...`, `/replication/v1/pull`, `/replication/v1/push`.
- Realtime paths: `/realtime/ws` (bidi WebSocket), `/realtime/sse` (server-to-client SSE with same auth/semantics).
- Auth parity: REST/WS/SSE all require token; same issuer/audience/jwks.
- Realtime resume: WS supports resume via resume token/seq; SSE reconnect should use last cursor if supported.

### 7) Docs
- Update design docs (already updated 001, 003, 005) to reflect unified gateway and new paths.
- Add config examples showing only new gateway node and fields.
- Update operational runbooks/README if any reference old realtime service/flags.

### 8) Testing (to implement post-code changes)
- Single-port smoke: REST 200, `/realtime/ws` handshake + heartbeat + subscription + event, `/realtime/sse` stream delivers events.
- Auth: REST/WS/SSE all enforce token; 401/403 parity.
- Replication: pull/push OK; auth failure does not advance checkpoint; recovery after valid token.
- Realtime: connection/subscription caps enforced; heartbeat timeout disconnect; ordering per-partition; filtering works.
- Config parsing: new fields only; missing required fields fail fast; TLS on/off works; rate limits/timeouts applied.
- Graceful shutdown: rejects new connections; WS/SSE close; REST in-flight completes or times out.

## Notes / Open Points
- Config migration UX: startup must fail fast with clear errors if required new fields are missing; release note should state removal of legacy realtime flags/fields.
- SSE vs WS semantics: SSE reconnect uses last cursor/seq only (no bidirectional resume); heartbeat via SSE comments; no client ack; keep payload envelope identical to WS `event`.
- Timeouts/buffers (defaults to decide): WS `pingInterval` ~30s, `idleTimeout` ~90s, `writeWait` ~10s, `maxMessageSize` tuned for largest payload; SSE write timeout separate from REST; avoid sharing small REST timeouts.
- CORS/cache: SSE endpoints must set CORS and no-cache headers to avoid browser caching issues.
- Health/readiness: cover REST and realtime; include WS/SSE handshake probe and event-ingress availability; expose a lightweight internal probe for CSP->Gateway link health if applicable.
- Metrics: include WS/SSE connections, subscriptions, messages sent/dropped, broadcast ratio, reconnect/resume success, queue watermarks.
- Metrics (proposed):
  - `gateway_ws_connections{tenant}`, `gateway_sse_connections{tenant}`
  - `gateway_subscriptions{tenant}`, `gateway_msgs_sent{transport,tenant}`, `gateway_msgs_dropped{transport,reason}`
  - `gateway_broadcast_ratio`, `gateway_reconnects{transport}`, `gateway_resume_success{transport}`
  - `gateway_queue_watermark{partition}`
- Backpressure: when over watermarks, SSE disconnect with advisory to resubscribe; WS may drop low-priority/broadcast or request client throttle; document consistent policy.
- Testing additions: TLS on/off for WS/SSE; large message vs maxMessageSize; shutdown while SSE/WS in-flight; auth failures return consistent codes on handshake; over-limit connection/subscription handling.
- Ensure events ingress from CSP to gateway remains unchanged; only gateway endpoints/assembly change.
- Validate SSE payload envelope mirrors WS `event` messages.
- Defaults to lock in (proposed for config):
  - WS: `pingInterval=30s`, `idleTimeout=90s`, `writeWait=10s`, `maxMessageSize` sized for worst-case payload (set concrete byte value), `perMessageDeflate` on/off via config.
  - SSE: write timeout separate from REST (e.g., 30s), keep-alive comment interval (e.g., 25s), no ack/resume beyond cursor.
  - Rate limits: HTTP QPS/burst per tenant/IP; WS connection cap; subscription cap per connection; SSE connection cap.
  - CORS: explicit allowlist; `Cache-Control: no-store` for SSE; `Content-Type: text/event-stream`.
  - Health: HTTP 200 for REST probe; WS handshake/heartbeat synthetic probe; optional internal probe for event ingress.
- Error/handshake codes:
  - Auth failures on WS/SSE handshake mirror REST (401/403); over-limit returns 429; malformed request 400.
  - Graceful shutdown: WS/SSE close with reason; HTTP returns 503 after drain starts.
- Backpressure detail:
  - Define queue watermarks (soft/hard). Above soft: shed optional/broadcast; above hard: SSE disconnect; WS may drop low-priority/broadcast or request throttle, then disconnect if persistent.
