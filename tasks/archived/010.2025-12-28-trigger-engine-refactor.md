# Trigger Engine Refactor & Factory Wiring

Date: 2025-12-28
Status: Complete (2025-12-29)
Scope: Trigger engine + factory/interfaces, watcher/checkpoint, publisher/consumer hashing & validation, worker/auth/signature, observability, migration/testing
Reference Design: docs/design/server/trigger/000_requirements.md; 001_architecture.md; 002_interfaces.md; docs/design/server/trigger/README.md; docs/design/server/trigger/architecture.md

## Objectives

- Introduce `TriggerFactory` + `TriggerEngine` with error-returning `LoadTriggers`, enforcing tenant/collection/docKey validation and fail-fast startup.
- Encapsulate watch/checkpoint logic in a `DocumentWatcher` adapter with tenant-scoped checkpoints, context-aware cancellation, and explicit start-from-now opt-in + audit signal.
- Enforce subject-safe publishing (base64url docKey, NATS length guard with hash fallback) and consumer partitioning/idempotency keyed by decoded docKey, not hashed segment.
- Strengthen worker HTTP path (configurable timeout/client, tenant-scoped secret/token retrieval, signature header) and retry/backoff parity with design.
- Add observability for publish/consume/worker success, retries, latency, hash-path traffic (`subjectHashed`), collisions, and checkpoint resets.
- Provide migration guidance/tests so callers handle `LoadTriggers` errors and new validation behaviors.

## Known Issues to Address (from Design Review)

The following issues identified in design review must be resolved during this refactor:

- **Replication pull gap**: Current query engine uses `updatedAt > checkpoint`, skipping docs with identical timestamps. Fix: Pull filter must be inclusive (`updatedAt >= checkpoint`) with secondary sort key (e.g., `id`).
- **Push input validation**: Missing validation for empty path when neither `Fullpath` nor `id` is present. Fix: Reject invalid requests before storage call.
- **Watch cancellation/timeout**: `WatchCollection` lacks read timeouts and context awareness in decode loop. Fix: Add client timeouts and context-aware read loops to prevent goroutine leaks.
- **Delete conflict masking**: `ErrNotFound` treated as success in delete flow. Fix: Surface version conflicts when delete preconditions fail.
- **Watch error observability**: JSON decode errors are swallowed. Fix: Propagate errors to callers to distinguish stream corruption from graceful close.
- **Loader error signaling gap**: `LoadTriggers` swallows errors. Fix: Return error on validation failure to prevent partial activation.
- **Hash-guard partitioning ambiguity**: Partitioning on hashed subject segment breaks ordering. Fix: Consumer must partition on decoded docKey from payload.
- **Hash observability gap**: Lack of visibility into hash-path traffic. Fix: Add `subjectHashed=true` metric dimension and collision logging.
- **Checkpoint reset risk**: Silent "start from now" on missing checkpoint. Fix: Require explicit opt-in or emit audit/metric.
- **Hash collision handling**: Define consumer behavior (serialize/fail) and alert thresholds for hash collisions.
- **Hash branch retry/alert tuning**: Consider stricter retry caps/timeouts for hash-path traffic.
- **"Start from now" audit/RBAC**: Define audit sink and authorization for skipping historical events.
- **LoadTriggers error migration**: Document caller migration steps (fail-fast/health check) for new error returns.
- **Secret/token failure observability**: Add labeled metrics for secret/token fetch failures.

## Plan / Milestones

### M1: Interfaces, Factory & Wiring (Migration Steps 1, 4, 6)
- [x] **Create Package Structure**:
    - Create `internal/trigger/engine`
    - Create `internal/trigger/internal/watcher`
    - Create `internal/trigger/internal/pubsub`
    - Create `internal/trigger/internal/worker`
    - Create `internal/trigger/internal/config`
    - Create `internal/trigger/internal/evaluator`
- [x] **Define Interfaces (`internal/trigger/engine/interfaces.go`)**:
    - `TriggerEngine`: `LoadTriggers`, `Start`, `Close`.
    - `TriggerFactory`: `Engine`, `Close`.
- [x] **Define Adapter Interfaces**:
    - `internal/trigger/internal/watcher/interfaces.go`: `DocumentWatcher`.
    - `internal/trigger/internal/pubsub/interfaces.go`: `TaskPublisher`, `TaskConsumer`.
    - `internal/trigger/internal/worker/interfaces.go`: `DeliveryWorker`.
- [x] **Implement Factory (`internal/trigger/engine/factory.go`)**:
    - `defaultTriggerFactory` (Unexported): Holds dependencies (Storage, NATS, AuthN).
    - `NewFactory(...)`: Exported constructor returning `TriggerFactory` interface.
    - `Engine()`: Initial skeleton. Wires up `Evaluator` (available in M1). *Note: Watcher and PubSub will be wired in M3/M4.*
    - **Refactor**: Move `evaluator.go` to `internal/trigger/internal/evaluator/` for consistency.
- [x] **Refactor Engine (`internal/trigger/engine/engine.go`)**:
    - `defaultTriggerEngine` (Unexported): Orchestrates the flow.
    - `Start()`: Skeleton flow (Watcher -> Evaluator -> Publisher).
    - `LoadTriggers()`: Updates state, returns error (placeholder for validation).

### M2: Validation & Loader (Migration Step 7)
- [x] **Implement Validation**:
    - Create `internal/trigger/validation.go`: Add `ValidateTrigger(t *Trigger) error`.
    - Check tenant/collection charset (alphanumeric, dash, underscore).
    - Check docKey safety (no `.` `*` `>`).
- [x] **Update Loader**:
    - In `internal/trigger/engine/engine.go`: Call validation in `LoadTriggers`.
    - Fail fast if any trigger is invalid.
- [x] **Fix Push Input Validation**:
    - Ensure `LoadTriggers` or the upstream caller validates empty paths.

### M3: Watcher & Checkpoints (Migration Steps 2, 8)
- [x] **Extract Watcher**:
    - Move `Watch` logic from `service.go` to `internal/trigger/internal/watcher/watcher.go`.
    - Implement `DocumentWatcher` interface.
    - **Update Factory**: Wire `DocumentWatcher` into `Engine`.
- [x] **Update Checkpoints**:
    - Change checkpoint key to `sys/checkpoints/trigger_evaluator/<tenant>[/<collection>]`.
    - Implement `SaveCheckpoint`.
- [x] **Fix Watch Issues**:
    - Add `context` check in read loop.
    - Add timeout to underlying HTTP client (if applicable) or read deadline.
    - Propagate JSON decode errors.
    - Fix "Replication pull gap" (inclusive filter).
    - Fix "Delete conflict masking".
- [x] **Start-From-Now**:
    - Implement logic to handle missing checkpoint.
    - **Behavior**: If no checkpoint exists and no "start-from-now" flag is provided, return error or wait (do not silently skip history).
    - Add audit log/metric if starting from now.

### M4: Publisher & Consumer (Migration Steps 3, 7)
- [x] **Move Pub/Sub**:
    - Move `publisher.go` -> `internal/trigger/internal/pubsub/publisher.go`.
    - Move `consumer.go` -> `internal/trigger/internal/pubsub/consumer.go`.
    - **Update Factory**: Wire `TaskPublisher` and `TaskConsumer` into `Engine`.
- [x] **Enhance Publisher**:
    - [x] Implement `EncodeDocKey` (base64url).
    - [x] Implement `HashSubject` (SHA-256 trunc 32) if length > 1024.
    - [x] Set `subjectHashed` flag in `DeliveryTask`.
- [x] **Enhance Consumer**:
    - [x] Update `dispatch` to use `task.DocKey` (decoded) for partitioning.
    - [x] Log collision if `subjectHashed` is true and hash matches but docKey differs (if possible to detect).

### M5: Worker & Auth/Signature (Migration Step 5)
- [x] **Move Worker**:
    - [x] Move `worker.go` -> `internal/trigger/internal/worker/worker.go`.
- [x] **Enhance Worker**:
    - [x] Update `NewDeliveryWorker` to accept `HTTPClientOptions` (timeout).
    - [x] Inject `SecretProvider` (interface) for `SecretsRef` resolution.
    - [x] Implement `GenerateSystemToken` using `identity.AuthN` (already there, verify tenant scope).
    - [x] Ensure 4xx returns fatal error (wrapped), 5xx returns retryable error.

### M6: Observability & Telemetry
- [x] **Add Metrics**:
    - [x] Define metrics in `internal/trigger/metrics.go` (moved to `internal/trigger/types/metrics.go` to avoid cycles).
    - [x] Instrument `Publish`, `Consume`, `ProcessTask`.
    - [x] Add `subjectHashed` label.
- [x] **Add Audit**:
    - [x] Log audit event in `watcher.go` when starting from now.

### M7: Migration & Tests (Migration Step 9)
- [x] **Update Callers**:
    - Update `cmd/syntrix/main.go` (or wherever trigger service is started) to use `TriggerFactory`.
    - Handle `LoadTriggers` error.
- [x] **Unit Tests**:
    - Add tests for `validation.go`.
    - Add tests for `watcher.go` (checkpointing).
    - Add tests for `publisher.go` (encoding/hashing).
    - Add tests for `consumer.go` (partitioning).

## Deliverables

- New engine/factory implementation with adapters.
- Validation utilities.
- Config structs.
- Telemetry hooks.
- Comprehensive test suite.

## Risks & Mitigations

- Risk: Caller ignores new LoadTriggers errors â†’ Mitigation: migration guide + startup fail-fast pattern.
- Risk: Hash fallback collision handling unclear â†’ Mitigation: explicit strategy + metrics/alerts.
- Risk: Start-from-now used without audit â†’ Mitigation: require explicit flag and emit audit/metric.

## M8: Bug Fixes & Hardening (2025-12-29)

Based on code review, the following issues need to be addressed:

### ðŸ”´ High Priority (P0)

#### 8.1 Engine.Close() Empty Implementation âœ…
**File**: `internal/trigger/engine/engine.go`
**Issue**: `Close()` does not release watcher/publisher resources, causing goroutine/resource leaks.
**Fix**:
- [x] Add `Close()` method to `DocumentWatcher` interface
- [x] Add `Close()` method to `TaskPublisher` interface
- [x] Update `defaultTriggerEngine.Close()` to call `watcher.Close()` and `publisher.Close()` if not nil
- [x] Add context cancellation tracking in engine

#### 8.2 Factory.Engine() Uses panic âœ…
**File**: `internal/trigger/engine/factory.go`
**Issue**: `panic(err)` on evaluator/publisher creation crashes entire service.
**Fix**:
- [x] Change `Engine() TriggerEngine` to `Engine() (TriggerEngine, error)`
- [x] Update `TriggerFactory` interface signature
- [x] Update all callers to handle returned error
- [x] Add unit test for error path

#### 8.3 Nil Document/Before in Event Processing âœ…
**File**: `internal/trigger/engine/engine.go`
**Issue**: If both `evt.Document` and `evt.Before` are nil, task has empty collection/docKey.
**Fix**:
- [x] Add guard: skip event if both Document and Before are nil
- [x] Log warning for such events
- [x] Add unit test for this edge case

### ðŸŸ  Medium Priority (P1)

#### 8.4 Consumer Worker Channel Buffer Hardcoded âœ…
**File**: `internal/trigger/internal/pubsub/consumer.go`
**Issue**: Buffer size 100 is hardcoded, may not be sufficient under high load.
**Fix**:
- [x] Add `ChannelBufferSize` to `ConsumerConfig` or as parameter (via ConsumerOption)
- [x] Default to 100 if not specified
- [x] Update `NewTaskConsumer` signature

#### 8.5 HTTP Worker Uses Hardcoded dummy-secret âœ…
**File**: `internal/trigger/internal/worker/worker.go`
**Issue**: When `SecretsRef` is empty, uses `"dummy-secret"` which is insecure.
**Fix**:
- [x] If `SecretsRef` is empty, skip signature header entirely
- [x] If `SecretsRef` is set but no provider, return FatalError
- [x] Document expected behavior in code comments

#### 8.6 CEL Program Cache Unbounded âœ…
**File**: `internal/trigger/internal/evaluator/evaluator.go`
**Issue**: `prgCache` grows unboundedly, potential memory leak with many distinct conditions.
**Fix**:
- [x] Implement FIFO cache with max size (1000 entries)
- [x] Simple eviction: remove oldest when over limit
- [x] Added MaxCacheSize constant

#### 8.7 Factory.Close() Empty Implementation âœ…
**File**: `internal/trigger/engine/factory.go`
**Issue**: Does not close any resources (e.g., NATS connection ownership unclear).
**Fix**:
- [x] Document ownership: Factory does NOT own NATS connection (caller manages)
- [x] Add comment clarifying this design decision

### ðŸŸ¡ Low Priority (P2)

#### 8.8 Timeout Defaults Scattered âœ…
**Files**: `engine.go`, `consumer.go`, `worker.go`
**Issue**: Multiple hardcoded timeout defaults (10s, 10s, 5s) spread across files.
**Fix**:
- [x] Create `internal/trigger/types/defaults.go` with constants:
  - `DefaultTaskTimeout = 10 * time.Second`
  - `DefaultHTTPTimeout = 5 * time.Second`
- [x] Reference constants from engine.go (others can be updated incrementally)

#### 8.9 Consumer Graceful Shutdown Incomplete
**File**: `internal/trigger/internal/pubsub/consumer.go`
**Issue**: On shutdown, channels are closed immediately without waiting for in-flight messages.
**Fix**:
- [ ] Add drain period before closing channels
- [ ] Or use `sync.WaitGroup` to track in-flight processing
- [ ] Add configurable shutdown timeout
**Note**: Deferred to future iteration - requires careful design to avoid deadlocks

#### 8.10 URL Validation Incomplete âœ…
**File**: `internal/trigger/validation.go`
**Issue**: Only checks URL is non-empty, not that it's a valid URL.
**Fix**:
- [x] Add `url.Parse()` validation
- [x] Ensure scheme is http or https
- [x] Add test cases for invalid URLs

#### 8.11 Evaluator Collection Match on Delete Events âœ…
**File**: `internal/trigger/internal/evaluator/evaluator.go`
**Issue**: Collection matching only checks `event.Document`, but delete events may only have `Before`.
**Fix**:
- [x] Check `event.Before.Collection` if `event.Document` is nil
- [x] Add test for delete event matching

### Implementation Order

1. **Phase 1 (P0)**: 8.1, 8.2, 8.3 - Critical fixes âœ…
2. **Phase 2 (P1)**: 8.4, 8.5, 8.6, 8.7 - Robustness improvements âœ…
3. **Phase 3 (P2)**: 8.8, 8.9, 8.10, 8.11 - Polish & cleanup (8.9 deferred)

### Acceptance Criteria

- [x] All P0 items completed and tested
- [x] All P1 items completed and tested
- [x] Test coverage remains >= 79% for all trigger packages (actual: 79.8%+)
- [x] No new linter warnings introduced

## Status Log
