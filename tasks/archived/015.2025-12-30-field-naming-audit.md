# Field Naming Consistency Audit

Date: December 30, 2025
Status: Completed
Scope: Audit and fix field naming inconsistencies across codebase, docs, SDK, and examples.
Depends On: None (can be done independently)

## Design Documents

| Doc | Path | Description |
| --- | ---- | ----------- |
| Field Naming | [002_field_naming.md](../docs/design/server/002_field_naming.md) | **Single source of truth** for field names |

## Goals

- Ensure all field names in code match the canonical definitions
- Ensure all documentation uses consistent terminology
- Ensure SDK and examples align with server-side naming
- Document any intentional differences with clear rationale

---

## Identified Issues

### Priority 1: High Severity (Must Fix)

| # | File | Line | Field | Current | Expected | Impact |
| - | ---- | ---- | ----- | ------- | -------- | ------ |
| 1 | `internal/storage/types/types.go` | 19 | User.TenantID | `json:"tenant_id"` | `json:"tenantId"` | API response format |
| 2 | `internal/storage/types/types.go` | 23 | User.CreatedAt | `bson:"createdAt"` | `bson:"created_at"` | MongoDB schema |
| 3 | `internal/storage/types/types.go` | 24 | User.UpdatedAt | `bson:"updatedAt"` | `bson:"updated_at"` | MongoDB schema |
| 4 | `internal/identity/types/types.go` | 28 | Claims.TenantID | `json:"tid"` | `json:"tid"` | **Keep tid/oid (documented exception)** |
| 5 | `internal/identity/types/types.go` | 29 | Claims.UserID | `json:"oid"` | `json:"oid"` | **Keep tid/oid (documented exception)** |
| 6 | `internal/identity/types/types.go` | 81 | Authenticated.UID | `json:"uid"` | `json:"userId"` | Auth context |

### Priority 2: Medium Severity (Should Fix)

| # | File | Line | Field | Current | Expected | Impact |
| - | ---- | ---- | ----- | ------- | -------- | ------ |
| 7 | `internal/trigger/types/types.go` | 62 | DeliveryTask.DocKey | `json:"docKey"` | `json:"documentId"` | Trigger events |
| 8 | `internal/storage/types/types.go` | 214 | ReplicationPushChange.BaseVersion | `json:"base_version"` | `json:"baseVersion"` | Replication API |

### Priority 3: Low Severity (Nice to Fix)

| # | File | Lines | Issue | Suggestion |
| - | ---- | ----- | ----- | ---------- |
| 9 | `docs/design/server/004_restful_api.md` | 29,74,87,99 | `{docID}` placeholder | Clarify as `{id}` |
| 10 | `docs/design/server/001_architecture.md` | 250,252-254 | `{docID}` placeholder | Clarify as `{id}` |

---

## Phase 1: Fix Storage Types

Fix field naming in `internal/storage/types/types.go`.

### Storage Changes

```go
// User struct - Line 19
// Before:
TenantID string `json:"tenant_id" bson:"tenant_id"`
// After:
TenantID string `json:"tenantId" bson:"tenant_id"`

// User struct - Lines 23-24
// Before:
CreatedAt time.Time `json:"createdAt" bson:"createdAt"`
UpdatedAt time.Time `json:"updatedAt" bson:"updatedAt"`
// After:
CreatedAt time.Time `json:"createdAt" bson:"created_at"`
UpdatedAt time.Time `json:"updatedAt" bson:"updated_at"`

// ReplicationPushChange - Line 214
// Before:
BaseVersion *int64 `json:"base_version"`
// After:
BaseVersion *int64 `json:"baseVersion"`
```

### Storage Acceptance Criteria

- [ ] User.TenantID JSON tag changed to `tenantId`
- [ ] User.CreatedAt BSON tag changed to `created_at`
- [ ] User.UpdatedAt BSON tag changed to `updated_at`
- [ ] ReplicationPushChange.BaseVersion JSON tag changed to `baseVersion`
- [ ] All unit tests pass
- [ ] Integration tests pass

---

## Phase 2: Fix Identity Types

Fix field naming in `internal/identity/types/types.go`.

### Identity Changes

```go
// Claims struct - Lines 28-29
// Keep:
TenantID string `json:"tid"`
UserID   string `json:"oid"`

// Authenticated struct - Line 81
// Before:
UID interface{} `json:"uid"`
// After:
UID interface{} `json:"userId"`
```

### Compatibility Note

**JWT Token Format**: Keep `tid`/`oid` in claims to avoid breaking existing tokens and integrations. No migration to `tenantId`/`userId` is planned.

### Identity Acceptance Criteria

- [ ] Claims struct keeps `tid`/`oid` (documented exception)
- [ ] Authenticated struct uses standard field names
- [ ] All auth tests pass

---

## Phase 3: Fix Trigger Types

Fix field naming in `internal/trigger/types/types.go`.

### Trigger Changes

```go
// DeliveryTask struct - Line 62
// Before:
DocKey string `json:"docKey"`
// After:
DocumentID string `json:"documentId"`
```

### Trigger Acceptance Criteria

- [ ] DeliveryTask uses `DocumentID` / `documentId`
- [ ] All trigger tests pass

---

## Phase 4: Fix Documentation

Update documentation to use consistent terminology.

### Files to Update

- `docs/design/server/001_architecture.md` - Change `{docID}` to `{id}`
- `docs/design/server/004_restful_api.md` - Change `{docID}` to `{id}`

### Documentation Acceptance Criteria

- [ ] All path parameters use consistent naming
- [ ] No undefined placeholders in API docs

---

## Documented Exceptions (Not Issues)

The following are intentional differences, documented in 002_field_naming.md:

| Context | Field | JSON Key | Reason |
| ------- | ----- | -------- | ------ |
| Puller NormalizedEvent | TenantID | `tenant` | Bandwidth optimization |
| Puller NormalizedEvent | DocumentID | `documentId` | Distinguish from eventId |
| MongoDB change stream | documentKey | `documentKey` | MongoDB native format |
| JWT Claims | TenantID/UserID | `tid`/`oid` | Backward compatibility |

---

## Testing Checklist

- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] API responses match expected format
- [ ] JWT tokens validate correctly
- [ ] Replication endpoints work
- [ ] Trigger delivery works

---

## Risks

| Risk | Mitigation |
| ---- | ---------- |
| JWT token invalidation | Keep `tid`/`oid` in claims to avoid format changes |
| MongoDB schema change | Run migration script for BSON field renames |
| API breaking change | Document in changelog, version if needed |

---

## Status Log

- 2025-12-30: Task created with audit results
- 2025-12-30: Confirmed naming rules: BSON=snake_case, JSON=camelCase

---

## References

- [Field Naming Conventions](../docs/design/server/002_field_naming.md) - Single source of truth
