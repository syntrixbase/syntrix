# Task 029: Streamer Interface Refactor

**Date**: 2026-01-05
**Status**: Done
**Scope**: internal/streamer
**Depends On**: Task 028 (Streamer Design Alignment)

---

## Problems

### 1. Proto 污染接口层
```go
// ❌ 当前：接口层直接使用 proto 类型
type Client interface {
    Subscribe(ctx context.Context, req *pb.SubscribeRequest) (*pb.SubscribeResponse, error)
    Events() <-chan *pb.EventDelivery
}
```

Proto 是传输层协议，不应该出现在业务接口中。

### 2. 构造函数暴露实现类型
```go
// ❌ 当前：暴露具体实现
func NewClient(config ClientConfig, logger *slog.Logger) *StreamerClient
func NewService(config ServiceConfig, logger *slog.Logger) (*StreamerService, error)
```

应该返回接口，隐藏实现细节。

---

## Solution

### 1. 定义领域类型 (types.go)

```go
// Filter 是结构化的过滤条件
type Filter struct {
    Field string
    Op    string   // eq, ne, gt, lt, gte, lte, in, contains
    Value any
}

// SubscribeRequest 订阅请求
type SubscribeRequest struct {
    SubscriptionID string
    Database         string
    Collection     string
    Filters        []Filter
}

// SubscribeResponse 订阅响应
type SubscribeResponse struct {
    SubscriptionID string
    Success        bool
    Error          string
}

// Event 事件
type Event struct {
    EventID    string
    Database     string
    Collection string
    DocumentID string
    Operation  OperationType
    Document   *storage.StoredDoc // 使用已有的 Document 类型
    Timestamp  int64
}

// EventDelivery 事件投递
type EventDelivery struct {
    SubscriptionIDs []string
    Event           *Event
}

type OperationType int
const (
    OperationUnspecified OperationType = iota
    OperationInsert
    OperationUpdate
    OperationDelete
)
```

### 2. 更新接口 (interface.go)

```go
type Client interface {
    Subscribe(ctx context.Context, req *SubscribeRequest) (*SubscribeResponse, error)
    Unsubscribe(ctx context.Context, subscriptionID string) error
    Events() <-chan *EventDelivery
    Close() error
}
```

### 3. 构造函数返回接口

```go
func NewClient(config ClientConfig, logger *slog.Logger) Client
func NewService(config ServiceConfig, logger *slog.Logger) (Service, error)
```

### 4. 实现类型改为私有

```go
type streamerClient struct { ... }  // 小写
type streamerService struct { ... } // 小写
```

### 5. Proto ↔ Domain 转换

在 gRPC 层和 client.go 内部处理转换，对外只暴露领域类型。

---

## Execution Plan

1. ✅ 创建 `types.go` 定义领域类型
2. ✅ 添加 `convert.go` 处理 proto ↔ domain 转换
3. ✅ 更新 `interface.go` 使用领域类型，添加 EventProcessor 接口
4. ✅ 更新 `service.go`：重命名为 `streamerService`，返回接口
5. ✅ 更新 `client.go`：重命名为 `streamerClient`，返回接口
6. ✅ 更新 `puller_integration.go` 使用 EventProcessor 接口
7. ✅ 更新测试

---

## Success Criteria

- [x] interface.go 不 import proto 包（仅 import events 用于 EventProcessor）
- [x] NewClient 返回 Client 接口
- [x] NewService 返回 Service 接口
- [x] StreamerClient/StreamerService 不可从包外访问（改为 streamerClient/streamerService）
- [x] 所有测试通过
