# Task 033: Unified gRPC Server Migration

**Created**: 2026-01-08
**Status**: Completed

## Objective

Migrate Puller and Streamer services to use the unified gRPC server (`internal/server`), eliminating separate gRPC server instances for architectural consistency and simplified port management.

## Background

Currently, the codebase has multiple gRPC server implementations:

| Service | Current State | Target State |
|---------|---------------|--------------|
| Query | ✅ Uses unified server (`server.Default()`) | No change |
| Puller | ❌ Independent gRPC server | Migrate to unified server |
| Streamer | ❌ Not exposed via gRPC | Register with unified server |

The unified server (`internal/server/service.go`) provides:
- Single HTTP port for REST API and health checks
- Single gRPC port for all internal services
- Centralized lifecycle management (Start/Stop)
- Unified interceptors for logging, metrics, etc.

## Benefits

1. **Simplified Configuration**: Single gRPC port instead of multiple
2. **Unified Lifecycle**: All services start/stop together
3. **Consistent Interceptors**: Logging, metrics, auth applied uniformly
4. **Easier Deployment**: Fewer ports to expose and manage
5. **Better Testing**: Unified mock server for integration tests

## Files to Modify

### Puller Migration

| File | Change |
|------|--------|
| `internal/puller/internal/grpc/server.go` | Remove standalone server logic, keep service implementation |
| `internal/puller/interface.go` | Add `NewGRPCServer()` factory returning `pb.PullerServiceServer` |
| `internal/services/manager_init.go` | Register Puller with `server.Default().RegisterGRPCService()` |
| `internal/puller/config/puller.go` | Remove GRPC address config (use unified port) |

### Streamer Migration

| File | Change |
|------|--------|
| `internal/streamer/service.go` | Already implements `pb.StreamerServiceServer` |
| `internal/streamer/interface.go` | Add `NewGRPCServer()` factory if needed |
| `internal/services/manager_init.go` | Register Streamer with `server.Default().RegisterGRPCService()` |

### Files to Delete

| File | Reason |
|------|--------|
| `internal/puller/internal/grpc/server.go` standalone parts | Replaced by unified registration |

## Tasks

### Phase 1: Puller Migration

- [ ] **1.1** Refactor `internal/puller/internal/grpc/server.go`
  - Extract gRPC service implementation from server lifecycle
  - Create `Server` struct that only implements `pb.PullerServiceServer`
  - Move `Start()`, `Stop()`, listener management to unified server

- [ ] **1.2** Update `internal/puller/interface.go`
  - Add `NewGRPCServer(cfg Config, eventSource EventSource, logger *slog.Logger) pb.PullerServiceServer`
  - Keep `NewService()` for local usage

- [ ] **1.3** Update `internal/services/manager_init.go`
  - Replace `puller.NewGRPCServer()` with service registration
  - Use `server.Default().RegisterGRPCService(&pb.PullerService_ServiceDesc, pullerServer)`

- [ ] **1.4** Update Puller client configuration
  - Client should connect to unified gRPC port
  - Update `internal/streamer/service.go` Puller client address

- [ ] **1.5** Update tests
  - Adjust integration tests for unified server
  - Remove standalone server tests if obsolete

### Phase 2: Streamer Migration

- [ ] **2.1** Update `internal/streamer/interface.go`
  - Ensure `StreamerServer` can be registered with gRPC server
  - Add factory function if needed

- [ ] **2.2** Update `internal/services/manager_init.go`
  - Register Streamer with `server.Default().RegisterGRPCService()`
  - Enable gRPC access for distributed deployments

- [ ] **2.3** Create Streamer gRPC client (optional)
  - For distributed mode where Gateway and Streamer are separate
  - Similar pattern to Query and Puller clients

### Phase 3: Configuration Cleanup

- [ ] **3.1** Update `internal/config/config.go`
  - Remove `Puller.GRPC.Address` (use `Server.GRPCPort`)
  - Update default configuration

- [ ] **3.2** Update configuration documentation
  - Update sample configs
  - Document unified port usage

### Phase 4: Testing and Validation

- [ ] **4.1** Run all tests
  - `make test`
  - `make coverage`

- [ ] **4.2** Integration testing
  - Test distributed mode with unified gRPC server
  - Verify Puller subscription works
  - Verify Streamer (if exposed) works

- [ ] **4.3** Verify backwards compatibility
  - Existing Puller clients should work with unified server

## Reference Implementation

Query service migration (already completed):

```go
// internal/services/manager_init.go
func (m *Manager) initQueryGRPCServer(service query.Service) {
    grpcServer := query.NewGRPCServer(service)
    server.Default().RegisterGRPCService(&pb.QueryService_ServiceDesc, grpcServer)
    log.Println("Registered Query Service (gRPC)")
}
```

## Acceptance Criteria

- [ ] Puller service registered with unified gRPC server
- [ ] Streamer service registered with unified gRPC server (for distributed mode)
- [ ] Single gRPC port serves all services
- [ ] Puller client connects to unified port
- [ ] All tests pass (`make test`)
- [ ] Coverage maintained or improved
- [ ] Standalone mode still works (services run in-process)
- [ ] Distributed mode works (services communicate via unified gRPC)

## Notes

- The unified server already supports gRPC reflection (`cfg.EnableReflection`)
- Interceptors can be added later for cross-cutting concerns
- Consider adding health check gRPC service in future
