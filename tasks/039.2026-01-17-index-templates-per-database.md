# Index Templates Per-Database Configuration

Date: January 17, 2026
Status: Completed
Scope: Refactor index templates configuration to support per-database separation with directory-based loading.

## Background

Currently, index templates are loaded from a single YAML file (`config/index_templates.yaml`). This design limits flexibility when managing templates across multiple databases.

## Goals

- Support per-database index template configuration
- Allow splitting large configurations across multiple files
- Detect and reject conflicting template definitions at startup

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Configuration structure | Directory-based (`config/index_templates/`) | Allows multiple files, better organization |
| Database identification | `database` field in YAML (authoritative) | Explicit declaration, file name is just for maintainability |
| Multi-file support | Same database can span multiple files | Flexibility for large configurations |
| Conflict handling | Reject on duplicate `(database, name)` | Fail-fast, prevent silent overwrites |

## New Configuration Format

**Directory structure:**
```
config/
  index_templates/
    orch.yml              # database: orch
    orch-extra.yml        # database: orch (same db, additional templates)
    analytics.yml         # database: analytics
```

**YAML shape:**
```yaml
database: orch
templates:
  - name: chats_by_name_age
    collectionPattern: users/{uid}/chats
    fields:
      - { field: name, order: asc }
      - { field: age, order: desc }
```

## Implementation Tasks

### 1. Update Template Config Struct
- [x] Add `Database` field to `template.Config` struct
- File: `internal/indexer/template/template.go`

```go
// Before
type Config struct {
    Templates []Template `yaml:"templates"`
}

// After
type Config struct {
    Database  string     `yaml:"database"`
    Templates []Template `yaml:"templates"`
}
```

### 2. Implement Directory Loading
- [x] Add `LoadFromDir(dirPath string) (map[string][]Template, error)` function
- [x] Scan all `.yml` files in directory
- [x] Parse each file and group templates by database
- [x] Merge templates from multiple files for same database
- File: `internal/indexer/template/template.go`

### 3. Implement Conflict Detection
- [x] Detect duplicate `(database, name)` tuples across all files
- [x] Return error with clear message indicating which files conflict
- [x] Fail startup if conflicts detected
- File: `internal/indexer/template/template.go`

### 4. Update Manager
- [x] Modify `Manager.LoadTemplates()` to use directory loading
- [x] Store templates per-database in manager
- File: `internal/indexer/manager/manager.go`

### 5. Update Default Config
- [x] Change default `TemplatePath` from `config/index_templates.yaml` to `config/index_templates/`
- File: `internal/indexer/config/config.go`

### 6. Update Tests
- [x] Add tests for directory loading
- [x] Add tests for multi-file merging (same database)
- [x] Add tests for conflict detection
- [x] Update existing tests to use new format
- Files: `internal/indexer/template/template_test.go`, `internal/indexer/manager/manager_test.go`

### 7. Migration
- [x] Create new directory structure: `config/index_templates/`
- [x] Create example file: `config/index_templates/default.example.yml`
- [x] Remove old file: `config/index_templates.example.yml`
- [x] Update design doc: `docs/design/server/indexer/02.index.md`

## Files to Modify

| File | Changes |
|------|---------|
| `internal/indexer/template/template.go` | Add Database field, LoadFromDir function, conflict detection |
| `internal/indexer/template/template_test.go` | Add directory loading and conflict tests |
| `internal/indexer/manager/manager.go` | Update LoadTemplates to use directory loading |
| `internal/indexer/manager/manager_test.go` | Update tests for new loading logic |
| `internal/indexer/config/config.go` | Update default TemplatePath |
| `internal/indexer/service.go` | May need updates for per-database template access |

## Testing Strategy

1. **Unit tests**: Directory scanning, YAML parsing, conflict detection
2. **Integration tests**: Full loading pipeline with multiple files
3. **Error cases**: Missing directory, invalid YAML, duplicate templates

## Rollback Plan

If issues arise, revert to single-file loading by:
1. Reverting code changes
2. Restoring `config/index_templates.example.yml`

## Changelog

### 2026-01-17 (Final)
- Removed backward compatibility for single-file format
- `LoadTemplates(path)` method removed from Manager
- `service.Start()` now only supports directory-based template loading
- Updated all tests to use new directory format:
  - `internal/indexer/service_test.go`
  - `internal/indexer/manager/manager_test.go`
  - `internal/indexer/integration_test.go`
  - `tests/integration/main_test.go`
  - `tests/integration/standalone/standalone_test.go`
