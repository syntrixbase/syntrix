# Puller Design Alignment

**Date:** December 31, 2025
**Status:** Completed
**Scope:** Align Puller implementation with design docs (progress replay, coalescing, checkpointing, gap recovery, merged ordering).
**Depends On:** [016.2025-12-29-change-stream-puller.md](016.2025-12-29-change-stream-puller.md)

## Design Documents

| Doc | Path | Description |
| --- | ---- | ----------- |
| Puller Architecture | [001.architecture.md](../docs/design/server/puller/001.architecture.md) | Canonical schema, event flow, gRPC contract |
| Puller Design Details | [002.design-details.md](../docs/design/server/puller/002.design-details.md) | Progress marker, checkpointing, coalescing, buffer |

## Goals

- Implement replay from `after` progress markers (buffer scan per backend) with catch-up detection/coalescing and merged ordering.
- Preserve reliability: atomic checkpointing, gap detection/recovery wired into ingestion, and true fan-out without loss/backpressure handling.
- Enforce buffer guardrails: retention + max size; honor bootstrap modes when starting change streams.
- Align protocol/schema: progress marker encoding per spec, normalized events (timestamp source, backend dimension, flattening stance), and checkpoint backend contract (doc vs code).
- Ensure test coverage and black-box gRPC replay/coalescing paths.

## Current Gaps Summary

- `after` markers parsed but unused for replay/filtering; no merged ordering for multi-backend replay.
- Catch-up config unused; coalescing not applied during replay/live catch-up.
- Progress marker encoding uses StdEncoding and ignores invalid input; client/server not aligned to spec.
- gRPC uses shared channel (load-balancing) and drops on full; true fan-out/backpressure not implemented.
- Checkpointing only in Pebble; policy batching/shutdown flush present but bootstrap mode not honored; checkpoint backend contract diverges from docs (mongodb/etcd vs pebble-only).
- Gap detection exists but not wired into ingestion with recovery actions.
- Buffer guardrails missing: `MaxSize` unused, cleaner not started from core (risk无限增长).
- Normalization deviates: nested documents kept, timestamp uses wall clock not change-stream time, event IDs lack backend dimension (collision risk), flattening stance undocumented.
- Backpressure/circuit breaker behaviors only in design; client payload decode expectations unclear.

## Implementation Plan

- [x] **1) Replay + Ordering**
  - Implement per-backend replay from `after`; enforce merged ordering (clusterTime + backend tie-break) and honor empty marker semantics.

- [x] **2) Catch-up + Coalescing**
  - Detect lag via `EventsBehind`; coalesce during replay/catch-up when enabled; bypass near head.

- [x] **3) Progress Marker Contract**
  - Switch to `base64.RawURLEncoding`, validate `after`, and keep client/server in sync.

- [x] **4) Fan-out Architecture**
  - Replace shared channel with broadcast/fan-out, no drops.

- [x] **5) Backpressure & Circuit Breaker**
  - Implement comprehensive backpressure and circuit breaker mechanisms (including gRPC layer).

- [x] **6) Checkpoint & Bootstrap**
  - Batch checkpoint with events, flush on shutdown, honor bootstrap modes; reconcile checkpoint backend choice with docs/config.

- [x] **7) Gap Detection & Recovery**
  - Wire detector into ingestion; emit logs and define recovery (pause/rebuild) actions.

- [x] **8) Buffer Guardrails**
  - Enforce retention and max size (start cleaner from core, add eviction/limits).

- [x] **9) Normalization & Schema**
  - Clarify/implement flattening stance; use change-stream time for timestamp; add backend dimension to event IDs; document client payload decode expectations.

- [x] **10) Testing**
  - Unit tests (normalizer, checkpoint batching, replay/coalescing, progress marker, fan-out, gap); black-box gRPC replay/coalescing.
  - Unit tests (normalizer, checkpoint batching, replay/coalescing, progress marker, fan-out, gap); black-box gRPC replay/coalescing.

## Migration Guidance

- Existing consumers can keep storing `progress` unchanged.
- If ordering changes, ensure consumers rely on `clusterTime` for idempotency.
- For HA, document the local-checkpoint behavior per instance and consumer idempotency expectations.

## Unit Test Guidance

- Use `github.com/stretchr/testify` for all new unit tests.
- Replay path: buffer scan from `after` per backend (including empty marker).
- Catch-up detection: threshold boundaries, coalescing rules, and bypass mode.
- Progress marker: encode/decode, invalid input handling.
- Checkpointing: batch writes include checkpoint key, shutdown save.
- Fan-out delivery: multiple subscribers each receive full event stream.
- Merged ordering: cross-backend ordering correctness under interleaving.
- Gap detection: gap vs non-gap scenarios.

## Integration Test Guidance

- Use black-box gRPC API only (no direct internal component calls).
- Test: publish events -> subscribe with `after` -> verify replay + progress update.
