# Puller Unit Test Coverage

**Date:** January 1, 2026
**Status:** Completed
**Scope:** `internal/puller`
**Depends On:** [020.2025-12-31-puller-design-alignment.md](020.2025-12-31-puller-design-alignment.md)

## Context

We have implemented a sophisticated **Unified Adaptive Consumption Model** (Live/Catch-up switching) and robust flow control mechanisms. To ensure the stability of these critical paths, we need comprehensive unit tests that go beyond the current integration tests.

## Goals

- Achieve high test coverage for `internal/puller/internal/grpc` and `internal/puller/internal/core`.
- Verify complex state transitions in the Subscriber state machine.
- Ensure deduplication and overflow handling work exactly as designed.
- Validate backpressure and recovery logic in isolation.

## Implementation Plan

### 1. Subscriber Logic Tests (`internal/puller/internal/grpc`)

Target file: `subscriber_test.go`

- [x] **Deduplication (`ShouldSend`)**
  - Test with `ClusterTime` < `lastSent`: Should return `false`.
  - Test with `ClusterTime` == `lastSent`: Should return `false`.
  - Test with `ClusterTime` > `lastSent`: Should return `true`.
  - Test with new backend (no history): Should return `true`.
  - **Boundary**: Test with zero/empty ClusterTime.
  - **Boundary**: Test with max int64 ClusterTime.

- [x] **Progress Marker Handling**
  - Test `DecodeProgressMarker` with empty string (should return empty marker).
  - Test `DecodeProgressMarker` with invalid Base64.
  - Test `DecodeProgressMarker` with valid Base64 but invalid JSON.
  - Test `Encode` with nil/empty marker.

- [x] **Overflow Handling**
  - Test `SetOverflow` and `GetAndResetOverflow` atomicity.
  - Verify `GetAndResetOverflow` returns `true` only once after being set.
  - **Concurrency**: Multiple goroutines calling `SetOverflow` vs one reading.

- [x] **SubscriberManager**
  - Test `Broadcast` to multiple subscribers.
  - Test `Broadcast` when channel is full: Verify `SetOverflow` is called, no panic, no blocking.
  - Test `Add`/`Remove`/`CloseAll` lifecycle.
  - **Race**: Add/Remove while Broadcasting.
  - **Config**: Verify `ChannelSize` config is respected. Set `ChannelSize=1` to easily trigger overflow in tests.

### 2. gRPC Server Logic Tests (`internal/puller/internal/grpc`)

Target file: `server_test.go` (Requires mocking `EventSource` and `PullerService_SubscribeServer`)

- [x] **State Machine Transitions**
  - **Scenario A: Happy Path**: Replay finishes -> Switch to Live -> Receive events.
  - **Scenario B: Replay Overflow**: Replay finishes -> Overflow detected -> Re-enter Replay -> Switch to Live. (Use `ChannelSize=1`)
  - **Scenario C: Live Downgrade**: Live mode -> Channel overflow -> Switch to Catch-up -> Replay -> Switch back to Live. (Use `ChannelSize=1`)
  - **Scenario D: Deduplication**: Verify events overlapping between Replay and Live are filtered.

- [x] **Boundary & Error Conditions**
  - **Empty Replay**: `Replay` returns no events -> Immediate switch to Live.
  - **Immediate Cancel**: Context cancelled before Replay starts.
  - **Mid-stream Cancel**: Context cancelled during Replay or Live wait.
  - **Send Error**: `stream.Send` returns error -> Should terminate subscription and loop.
  - **Invalid Marker**: Subscribe with malformed `after` token -> Should return InvalidArgument.

### 3. Puller Core Tests (`internal/puller/internal/core`)

Target file: `puller_test.go`

- [x] **Recovery Integration**
  - Mock `ChangeStream` error.
  - Verify `recovery.Handler` is invoked.
  - Verify `Restart`/`Reconnect` actions are executed (mocked).

- [x] **Backpressure Integration**
  - Mock `EventHandler` latency.
  - Verify `BackpressureMonitor` triggers `SlowDown`/`Pause`.
  - Verify `Sleep` is called (using a clock mock or checking duration).

### 4. Data Processing Tests (`internal/puller/internal/core`)

Target files: `normalizer_test.go`, `gap_detector_test.go`, `coalescer_test.go`

- [x] **Event Normalizer**
  - Test `Normalize` with various MongoDB change stream event types (insert, update, delete, replace).
  - Test flattening of nested documents (dot notation).
  - Test metadata extraction (tenant, collection, timestamp).
  - Test handling of malformed events.

- [x] **Gap Detector**
  - Test `RecordEvent` with continuous sequence.
  - Test `RecordEvent` with discontinuous sequence (gap detection).
  - Test gap reporting mechanism.

- [x] **Coalescer**
  - Test coalescing of multiple updates to the same document ID.
  - Test that inserts/deletes break coalescing chains correctly.
  - Test coalescing window/buffer limits.

### 5. Storage Tests (`internal/puller/internal/storage`)

Target file: `buffer_test.go`

- [x] **PebbleDB Buffer**
  - Test `Write` atomicity: Event and Checkpoint must be committed together.
  - Test `LoadCheckpoint`: Verify correct retrieval of the last saved token.
  - Test `ScanFrom`: Verify range scans return events in correct order.
  - Test `ScanFrom` with inclusive/exclusive bounds.
  - Test `Cleaner`: Verify old events are deleted based on retention policy.
  - Test `Close`: Verify resources are released.

### 6. Comprehensive Integration Tests (`tests/integration/puller`)

Target file: `tests/integration/puller/full_cycle_test.go` (Real MongoDB + Real Pebble + Real gRPC)

- [x] **Data Integrity & Ordering**
  - **Scenario**: Ingest 10,000 events -> Subscribe from beginning.
  - **Verify**: Receive exactly 10,000 events, strictly ordered by ClusterTime, no duplicates.

- [x] **Resilience & Recovery**
  - **Scenario**: Kill/Restart MongoDB container mid-stream.
  - **Verify**: Puller logs error, retries, and resumes ingestion without data loss once MongoDB is back.

- [x] **Slow Consumer Simulation**
  - **Scenario**: Start a subscriber that sleeps 10ms per event (slower than ingestion).
  - **Verify**:
    - Server logs "switching to catchup".
    - Subscriber eventually receives all data (no gaps).
    - Memory usage on server remains stable (bounded by channel size).

- [x] **Restart Persistence**
  - **Scenario**: Ingest events -> Stop Puller (SIGTERM) -> Restart Puller.
  - **Verify**: Puller resumes from last checkpoint (check logs/metrics), does not re-ingest old events.

## Guidelines

- Use `github.com/stretchr/testify/assert` and `mock`.
- Avoid real MongoDB/Pebble connections; use Interfaces and Mocks.
- Focus on **logic verification**, not just "it runs".
- Ensure no race conditions in tests (run with `-race`).
