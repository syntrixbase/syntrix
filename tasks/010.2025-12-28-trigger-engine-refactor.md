# Trigger Engine Refactor & Factory Wiring

Date: 2025-12-28
Status: Planned
Scope: Trigger engine + factory/interfaces, watcher/checkpoint, publisher/consumer hashing & validation, worker/auth/signature, observability, migration/testing
Reference Design: docs/design/server/trigger/000_requirements.md; 001_architecture.md; 002_interfaces.md; docs/design/server/trigger/README.md; docs/design/server/trigger/architecture.md

## Objectives

- Introduce `TriggerFactory` + `TriggerEngine` with error-returning `LoadTriggers`, enforcing tenant/collection/docKey validation and fail-fast startup.
- Encapsulate watch/checkpoint logic in a `DocumentWatcher` adapter with tenant-scoped checkpoints, context-aware cancellation, and explicit start-from-now opt-in + audit signal.
- Enforce subject-safe publishing (base64url docKey, NATS length guard with hash fallback) and consumer partitioning/idempotency keyed by decoded docKey, not hashed segment.
- Strengthen worker HTTP path (configurable timeout/client, tenant-scoped secret/token retrieval, signature header) and retry/backoff parity with design.
- Add observability for publish/consume/worker success, retries, latency, hash-path traffic (`subjectHashed`), collisions, and checkpoint resets.
- Provide migration guidance/tests so callers handle `LoadTriggers` errors and new validation behaviors.

## Plan / Milestones

- M1 Interfaces & Factory
  - Define `TriggerFactory` and `TriggerEngine` interfaces; implement factory wiring of evaluator, watcher, publisher, consumer, worker with injected deps (storage, NATS JS, AuthN, HTTP client opts, config).
  - Change `LoadTriggers(triggers []*Trigger) error`; fail-fast on tenant/collection/docKey validation and config mismatches.
  - Add config structs for trigger (NATS stream/consumer names, worker pool size, backoff defaults, timeouts, subject hashing toggle, validation limits, include/exclude collections).

- M2 Validation & Loader
  - Update `LoadTriggersFromFile` to validate tenant/collection charset/length and docKey subject-safe encoding (base64url, forbid `.` `*` `>`); reject on mismatch.
  - Add docKey encoder/decoder + NATS length guard (hash fallback using SHA-256 hex trunc 32) returning flags for payload/metrics.
  - Ensure loader enforces tenant match between config scope and trigger definitions.

- M3 Watcher & Checkpoints
  - Extract `DocumentWatcher` adapter wrapping storage.Watch; tenant-scoped checkpoint keys `sys/checkpoints/trigger_evaluator/<tenant>[/<collection>]` with include/exclude filters.
  - Implement ctx-aware watch loop with timeouts, error propagation, and optional start-from-now that emits audit/metric; batch or async checkpoint saves if needed.

- M4 Publisher & Consumer
  - Publisher builds subjects with encoded docKey + hash fallback, sets `subjectHashed` flag, and tags metrics; validates tenant/collection.
  - Consumer filters `triggers.>` on shared stream, partitions by decoded docKey (payload), not subject segment; detect hash collisions and apply defined handling (serialize/alert/fail) with metrics.
  - Retain retry/backoff logic; ensure MaxAttempts/InitialBackoff/MaxBackoff honored; expose retry metrics and hash-path ratios.

- M5 Worker & Auth/Signature
  - Inject HTTP client with configurable timeout; fetch secret via tenant-scoped SecretManager and sign payload; generate tenant-scoped system token via AuthN.
  - Treat 4xx as fatal (non-retry) and 5xx/network as retryable per policy; expose status metrics.

- M6 Observability & Telemetry
  - Counters/histograms: publish/consume/worker success, retries, E2E latency (tenant, collection, subjectHashed). Collision counter and hash-path percentage.
  - Audit record when start-from-now used; logs for LoadTriggers validation failures with tenant/triggerId context.

- M7 Migration & Tests
  - Callers: update startup to handle `LoadTriggers` error (fail/exit or mark unhealthy). Document defaults for new config flags.
  - Tests (testify): loader validation (tenant/collection/docKey), encoder/decoder + length guard + hash flag, watcher checkpoint scope and start-from-now audit, publisher subject format + hash flag, consumer partitioning uses decoded docKey, collision handling, worker HTTP retries/auth/signature.

## Deliverables

- New engine/factory implementation with adapters (watcher, publisher, consumer, worker, evaluator wiring) matching design docs.
- Validation utilities for tenant/collection/docKey and subject encoding + hash guard.
- Config structs and wiring for trigger components (NATS, HTTP, retry, hashing, filters).
- Telemetry hooks and audit emission for start-from-now and hash-path metrics.
- Test suite covering validation, hashing, checkpointing, partitioning, retries, and worker auth/signature behavior.

## Risks & Mitigations

- Risk: Caller ignores new LoadTriggers errors → Mitigation: migration guide + startup fail-fast pattern and health checks.
- Risk: Hash fallback collision handling unclear → Mitigation: explicit strategy + metrics/alerts + serialization of colliding keys.
- Risk: Start-from-now used without audit → Mitigation: require explicit flag and emit audit/metric.
- Risk: Secret/token fetch latency/availability → Mitigation: timeouts, retries, and labeled metrics for secret/token errors.

## Open Issues / Follow-ups

- Decide collision handling policy (drop vs serialize vs fail) and alert thresholds.
- Confirm default for start-from-now (disabled by default; require explicit config) and audit sink shape.
- Finalize metric schema and exporter integration points.
- Align with existing NATS provisioning (stream/consumer names) to avoid drift in IaC.
