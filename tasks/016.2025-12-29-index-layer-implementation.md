# Index Layer Implementation

Date: December 29, 2025
Status: Planned
Scope: Implement Data layer, Index layer with btree/OrderKey/templates, and Query execution with index-first + bounded fallback.
Depends On: [014.query-surface-encapsulation](014.2025-12-26-query-surface-encapsulation.md)

## Related Design Documents

| Doc | Path | Description |
|-----|------|-------------|
| Architecture | [001.architecture.md](../docs/design/server/engine/001.architecture.md) | Overall architecture, layering |
| Data Layer | [002.data.md](../docs/design/server/engine/002.data.md) | Data adapters, change stream emission |
| Index Layer | [003.index.md](../docs/design/server/engine/003.index.md) | Index templates, OrderKey encoding, rebuild/WAL |
| Query Layer | [004.query.md](../docs/design/server/engine/004.query.md) | Query planning, index-first + fallback |

## Goals
- Implement Data layer adapter over `storage.DocumentStore` with change stream emission.
- Implement Index layer with in-memory btree, OrderKey encoding, template matching.
- Implement Query execution with index-first path and bounded fallback.
- Add query config block (`fallback_docs_max`, `data_scan_batch`, `query_fetch_batch`).
- Expand `WatchCollection` to support filters and startAfter.

## Prerequisites
- Task 014 completed: `Service` interface and factories in place.
- Concrete types hidden under `internal/engine/internal/`.

## Execution Steps

### 1. Config Expansion
- Add `query` block to `config/config.go`:
  ```go
  Query struct {
      CSPServiceURL    string `yaml:"csp_service_url"`
      Port             int    `yaml:"port"`
      FallbackDocsMax  int    `yaml:"fallback_docs_max"`   // default 500
      DataScanBatch    int    `yaml:"data_scan_batch"`     // default 500
      QueryFetchBatch  int    `yaml:"query_fetch_batch"`   // default 128
  }
  ```
- Update `config/config.yml` with defaults.

### 2. Data Layer
- Create `internal/engine/internal/data/adapter.go`:
  - Wrap `storage.DocumentStore`.
  - Implement `Get`, `BatchGet`, `ScanPrefix`, `Create`, `Update`, `Patch`, `Delete`.
  - Emit change events via channel on write operations.
- Defaults:
  - DataHash: xxhash64 of canonical JSON.
  - Scan batch: 500 docs.
  - Change stream buffer: 10 events.

### 3. Index Layer
- Create `internal/engine/internal/index/`:
  - `manager.go`: Index manager with shard map.
  - `shard.go`: Per-template shard with btree + ByID map.
  - `orderkey.go`: OrderKey encoding/decoding with version byte.
  - `template.go`: Template loading, pattern matching, priority/conflict resolution.
- Interfaces:
  ```go
  type Manager interface {
      Upsert(ctx, evt Event) error
      Delete(ctx, evt Event) error
      Search(ctx, plan Plan) ([]DocRef, error)
      Rebuild(ctx, collection string) error
      Health() Health
  }
  ```
- OrderKey encoding:
  - `[ver:1B][field1...][field2...][id_len:uvarint][id bytes]`
  - Strings: `[len:uvarint][utf8 bytes]` (desc: invert bytes)
  - Numbers: big-endian sortable (desc: invert bytes)
- Template format (YAML):
  ```yaml
  templates:
    - name: chats_by_name_age
      collectionPattern: users/{uid}/chats
      fields:
        - { field: name, order: asc }
        - { field: age,  order: desc }
      includeDeleted: true
  ```

### 4. Query Execution
- Update `internal/engine/internal/engine/engine.go`:
  - Inject Data and Index dependencies.
  - `ExecuteQuery`: index-first path → batch fetch → post-filter.
  - Bounded fallback: if index unavailable and docs ≤ `fallback_docs_max`, allow scan; else return `ErrIndexNotReady`.
- Cursor versioning:
  - Prefix 1-byte version to cursor.
  - On mismatch, return `ErrIndexNotReady`.

### 5. Watch Expansion
- Expand `WatchCollection` signature:
  ```go
  Watch(ctx, tenant, collection string, filters Filters, startAfter string) (<-chan Event, error)
  ```
- Reuse shared filter evaluator for event filtering.

### 6. HTTP/Client Updates
- Map `ErrIndexNotReady` to HTTP 503 with `Retry-After` header.
- Client treats 503 as retriable with backoff.

### 7. Tests (testify)
- Data layer: CAS/conflict, tombstone propagation, change stream ordering.
- Index layer: upsert/delete idempotency, ordering correctness, rebuild from iterator.
- Query layer: index-hit path, fallback bounded behavior, cursor version mismatch.
- Multi-tenant: per-tenant index partitioning, isolation.

## Key Defaults Summary

| Component | Parameter | Value |
|-----------|-----------|-------|
| Data | Scan batch | 500 docs |
| Data | Change stream buffer | 10 events |
| Data | DataHash | xxhash64 |
| Index | Soft lag | 30s or 50k versions |
| Index | Hard lag | 2m or 200k versions |
| Index | Consumer buffer | 100 events |
| Query | Fetch batch | 128 doc refs |
| Query | Fallback doc cap | 500 docs |

## Risks
- Index layer is new code; may have edge cases in OrderKey encoding.
- Rebuild during writes requires WAL/pause strategy.
- Performance impact of in-memory index on large collections.

## Verification
- Unit tests for each layer with testify.
- Integration test: write → index update → query returns correct order.
- Benchmark: query with/without index, fallback path timing.

## Status Log
- 2025-12-29: Task created from 014 dry-run analysis.
