# Change Stream Puller Implementation

Date: December 29, 2025
Status: Planned
Scope: Implement change stream puller with fan-out, checkpointing, backpressure, and JetStream integration.
Depends On: [014.2025-12-26-query-surface-encapsulation.md](014.2025-12-26-query-surface-encapsulation.md)

## Design Documents

| Doc | Path | Description |
| --- | ---- | ----------- |
| Field Naming | [002_field_naming.md](../docs/design/server/002_field_naming.md) | **Single source of truth** for field names |
| Puller Architecture | [001.architecture.md](../docs/design/server/puller/001.architecture.md) | High-level architecture, event schema |
| Puller Design Details | [002.design-details.md](../docs/design/server/puller/002.design-details.md) | Implementation details, configuration, deployment |
| Engine Integration | [007.puller.md](../docs/design/server/engine/007.puller.md) | How Engine consumes from Puller |

## Goals

- Implement change stream puller to reduce load on primary storage
- Fan-out events to index consumers by collection/partition
- Per-consumer checkpointing with external persistence
- Backpressure and lag detection with rebuild triggers
- JetStream integration for durable fan-out

## Prerequisites

- Task 014 completed: Query surface encapsulation provides `storage.Watch()` interface
- NATS server available (embedded for dev, cluster for prod)

---

## Phase 1: Shared Packages

Create shared packages for event types and messaging patterns.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/events/types.go` | `NormalizedEvent`, `OperationType`, `UpdateDescription` types |
| `internal/messaging/subjects.go` | Subject pattern helpers, stream constants |

### Implementation Notes

- Field names MUST match [Field Naming Conventions](../docs/design/server/002_field_naming.md)
- Event schema MUST match [Puller Architecture Section 3](../docs/design/server/puller/001.architecture.md#3-canonical-event-schema)
- Puller uses shorter JSON keys: `tenant` (not `tenantId`), `documentId` (not `id`)
- Operation types are lowercase: `insert`, `update`, `replace`, `delete`

### Acceptance Criteria

- [ ] `NormalizedEvent` struct matches canonical schema
- [ ] `PullerEventSubject(collection, partition)` returns `puller.events.{collection}.{partition}`
- [ ] Unit tests for subject pattern generation
- [ ] Types compile with no errors

---

## Phase 2: Configuration

Add puller configuration block to config system.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/config/puller.go` | `PullerConfig` struct with YAML tags |
| `configs/puller.example.yaml` | Example configuration file |

### Configuration Structure

```yaml
puller:
  jetstream:
    enabled: true
    urls: ["nats://localhost:4222"]
    stream_name: PULLER_EVENTS
    retention: 10m
    replicas: 1

  checkpoint:
    backend: mongodb
    interval: 1s

  partitions:
    default: 1

  backpressure:
    soft_lag: 30s
    hard_lag: 2m

  batching:
    max_size: 256
    max_bytes: 1048576
    max_wait: 50ms

  bootstrap:
    mode: from_now
```

### Acceptance Criteria

- [ ] Config loads from YAML without error
- [ ] Defaults applied for missing fields
- [ ] Validation fails for invalid values (negative durations, etc.)
- [ ] Unit tests for config parsing

---

## Phase 3: Puller Core

Implement the core puller service.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/puller/puller.go` | Main `Puller` struct and `Run()` method |
| `internal/puller/normalizer.go` | Convert MongoDB events to `NormalizedEvent` |
| `internal/puller/partition.go` | `PartitionAssigner` with tenant-aware hashing |
| `internal/puller/checkpoint.go` | `CheckpointStore` interface and MongoDB implementation |

### Implementation Notes

- Use database-level watch (not per-tenant) - see [Design Details Section 3](../docs/design/server/puller/002.design-details.md)
- Partition hash MUST include tenant: `hash(tenantID + "/" + documentID)`
- Single resume token for entire change stream, checkpointed periodically

### Acceptance Criteria

- [ ] Puller connects to MongoDB and receives change events
- [ ] Events normalized to `NormalizedEvent` with correct field mapping
- [ ] Partition assignment is deterministic (same doc → same partition)
- [ ] Checkpoint saved on interval and graceful shutdown
- [ ] Checkpoint loaded on restart, stream resumes correctly
- [ ] Unit tests for normalizer, partitioner, checkpoint store
- [ ] Integration test: MongoDB insert → Puller receives event

---

## Phase 4: JetStream Publishing

Publish events to NATS JetStream.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/puller/publisher.go` | `JetStreamPublisher` with batching |
| `internal/puller/batcher.go` | Event batching with size/time limits |

### Implementation Notes

- Stream config: `LimitsPolicy`, `FileStorage`, 10m retention
- Subject pattern: `puller.events.{collection}.{partition}`
- Batch: max 256 events OR 1MB OR 50ms wait

### Acceptance Criteria

- [ ] Stream created on startup if not exists
- [ ] Events published to correct subjects
- [ ] Batching respects size, bytes, and time limits
- [ ] Publish errors logged and retried
- [ ] Integration test: Puller → JetStream → test consumer receives event

---

## Phase 5: Backpressure & Coalescing

Handle slow consumers and optimize event delivery.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/puller/backpressure.go` | `BackpressureMonitor` with threshold handling |
| `internal/puller/coalescer.go` | Event coalescing with bounded memory |

### Implementation Notes

- Coalescer key: `tenantID + "/" + documentID`
- Coalescer limits: max 10,000 events OR 32MB
- Backpressure actions: SlowDown (reduce batch), Pause (stop publishing)

### Acceptance Criteria

- [ ] Multiple updates to same doc coalesced to latest
- [ ] Coalescer force-flushes when limits reached
- [ ] Publish latency > 100ms triggers slowdown
- [ ] Publish latency > 500ms triggers pause
- [ ] Metrics emitted for backpressure events
- [ ] Unit tests for coalescer, backpressure monitor

---

## Phase 6: Error Recovery

Handle gaps and resume token failures.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/puller/gap_detector.go` | Detect time gaps in event stream |
| `internal/puller/recovery.go` | Resume token error handling |

### Implementation Notes

- Gap threshold: 5 minutes between events
- On gap: publish `GAP_DETECTED` control message
- On invalid resume token: delete checkpoint, start fresh, alert

### Acceptance Criteria

- [ ] Gap > 5 minutes detected and logged
- [ ] `GAP_DETECTED` message published to control subject
- [ ] Invalid resume token handled gracefully (no crash)
- [ ] Metrics emitted for gaps and token failures
- [ ] Integration test: corrupt checkpoint → Puller recovers

---

## Phase 7: Bootstrap & Health

First-run handling and operational endpoints.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/puller/bootstrap.go` | First-run detection and initialization |
| `internal/puller/health.go` | Health check endpoint |
| `cmd/puller/main.go` | Standalone puller binary |

### Implementation Notes

- Bootstrap modes: `from_now` (default), `from_beginning` (use with caution)
- `from_beginning` warning: requires extended JetStream retention for large databases
- Health endpoint: `/health` returns partition status and lag

### Acceptance Criteria

- [ ] First run detected when no checkpoint exists
- [ ] `BOOTSTRAP_COMPLETE` message published after initialization
- [ ] Health endpoint returns correct status
- [ ] Standalone binary starts and runs correctly
- [ ] Graceful shutdown saves checkpoint

---

## Phase 8: Multi-Instance Support

Enable horizontal scaling with partition assignment.

### Deliverables

| File | Description |
| ---- | ----------- |
| `internal/puller/coordinator.go` | Static partition assignment |

### Implementation Notes

- Initial implementation: static assignment via config
- Future: dynamic coordination with etcd (out of scope for this task)

### Configuration

```yaml
puller:
  instance_id: puller-0
  assigned_partitions: [0, 1]
```

### Acceptance Criteria

- [ ] Instance only processes assigned partitions
- [ ] Multiple instances can run with different partition assignments
- [ ] No duplicate events when partitions properly assigned
- [ ] Documentation for partition assignment strategy

---

## Key Defaults

| Parameter | Value |
| --------- | ----- |
| Batch size | 256 events or 1MB |
| Batch wait | 50ms |
| Checkpoint interval | 1s or 1k events |
| Soft lag threshold | 30s |
| Hard lag threshold | 2m |
| Gap detection threshold | 5m |
| JetStream retention | 10m |
| Coalescer max size | 10,000 events |
| Coalescer max bytes | 32MB |

---

## Testing Summary

### Unit Tests

- [ ] Event normalization (MongoDB → NormalizedEvent)
- [ ] Partition assignment (deterministic, tenant-aware)
- [ ] Coalescer (merge, flush, memory limits)
- [ ] Backpressure (threshold detection, actions)
- [ ] Gap detector (time gap calculation)
- [ ] Subject patterns (correct format)

### Integration Tests

- [ ] End-to-end: MongoDB insert → Puller → JetStream → consumer
- [ ] Checkpoint: restart Puller → resumes from checkpoint
- [ ] Gap recovery: simulate gap → control message published
- [ ] Resume token failure: corrupt token → graceful recovery

### Manual Verification

- [ ] Standalone binary runs with example config
- [ ] Health endpoint accessible and returns valid JSON
- [ ] Metrics exposed on `/metrics`

---

## Risks

| Risk | Mitigation |
| ---- | ---------- |
| JetStream requires NATS | Use embedded NATS for dev |
| Checkpoint loss → duplicates | Consumers must be idempotent |
| Resume token corruption | Graceful fallback, alert operators |
| Coalescer memory growth | Bounded by maxSize/maxBytes |

---

## Status Log

- 2025-12-29: Task created from 014 dry-run analysis
- 2025-12-30: Comprehensive review, 15 issues identified and resolved
- 2025-12-30: Design docs split into architecture and details
- 2025-12-30: Task simplified, removed duplicate content, added acceptance criteria

---

## References

- [Field Naming Conventions](../docs/design/server/002_field_naming.md) - **Single source of truth** for field names
- [Puller Architecture](../docs/design/server/puller/001.architecture.md) - Event schema, design decisions
- [Puller Design Details](../docs/design/server/puller/002.design-details.md) - Implementation code, configuration, deployment
- [Engine Integration](../docs/design/server/engine/007.puller.md) - Consumer integration patterns
