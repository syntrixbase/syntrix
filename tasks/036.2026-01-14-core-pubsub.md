# Core Pubsub Layer Implementation

**Date:** 2026-01-14
**Status:** Complete
**Scope:** Generic pubsub abstraction in `internal/core/pubsub/`
**Depends on:** None

## Overview

Extract a generic pubsub abstraction from `internal/trigger/pubsub/` into `internal/core/pubsub/`. This enables reuse across services and decouples business logic from NATS transport details.

Design doc: [docs/design/server/core/01.pubsub.md](../docs/design/server/core/01.pubsub.md)

---

## Phase 1: Core Interfaces (DONE)

### Task 1.1: Define Core Interfaces

**File:** `internal/core/pubsub/interfaces.go`

- [x] Define `Message` interface
- [x] Define `MessageMetadata` struct
- [x] Define `Publisher` interface
- [x] Define `Consumer` interface (Subscribe pattern)

### Task 1.2: Define Options

**File:** `internal/core/pubsub/options.go`

- [x] Define `PublisherOptions` struct
- [x] Define `ConsumerOptions` struct

---

## Phase 2: NATS JetStream Implementation (DONE)

### Task 2.1: Publisher Implementation

**File:** `internal/core/pubsub/nats/publisher.go`

- [x] Create `jetStreamPublisher` struct
- [x] Implement `NewPublisher(js JetStream, opts PublisherOptions) (Publisher, error)`
- [x] Ensure stream exists on creation (if StreamName provided)
- [x] Implement `Publish(ctx, subject, data)` with subject prefix
- [x] Implement `Close()`
- [x] Call `OnPublish` callback if set

### Task 2.2: Message Wrapper

**File:** `internal/core/pubsub/nats/message.go`

- [x] Create `natsMessage` struct wrapping `jetstream.Msg`
- [x] Implement all `Message` interface methods
- [x] Convert `jetstream.MsgMetadata` to `MessageMetadata`
- [x] Export `WrapMessage(msg jetstream.Msg)` helper

### Task 2.3: Consumer Implementation

**File:** `internal/core/pubsub/nats/consumer.go`

- [x] Create `jetStreamConsumer` struct
- [x] Implement `NewConsumer(js JetStream, opts ConsumerOptions) (Consumer, error)`
- [x] Implement `Subscribe(ctx)` returning message channel
- [x] Implement graceful shutdown on context cancellation

### Task 2.4: Connection Helper

**File:** `internal/core/pubsub/nats/connection.go`

- [x] Define `JetStream` interface for testability
- [x] Create `NewJetStream(nc *nats.Conn) (JetStream, error)` helper

---

## Phase 3: Test Utilities (DONE)

### Task 3.1: Mock Publisher

**File:** `internal/core/pubsub/testing/mock.go`

- [x] Create `MockPublisher` struct
- [x] Track published messages
- [x] Allow injecting errors

### Task 3.2: Mock Consumer

**File:** `internal/core/pubsub/testing/mock.go`

- [x] Create `MockConsumer` struct with Subscribe pattern
- [x] Allow simulating messages via `Send()` method
- [x] Track subscription state via `IsStarted()`
- [x] Create `MockMessage` struct with all state tracking

---

## Phase 4: Unit Tests (DONE)

### Task 4.1: Publisher Tests

**File:** `internal/core/pubsub/nats/publisher_test.go`

- [x] Test `NewPublisher` creates stream
- [x] Test `Publish` sends to correct subject
- [x] Test `OnPublish` callback is called
- [x] Test error handling

### Task 4.2: Consumer Tests

**File:** `internal/core/pubsub/nats/consumer_test.go`

- [x] Test `NewConsumer` with default options
- [x] Test `Subscribe` creates durable consumer
- [x] Test message dispatch through channel
- [x] Test graceful shutdown on context cancellation

### Task 4.3: Message Tests

**File:** `internal/core/pubsub/nats/nats_test.go`

- [x] Test all `Message` interface methods
- [x] Test `Metadata` conversion

---

## Phase 5: Extend Options and Integrate with Trigger (DONE)

### Task 5.0: Extend PublisherOptions

**File:** `internal/core/pubsub/options.go`

- [x] Add `StorageType` type definition:
  ```go
  type StorageType int
  const (
      MemoryStorage StorageType = iota  // 0, default
      FileStorage                        // 1
  )
  ```
- [x] Add `RetryAttempts int` field to `PublisherOptions` (default 0 = no retry)
- [x] Add `Storage StorageType` field to `PublisherOptions` (default MemoryStorage)

**File:** `internal/core/pubsub/nats/publisher.go`

- [x] Use `jetstream.WithRetryAttempts(opts.RetryAttempts)` in `Publish()` call when RetryAttempts > 0
- [x] Map `opts.Storage` to `jetstream.MemoryStorage` / `jetstream.FileStorage` when creating stream

### Task 5.1: Extend ConsumerOptions

**File:** `internal/core/pubsub/options.go`

- [x] Add `Storage StorageType` field to `ConsumerOptions` (default MemoryStorage)

**File:** `internal/core/pubsub/nats/consumer.go`

- [x] Map `opts.Storage` to `jetstream.MemoryStorage` / `jetstream.FileStorage` when creating stream

### Task 5.2: Trigger Publisher Integration

**File:** `internal/trigger/evaluator/publisher.go`

- [x] 修改 `natsPublisher` struct 使用 `pubsub.Publisher`
- [x] 修改 `NewTaskPublisher` 接受 `pubsub.Publisher` 而不是 `*nats.Conn`
- [x] 删除 `jetStreamNew` 变量和 `EnsureStream` 函数
- [x] 删除 `NewTaskPublisherFromJS` 函数
- [x] 保持 subject 构建逻辑和 metrics 调用

**File:** `internal/trigger/evaluator/factory.go`

- [x] 修改 `Dependencies` struct 使用 `Publisher pubsub.Publisher`
- [x] 删除 `publisherFactory` 和 `newTaskPublisher` 变量

### Task 5.3: Trigger Consumer Integration

**File:** `internal/trigger/delivery/consumer.go`

- [x] 修改 `natsConsumer` struct 使用 `pubsub.Consumer` 和 `[]chan pubsub.Message`
- [x] 修改 `NewTaskConsumer` 接受 `pubsub.Consumer`
- [x] 删除 `jetStreamNew` 变量和 stream/consumer 创建逻辑
- [x] 修改 `Start()` 使用 channel 模式替代 callback 模式
- [x] 修改 `dispatch()`, `workerLoop()`, `processMsg()` 使用 `pubsub.Message`

**File:** `internal/trigger/delivery/factory.go`

- [x] 修改 `Dependencies` struct 使用 `Consumer pubsub.Consumer`
- [x] 删除 `StreamName` from `ServiceOptions`

### Task 5.4: Update manager_init.go

**File:** `internal/services/manager_init.go`

- [x] 添加 `pubsubPublisherFactory` 和 `pubsubConsumerFactory` 可注入工厂函数
- [x] 在 `initTriggerServices()` 中使用工厂创建 pubsub 实例
- [x] 修改 evaluator.Dependencies 使用 `Publisher: publisher`
- [x] 修改 delivery.Dependencies 使用 `Consumer: consumer`

### Task 5.5: Update Tests

**File:** `internal/trigger/evaluator/publisher_test.go`

- [x] 使用 `pubsubtesting.MockPublisher` 替换 JetStream mock

**File:** `internal/trigger/delivery/consumer_test.go`

- [x] 使用 `pubsubtesting.MockConsumer` 和 `pubsubtesting.MockMessage`
- [x] 删除 JetStream 相关的 mock 逻辑

**File:** `internal/services/manager_trigger_test.go`

- [x] 更新测试使用新的 Dependencies 结构
- [x] 添加 `pubsubPublisherFactory` 和 `pubsubConsumerFactory` mock

---

## Phase 6: Cleanup (DONE)

### Task 6.1: Remove Old pubsub Package

- [x] Delete `internal/trigger/pubsub/publisher.go`
- [x] Delete `internal/trigger/pubsub/consumer.go`
- [x] Delete `internal/trigger/pubsub/interfaces.go`
- [x] Delete `internal/trigger/pubsub/vars.go`
- [x] Verify trigger uses `core/pubsub`

### Task 6.2: Update Design Docs

- [x] Update `docs/design/server/trigger/01.architecture.md`
- [x] Update `docs/design/server/trigger/02.interfaces.md`
- [ ] Add `docs/design/server/core/01.pubsub.md` to index

---

## Acceptance Criteria

- [x] All existing trigger tests pass
- [x] New pubsub unit tests pass with >80% coverage
- [x] Integration test with embedded NATS works
- [x] `make test` passes
- [x] `make coverage` shows no critical issues in new code
- [x] Trigger services use core/pubsub abstraction

---

## Summary

**Phase 1-4:** Completed - Core pubsub abstraction exists in `internal/core/pubsub/`
**Phase 5:** DONE - Options extended and trigger integrated with core/pubsub
**Phase 6:** DONE - Old package deleted, trigger now uses core/pubsub

### Key Decisions

1. **StorageType**: 自定义类型，0=Memory（默认），1=File
2. **RetryAttempts**: 0 表示不重试，trigger 使用 3
3. **TaskPublisher 接口**: 保留，内部包装 `pubsub.Publisher`
4. **metrics 回调**: trigger 自己处理，不使用 `OnPublish`
5. **WithExpectStream**: 移除，stream 创建时已确保存在
6. **Dependencies**: 注入 `pubsub.Publisher` / `pubsub.Consumer`，不再传 `*nats.Conn`
7. **pubsub 实例创建**: 在 `manager_init.go` 中创建并注入
8. **Injectable factories**: 添加 `pubsubPublisherFactory` 和 `pubsubConsumerFactory` 支持测试注入
