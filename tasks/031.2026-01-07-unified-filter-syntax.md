# Task 031: Unified Filter Syntax Implementation

**Created**: 2026-01-07
**Status**: Pending
**Design Doc**: [docs/design/server/013_unified_filter_syntax.md](../docs/design/server/013_unified_filter_syntax.md)

## Objective

Unify Filter type and operator syntax across Query and Streamer components.

## Files to Modify

| File | Change |
|------|--------|
| `pkg/model/filter.go` | Add `FilterOp` type and constants, `Validate()` method |
| `internal/streamer/types.go` | Remove duplicate `Filter`, use `model.Filter` |
| `internal/streamer/convert.go` | Update conversion to use `model.Filter` |
| `internal/streamer/local_stream.go` | Update to use `model.Filter` |
| `internal/streamer/interface.go` | Update interface to use `model.Filter` |
| `internal/streamer/internal/cel/cel.go` | Update operator handling |
| `internal/api/rest/validation.go` | Use `filter.Op.IsValid()` |
| `internal/storage/internal/mongo/utils.go` | Update `mapOp()` for new operators |
| Related test files | Update operator strings |

## Tasks

- [ ] **Phase 1**: Update `pkg/model/filter.go`
  - Add `FilterOp` type with constants (`OpEq`, `OpNe`, etc.)
  - Add `IsValid()` method
  - Add `Validate()` method to `Filter`

- [ ] **Phase 2**: Update Storage layer
  - Modify `internal/storage/internal/mongo/utils.go` `mapOp()` function
  - Update `utils_test.go`

- [ ] **Phase 3**: Update Streamer
  - Remove `Filter` from `internal/streamer/types.go`
  - Update `internal/streamer/interface.go` to use `model.Filter`
  - Update `internal/streamer/convert.go`
  - Update `internal/streamer/local_stream.go`
  - Update `internal/streamer/internal/cel/cel.go`
  - Update all streamer test files

- [ ] **Phase 4**: Update REST API
  - Modify `internal/api/rest/validation.go` to use `Filter.Validate()`
  - Update `validation_test.go`
  - Update `handler_query_table_test.go`

- [ ] **Phase 5**: Run tests and fix issues
  - Run `make test`
  - Run `make coverage`

## Operator Mapping Reference

| New Op | Old Query Op | MongoDB |
|--------|--------------|---------|
| `eq` | `==` | `$eq` |
| `ne` | `!=` | `$ne` |
| `gt` | `>` | `$gt` |
| `gte` | `>=` | `$gte` |
| `lt` | `<` | `$lt` |
| `lte` | `<=` | `$lte` |
| `in` | `in` | `$in` |
| `contains` | `array-contains` | `$elemMatch` or custom |

## Acceptance Criteria

- [ ] Single `Filter` type in `pkg/model`
- [ ] All components use shorthand operators (`eq`, `ne`, etc.)
- [ ] All tests pass
- [ ] Coverage maintained or improved

## Code Changes Reference

### Phase 1: pkg/model/filter.go

```go
// Add FilterOp type
type FilterOp string

const (
    OpEq       FilterOp = "=="
    OpNe       FilterOp = "!="
    OpGt       FilterOp = ">"
    OpGte      FilterOp = ">="
    OpLt       FilterOp = "<"
    OpLte      FilterOp = "<="
    OpIn       FilterOp = "in"
    OpContains FilterOp = "contains"
)

func (op FilterOp) IsValid() bool {
    switch op {
    case OpEq, OpNe, OpGt, OpGte, OpLt, OpLte, OpIn, OpContains:
        return true
    }
    return false
}

// Update Filter struct
type Filter struct {
    Field string   `json:"field"`
    Op    FilterOp `json:"op"`  // Changed from string
    Value any      `json:"value"`
}

func (f Filter) Validate() error {
    if f.Field == "" {
        return errors.New("filter field cannot be empty")
    }
    if !f.Op.IsValid() {
        return fmt.Errorf("unsupported filter operator: %s", f.Op)
    }
    return nil
}
```

### Phase 2: Storage mapOp()

```go
// Before:
func mapOp(op string) string {
    switch op {
    case "==": return "$eq"
    case "!=": return "$ne"
    case ">":  return "$gt"
    // ...
    }
}

// After:
func mapOp(op model.FilterOp) string {
    switch op {
    case model.OpEq:  return "$eq"
    case model.OpNe:  return "$ne"
    case model.OpGt:  return "$gt"
    case model.OpGte: return "$gte"
    case model.OpLt:  return "$lt"
    case model.OpLte: return "$lte"
    case model.OpIn:  return "$in"
    default: return ""
    }
}
```

### Phase 3: Streamer

```go
// Delete from internal/streamer/types.go:
// type Filter struct { ... }

// Update internal/streamer/interface.go:
Subscribe(database, collection string, filters []model.Filter) (subscriptionID string, err error)
```

### Phase 4: REST API Validation

```go
// Before:
switch f.Op {
case "==", ">", ">=", "<", "<=", "in", "array-contains":
    // Valid
default:
    return fmt.Errorf("unsupported filter operator: %s", f.Op)
}

// After:
if err := f.Validate(); err != nil {
    return err
}
```
