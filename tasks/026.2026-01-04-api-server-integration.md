# Task 026: API Server Integration into Unified Server Layer

**Date**: 2026-01-04
**Status**: Completed ✅
**Scope**: internal/api, internal/server, internal/services

## Objective

Integrate `internal/api` routes directly into `internal/server`'s unified HTTP mux, eliminating the separate `api.Server` HTTP Handler layer. This flattens the routing architecture from two mux layers to one.

## Background

### Current Architecture

```
Manager.servers[]
    └── http.Server{ Handler: api.Server }
                          └── mux (internal)
                               ├── /api/v1/...
                               ├── /realtime/...
                               └── /console/...
```

- `api.Server` implements `http.Handler` with its own mux
- Has duplicate CORS handling (both in `api.Server.ServeHTTP` and `internal/server` middleware)
- `rest.Handler` has its own `withRequestID`, `withRecover` wrappers that duplicate `internal/server` middleware

### Target Architecture

```
internal/server (unified)
    └── mux
         ├── /api/v1/...      ← registered directly
         ├── /realtime/...    ← registered directly
         ├── /console/...     ← registered directly
         └── /health          ← registered directly
```

- All routes registered to single unified mux
- Middleware (recovery, requestID, logging, CORS) handled by `internal/server`
- `api.Server` becomes a route registrar, not a handler

## Implementation Steps

### Phase 1: Expose Registration Interface in `internal/server`

- [x] **1.1** Add `HTTPMux()` method to `Service` interface in [interface.go](../internal/server/interface.go)
  - Returns `*http.ServeMux` for direct route registration
  - Alternative: Add `RegisterHTTPFunc(pattern, fn)` method

### Phase 2: Refactor `internal/api`

- [x] **2.1** Modify `api.Server` in [server.go](../internal/api/server.go)
  - Remove `http.Handler` implementation (`ServeHTTP` method)
  - Remove internal `mux` field
  - Change `NewServer()` → return a registrar type, not a handler
  - Add `RegisterRoutes(mux *http.ServeMux)` method that combines:
    - REST routes (delegate to `rest.Handler.RegisterRoutes`)
    - Realtime routes (`/realtime/ws`, `/realtime/sse`)
    - Console static files (`/console/`)

- [x] **2.2** Simplify `rest.Handler.RegisterRoutes` in [handler.go](../internal/api/rest/handler.go)
  - Remove `withRequestID` wrapper (handled by `server.requestIDMiddleware`)
  - Remove `withRecover` wrapper (handled by `server.recoveryMiddleware`)
  - Keep `withTimeout`, `maxBodySize` as they are business-specific
  - Keep auth wrappers (`protected`, `authorized`, etc.)

- [x] **2.3** Fix Request ID compatibility
  - Replace `rest.getRequestID(ctx)` calls with `server.GetRequestID(ctx)`
  - Remove `rest.contextKeyRequestID` constant
  - Remove `rest.withRequestID` function
  - Note: Both packages define same key value `"request_id"` but different types, causing incompatibility

### Phase 3: Update Service Manager

- [x] **3.1** Modify `initAPIServer` in [manager_init.go](../internal/services/manager_init.go)
  - Remove `http.Server` creation for API server
  - Call `api.RegisterRoutes(server.Default().HTTPMux())` instead
  - Remove `api.Server` from `m.servers` slice

- [x] **3.2** Consolidate configuration
  - Migrate `Gateway.Port` value to `Server.HTTPPort` in config files
  - Remove `Gateway.Port` field from `GatewayConfig` struct
  - `Server.HTTPPort` becomes the single source of truth for HTTP port

- [x] **3.3** Update config files
  - [config/config.yml](../config/config.yml): Change `server.http_port` from 8000 to 8080, remove `gateway.port`
  - [internal/config/config.go](../internal/config/config.go#L233-L236): Remove `GATEWAY_PORT` env var handling

### Phase 4: Testing & Cleanup

- [x] **4.1** Update existing tests
  - `internal/api/server_test.go` - Refactor to test route registration instead of Handler behavior
  - `internal/api/rest/handler_*_test.go` - Ensure middleware removal doesn't break tests
  - `internal/api/rest/handler_security_test.go#L654` - Update to use `server.contextKeyRequestID`
  - `internal/services/manager_init_test.go` - Update 8 references from `Gateway.Port` to `Server.HTTPPort`
  - `internal/config/config_test.go` - Update 2 assertions about `Gateway.Port`

- [x] **4.2** Remove dead code
  - `api.Server.ServeHTTP` method
  - `api.Server.mux` field
  - `rest.withRequestID` function
  - `rest.withRecover` function
  - `rest.contextKeyRequestID` constant
  - `rest.getRequestID` function

## Files to Modify

| File | Changes |
|------|---------|
| `internal/server/interface.go` | Add `HTTPMux()` method |
| `internal/server/service.go` | Implement `HTTPMux()` |
| `internal/api/server.go` | Remove Handler, add `RegisterRoutes()` |
| `internal/api/rest/handler.go` | Remove `withRequestID`, `withRecover`, `getRequestID`, use `server.GetRequestID` |
| `internal/services/manager_init.go` | Change API server initialization |
| `internal/config/config.go` | Remove `Gateway.Port` field and `GATEWAY_PORT` env handling |
| `config/config.yml` | Update `server.http_port` to 8080, remove `gateway.port` |
| `internal/api/server_test.go` | Refactor tests for new registration pattern |
| `internal/services/manager_init_test.go` | Update `Gateway.Port` → `Server.HTTPPort` (8 places) |
| `internal/config/config_test.go` | Update `Gateway.Port` assertions (2 places) |
| `internal/api/rest/handler_security_test.go` | Update context key usage |

## Risk & Considerations

1. **Test Coverage**: Many tests mock or create `api.Server` directly. Need to update test patterns.

2. **Request ID Propagation**: Ensure `server.GetRequestID(ctx)` works correctly for all nested handlers.

## Out of Scope

- CSP Server migration (remains on separate port)
- Lifecycle management changes (m.servers slice stays)
- gRPC integration

## Success Criteria

- [x] Single HTTP mux handling all API routes
- [x] No duplicate CORS handling
- [x] No duplicate panic recovery
- [x] No duplicate request ID generation
- [x] All existing tests pass
- [x] `make coverage` maintains current coverage level (95.2%)
