# Security Rules Per-Database Configuration

Date: January 17, 2026
Status: Completed
Scope: Refactor security rules configuration to support per-database separation with directory-based loading.

## Background

Currently, security rules are loaded from a single YAML file (`security.yaml`). This design limits flexibility when managing rules across multiple databases. The authorization engine also hardcodes the "default" database prefix, making multi-database deployments impractical.

## Goals

- Support per-database security rules configuration
- Allow splitting large configurations across multiple files
- Detect and reject conflicting rule definitions at startup
- Pass database context through authorization evaluation

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Configuration structure | Directory-based (`config/security_rules/`) | Allows multiple files, better organization |
| Database identification | `database` field in YAML (authoritative) | Explicit declaration, file name is just for maintainability |
| Multi-file support | One file per database | Security rules are typically cohesive per database |
| Conflict handling | Reject on duplicate `database` | Fail-fast, prevent silent overwrites |
| Path placeholder handling | `{database}` auto-replaced OR explicit value must match | Flexibility with validation |

## New Configuration Format

**Directory structure:**
```
config/
  security_rules/
    default.yml           # database: default
    analytics.yml         # database: analytics
    tenant-a.yml          # database: tenant-a
```

**YAML shape:**
```yaml
database: default
rules_version: '1'
service: syntrix
match:
  /databases/{database}/documents:
    match:
      /{document=**}:
        allow:
          read, write: "true"
```

### Path Placeholder Handling

The `{database}` placeholder in match paths is handled as follows:

1. **Using `{database}` placeholder** (recommended):
   - At load time, `{database}` is automatically replaced with the `database` field value
   - Example: `database: analytics` + `/databases/{database}/documents` → `/databases/analytics/documents`

2. **Using explicit database name**:
   - If a concrete database name is used instead of `{database}`, it MUST match the `database` field
   - Example: `database: analytics` + `/databases/analytics/documents` → Valid
   - Example: `database: analytics` + `/databases/default/documents` → **Error: mismatch**

This validation ensures rules are always applied to the correct database.

## Implementation Tasks

### 1. Update Config Struct
- [x] Rename `RulesFile` to `RulesPath` in `AuthZConfig`
- [x] Update default from `security.yaml` to `config/security_rules`
- File: `internal/core/identity/config/config.go`

### 2. Add Database Field to RuleSet
- [x] Add `Database` field to `RuleSet` struct
- File: `internal/core/identity/types/types.go`

### 3. Implement Directory Loading
- [x] Add `LoadRulesFromDir(dirPath string) (map[string]*RuleSet, error)` function
- [x] Scan all `.yml` files in directory
- [x] Parse each file and validate database field
- [x] Replace `{database}` placeholder in match paths with actual database value
- [x] Validate explicit database names match the `database` field
- [x] Detect duplicate database definitions across files
- File: `internal/core/identity/authz/engine.go`

### 4. Update Engine Storage
- [x] Change `rules *RuleSet` to `rules map[string]*RuleSet`
- [x] Update `GetRules()` to return rules for specific database
- [x] Add `GetRulesForDatabase(database string) *RuleSet`
- File: `internal/core/identity/authz/engine.go`

### 5. Update Evaluate Method
- [x] Add `database` parameter to `Evaluate()` signature
- [x] Use database-specific rules for evaluation
- [x] Fall back gracefully if no rules for database (deny all)
- File: `internal/core/identity/authz/engine.go`

### 6. Update Handler
- [x] Extract database from request context
- [x] Pass database to `authz.Evaluate()`
- File: `internal/gateway/rest/handler.go`

### 7. Update Tests
- [x] Add tests for directory loading
- [x] Add tests for per-database rule evaluation
- [x] Add tests for conflict detection
- [x] Update existing tests to use new format
- Files: `internal/core/identity/authz/*_test.go`

### 8. Migration
- [x] Create new directory structure: `config/security_rules/`
- [x] Create example file: `config/security_rules/default.yml`
- [ ] Remove old file: `config/security.example.yml` (kept for reference)
- [x] Update documentation

## Files to Modify

| File | Changes |
|------|---------|
| `internal/core/identity/types/types.go` | Add Database field to RuleSet |
| `internal/core/identity/config/config.go` | Rename RulesFile to RulesPath, update default |
| `internal/core/identity/authz/engine.go` | Directory loading, per-database storage, updated Evaluate |
| `internal/core/identity/authz/*_test.go` | Update tests for new format |
| `internal/gateway/rest/handler.go` | Pass database to Evaluate |

## Testing Strategy

1. **Unit tests**: Directory scanning, YAML parsing, conflict detection
2. **Integration tests**: Full loading pipeline with multiple files
3. **Error cases**: Missing directory, invalid YAML, duplicate databases

## Rollback Plan

If issues arise, revert to single-file loading by:
1. Reverting code changes
2. Restoring `config/security.example.yml`
