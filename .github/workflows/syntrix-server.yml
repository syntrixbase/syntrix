name: Syntrix Server CI

on:
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Makefile'
      - 'cmd/**'
      - 'internal/**'
      - 'pkg/**'
      - 'config/**'
      - 'tests/**'
      - '.github/workflows/syntrix-server.yml'

jobs:
  syntrix-server:
    name: Syntrix Server (Go)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Services
        run: |
          docker compose -f .devcontainer/docker-compose.yml up -d mongodb nats mongo-init
          echo "Waiting for services to initialize..."
          timeout 60s bash -c 'until docker exec syntrix_mongodb mongosh --eval "db.adminCommand(\"ping\")"; do sleep 1; done'
          docker compose -f .devcontainer/docker-compose.yml ps
          docker compose -f .devcontainer/docker-compose.yml logs mongo-init

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Verify Go version
        run: go version

      - name: Build
        run: make build

      - name: Test and Coverage
        run: |
          # Run tests with coverage, excluding cmd/ directory
          go test -coverprofile=coverage.out $(go list ./... | grep -v "/cmd/")

          # Generate function report
          go tool cover -func=coverage.out > coverage.txt

          # Print formatted table (similar to scripts/coverage.sh)
          echo -e "\nFunction coverage details (excluding 100%):"
          printf "%-60s %-35s %s\n" "LOCATION" "FUNCTION" "COVERAGE"
          echo "---------------------------------------------------------------------------------------------------------"

          # Clean up package names for display
          sed 's/github.com\/codetrek\/syntrix\///g' coverage.txt | \
            grep -v "^total:" | \
            awk '$3 != "100.0%" {printf "%-60s %-35s %s\n", $1, $2, $3}' | \
            sort -k3 -nr

          echo "---------------------------------------------------------------------------------------------------------"

          COUNT=$(grep "100.0%" coverage.txt | wc -l)
          echo "Functions with 100% coverage: $COUNT"

          # Check Total Coverage (>= 85%)
          TOTAL_COV=$(grep "total:" coverage.txt | awk '{print $3}' | sed 's/%//')
          echo "Total Coverage: ${TOTAL_COV}%"

          if (( $(echo "$TOTAL_COV < 85.0" | bc -l) )); then
            echo "::error::Total coverage ${TOTAL_COV}% is below the required 85%"
            exit 1
          fi

          # Check Individual Function Coverage (>= 60%)
          # Filter out "total:" line, check if percentage < 60.0
          # Use p+0 to force numeric comparison in awk
          FAILED_FUNCS=$(grep -v "total:" coverage.txt | sed 's/github.com\/codetrek\/syntrix\///g' | awk '{p=$3; sub(/%/, "", p); if (p+0 < 60.0) print $0}')
          
          if [ -n "$FAILED_FUNCS" ]; then
            echo "::error::The following functions have coverage less than 60%:"
            echo "$FAILED_FUNCS"
            exit 1
          fi
