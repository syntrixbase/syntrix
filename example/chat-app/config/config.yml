# Syntrix Configuration for Chat App Demo
# Usage: ./bin/syntrix --config-dir example/chat-app/config --standalone

# Data directory for runtime data (logs, caches, indexes)
# Relative paths are resolved from the current working directory.
data_dir: "example/chat-app/data"

deployment:
  mode: standalone

server:
  host: "localhost"
  http_port: 8080
  http_read_timeout: 30s
  http_write_timeout: 30s
  http_idle_timeout: 120s
  enable_cors: true

  # Allow requests from chat-app frontend (Vite dev server)
  allowed_origins:
    - "http://localhost:5173"
    - "http://localhost:3000"
    - "http://127.0.0.1:5173"
  allow_credentials: true

  grpc_port: 9000
  shutdown_timeout: 15s

  # Rate limiting (relaxed for demo)
  rate_limit:
    enabled: true
    requests: 1000
    window: 1m
    auth_requests: 20
    auth_window: 1m

storage:
  backends:
    default_mongo:
      type: mongo
      mongo:
        uri: "mongodb://localhost:27017"
        database_name: "syntrix_chat"
  topology:
    document:
      strategy: single
      primary: default_mongo
      data_collection: documents
      sys_collection: sys
      soft_delete_retention: 720h # 30 days
    user:
      strategy: single
      primary: default_mongo
      collection: auth_users
    revocation:
      strategy: single
      primary: default_mongo
      collection: revocations

identity:
  authn:
    access_token_ttl: 1h       # Longer for demo convenience
    refresh_token_ttl: 720h    # 30 days
    auth_code_ttl: 5m
    private_key_file: "keys/auth_private.pem"
  authz:
    rules_path: "security_rules"
  admin:
    username: "admin"
    password: "chatapp123"     # Demo password - change in production!

gateway:
  query_service_url: "localhost:9000"
  streamer_service_url: "localhost:9000"
  realtime:
    transport: "both"          # Support both WebSocket and SSE
    per_message_deflate: true

query:
  indexer_addr: "localhost:9000"

trigger:
  nats_url: "nats://localhost:4222"
  evaluator:
    rules_path: "triggers"     # Will load from config/triggers/
  delivery:
    worker_count: 16
    stream_name: "CHAT_TRIGGERS"

puller:
  grpc:
    address: ":50051"
    max_connections: 50
    channel_size: 5000
  backends:
    - name: "default_mongo"
      collections: ["documents"]
  buffer:
    path: "puller/events"     # Relative to data_dir
    max_size: "1GiB"
    batch_size: 100
    batch_interval: 100ms
    queue_size: 5000
  consumer:
    catch_up_threshold: 10000
    coalesce_on_catch_up: true
  cleaner:
    interval: 1m
    retention: 30m
  bootstrap:
    mode: "from_now"
  metrics:
    port: 9090
    path: "/metrics"
  health:
    port: 8081
    path: "/health"

streamer:
  server:
    puller_addr: "localhost:9000"
    send_timeout: 5s
  client:
    streamer_addr: "localhost:9000"
    initial_backoff: 1s
    max_backoff: 30s
    backoff_multiplier: 2.0
    max_retries: 0
    heartbeat_interval: 30s
    activity_timeout: 90s

indexer:
  puller_addr: "localhost:9000"
  template_path: "index_templates"
  progress_path: "indexer/progress"    # Relative to data_dir
  consumer_id: "chat-indexer"
  reconcile_interval: 5s
  storage_mode: "memory"
  store:
    path: "indexer/indexes.db"         # Relative to data_dir
    batch_size: 100
    batch_interval: 100ms
    queue_size: 5000
    block_cache_size: 67108864  # 64MB

logging:
  level: "debug"               # Verbose for debugging
  format: "text"
  dir: "logs"                  # Relative to data_dir

  rotation:
    max_size: 100
    max_backups: 3
    max_age: 7
    compress: true

  console:
    enabled: true
    level: "debug"
    format: "text"

  file:
    enabled: true
    level: "debug"
    format: "json"

  async:
    enabled: false             # Sync logging for easier debugging

  dedup:
    enabled: true
    batch_size: 50
    flush_timeout: 500
