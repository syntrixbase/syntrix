name : syntrix_devcontainer
services:
  mongodb:
    image: mongo:7.0
    container_name: syntrix_mongodb
    restart: always
    ports:
      - "27017:27017"
    command: ["--replSet", "rs0", "--bind_ip_all"]
    environment:
      MONGO_INITDB_DATABASE: syntrix
    volumes:
      - mongodb_data:/data/db

  mongo-init:
    image: mongo:7.0
    container_name: syntrix_mongo_init
    restart: "no"
    depends_on:
      - mongodb
    command: >
      bash -c "sleep 5 && mongosh --host mongodb:27017 --eval
      'try {
        rs.status();
        print(\"Replica set already initialized\");
      } catch (e) {
        rs.initiate({_id: \"rs0\", members: [{_id: 0, host: \"localhost:27017\"}]});
        print(\"Replica set initialized\");
      }'"

  nats:
    image: nats:2.10-alpine
    container_name: syntrix_nats
    restart: always
    ports:
      - "4222:4222"
      - "8222:8222"
    # Enable JetStream (-js) and monitoring (-m)
    # Note: Stream configuration (storage: memory, replicas: 1, max_age: 10m) should be applied when creating the stream.
    command: "-js -m 8222"

volumes:
  mongodb_data:
