# Deployment Modes Design

**Date:** January 11, 2026 (Updated from December 31, 2025)
**Status:** Draft

## 1. Overview

Syntrix supports two deployment modes:

| Mode | Description | Use Case |
|------|-------------|----------|
| **Standalone** | All services in single process, direct function calls | Dev/Test, Edge, Small deployments |
| **Distributed** | Services communicate via gRPC | Production at scale |

**Key Principle:** The communication pattern is determined by mode, not by physical process layout.
- Standalone = direct calls
- Distributed = gRPC (even if services run in same process with `--all`)

## 2. Mode Comparison

| Aspect | Standalone Mode | Distributed Mode |
|--------|-----------------|------------------|
| **Startup** | `--standalone` | `--all`, `--query`, etc. |
| **Communication** | Direct function calls | gRPC (always) |
| **Latency** | Near-zero | Network RTT + serialization |
| **Scaling** | Vertical only | Horizontal |
| **Fault Isolation** | None (shared fate) | Process-level |
| **Configuration** | Minimal | Requires service URLs |
| **NATS** | Embedded | External |

## 3. Mode Determination

| CLI Flag | Config File | Result |
|----------|-------------|--------|
| `--standalone` | - | Standalone mode |
| - | `deployment.mode: standalone` | Standalone mode |
| `--all` | - | **Distributed mode** |
| `--query`, `--api`, etc. | - | Distributed mode |
| (default) | - | Distributed mode |

**Important:** `--all` runs all services in one process but still uses Distributed mode (gRPC communication).

## 4. Architecture

### 4.1 Standalone Mode (`--standalone`)

```
┌──────────────────────────────────────────────────────────────┐
│                      Single Process                           │
│                                                               │
│  API ──direct──► Query ──direct──► Indexer ──direct──► Puller│
│                                                               │
│  Trigger Evaluator ◄──embedded NATS──► Trigger Worker        │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 Distributed Mode (`--all` or separate processes)

```
┌──────────────────────────────────────────────────────────────┐
│              Single Process (--all) or Multiple               │
│                                                               │
│  API ──gRPC──► Query ──gRPC──► Indexer ──gRPC──► Puller      │
│                                                               │
│  Trigger Evaluator ◄──external NATS──► Trigger Worker        │
└──────────────────────────────────────────────────────────────┘
```

## 5. Implementation Pattern

Services are defined by interfaces. Mode determines which implementation is injected:

```go
// Example: Query → Indexer integration
func (m *Manager) createQueryService(ctx context.Context) (query.Service, error) {
    if m.opts.Mode == ModeStandalone {
        // Standalone: direct call
        return query.NewService(storage, m.indexerService), nil
    }

    // Distributed: gRPC client
    client, _ := indexer.NewClient(m.cfg.Gateway.IndexerServiceURL)
    return query.NewService(storage, client), nil
}
```

## 6. Configuration

### Standalone Mode
```bash
syntrix --standalone
```
- Minimal config required
- Uses embedded NATS

### Distributed Mode
```bash
syntrix --all                    # All services, one process
syntrix --query --indexer        # Selected services
```
- Requires service URLs in config:
```yaml
gateway:
  query_service_url: "localhost:50051"
  indexer_service_url: "localhost:50051"
  puller_service_url: "localhost:50051"
```
