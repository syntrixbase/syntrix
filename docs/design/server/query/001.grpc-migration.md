# Query Service gRPC Migration

**Date:** January 8, 2026
**Status:** Design Draft
**Component:** Query Service Protocol

## 1. Overview

Migrate the Query service from HTTP/JSON to gRPC/Protocol Buffers, aligning with the existing Puller and Streamer services for architectural consistency and performance benefits.

## 2. Current State

The Query service currently uses HTTP/JSON for inter-service communication:

```
┌─────────────────┐     HTTP/JSON     ┌─────────────────┐
│   API Server    │ ◄───────────────► │  Query Service  │
│   (consumer)    │                   │    (server)     │
└─────────────────┘                   └─────────────────┘
```

**Current Implementation:**
- `internal/query/internal/httphandler/handler.go` - HTTP server (245 lines)
- `internal/query/internal/client/client.go` - HTTP client (214 lines)
- Routes: POST `/internal/v1/document/*`, `/internal/v1/query/execute`, `/internal/replication/v1/*`

## 3. Target State

Unified gRPC protocol matching Puller and Streamer:

```
┌─────────────────┐      gRPC        ┌─────────────────┐
│   API Server    │ ◄───────────────► │  Query Service  │
│   (consumer)    │                   │    (server)     │
└─────────────────┘                   └─────────────────┘
```

## 4. Benefits

| Aspect | HTTP/JSON | gRPC/Protobuf | Improvement |
|--------|-----------|---------------|-------------|
| Serialization | Text (JSON) | Binary (Protobuf) | 30-50% smaller payload |
| Connection | HTTP/1.1 per-request | HTTP/2 multiplexed | Better connection reuse |
| Type Safety | Runtime validation | Compile-time types | Fewer runtime errors |
| Code Generation | Manual | Auto-generated | Less boilerplate |
| Consistency | Different from Puller/Streamer | Same as Puller/Streamer | Unified architecture |

## 5. Proto Definition

### 5.1 Service Definition

```protobuf
syntax = "proto3";

package syntrix.query.v1;

option go_package = "github.com/syntrixbase/syntrix/api/gen/query/v1;queryv1";

service QueryService {
    // Document operations
    rpc GetDocument(GetDocumentRequest) returns (GetDocumentResponse);
    rpc CreateDocument(CreateDocumentRequest) returns (CreateDocumentResponse);
    rpc ReplaceDocument(ReplaceDocumentRequest) returns (ReplaceDocumentResponse);
    rpc PatchDocument(PatchDocumentRequest) returns (PatchDocumentResponse);
    rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);

    // Query operations
    rpc ExecuteQuery(ExecuteQueryRequest) returns (ExecuteQueryResponse);

    // Replication operations
    rpc Pull(PullRequest) returns (PullResponse);
    rpc Push(PushRequest) returns (PushResponse);
}
```

### 5.2 Message Definitions

```protobuf
// Document is stored as JSON bytes for flexibility
message Document {
    bytes json_data = 1;
}

// Filter for query conditions
message Filter {
    string field = 1;
    string op = 2;      // eq, ne, gt, gte, lt, lte, in, contains
    bytes value = 3;    // JSON-encoded value
}

// GetDocument
message GetDocumentRequest {
    string database = 1;
    string path = 2;
}

message GetDocumentResponse {
    Document document = 1;
}

// CreateDocument
message CreateDocumentRequest {
    string database = 1;
    Document document = 2;
}

message CreateDocumentResponse {
    Document document = 1;
}

// ReplaceDocument
message ReplaceDocumentRequest {
    string database = 1;
    Document document = 2;
    repeated Filter filters = 3;
}

message ReplaceDocumentResponse {
    Document document = 1;
}

// PatchDocument
message PatchDocumentRequest {
    string database = 1;
    Document document = 2;
    repeated Filter filters = 3;
}

message PatchDocumentResponse {
    Document document = 1;
}

// DeleteDocument
message DeleteDocumentRequest {
    string database = 1;
    string path = 2;
    repeated Filter filters = 3;
}

message DeleteDocumentResponse {}

// ExecuteQuery
message Query {
    string collection = 1;
    repeated Filter filters = 2;
    repeated OrderBy order_by = 3;
    int32 limit = 4;
    bool show_deleted = 5;
}

message OrderBy {
    string field = 1;
    bool descending = 2;
}

message ExecuteQueryRequest {
    string database = 1;
    Query query = 2;
}

message ExecuteQueryResponse {
    repeated Document documents = 1;
}

// Replication - Pull
message PullRequest {
    string database = 1;
    string collection = 2;
    string resume_token = 3;
    int32 limit = 4;
}

message PullResponse {
    repeated Document documents = 1;
    string resume_token = 2;
    bool has_more = 3;
}

// Replication - Push
message PushRequest {
    string database = 1;
    repeated Document documents = 2;
}

message PushResponse {
    int32 accepted = 1;
    int32 rejected = 2;
}
```

## 6. Internal Architecture

### 6.1 Package Layout

```
internal/query/
├── interface.go                 # Service interface (unchanged)
├── interface_test.go
└── internal/
    ├── core/
    │   └── engine.go            # Local implementation (unchanged)
    ├── grpc/
    │   ├── server.go            # gRPC server adapter (new)
    │   ├── server_test.go
    │   └── convert.go           # Proto ↔ Domain conversion (new)
    ├── client/
    │   └── client.go            # gRPC client (replace HTTP)
    └── httphandler/             # (deprecated, remove after migration)
        └── handler.go
```

### 6.2 Component Diagram

```
                        ┌─────────────────────────────────────────┐
                        │              query.Service               │
                        │    (interface: GetDocument, Create,      │
                        │     Replace, Patch, Delete, Query,       │
                        │     Pull, Push)                          │
                        └──────────────┬──────────────────────────┘
                                       │ implements
               ┌───────────────────────┼───────────────────────────┐
               │                       │                           │
               ▼                       ▼                           ▼
    ┌──────────────────┐   ┌──────────────────┐        ┌──────────────────┐
    │    core.Engine   │   │   grpc.Server    │        │   client.Client  │
    │   (local impl)   │   │  (gRPC adapter)  │        │  (gRPC client)   │
    └──────────────────┘   └──────────────────┘        └──────────────────┘
             │                      │                           │
             ▼                      ▼                           ▼
    ┌──────────────────┐   ┌──────────────────┐        ┌──────────────────┐
    │ storage.DocStore │   │ grpc.NewServer() │        │ grpc.Dial()      │
    └──────────────────┘   └──────────────────┘        └──────────────────┘
```

## 7. Error Handling

Map domain errors to gRPC status codes:

| Domain Error | gRPC Code | Description |
|--------------|-----------|-------------|
| `model.ErrNotFound` | `NotFound` | Document does not exist |
| `model.ErrPreconditionFailed` | `FailedPrecondition` | CAS/filter condition failed |
| `model.ErrConflict` | `AlreadyExists` | Document already exists |
| `model.ErrInvalidRequest` | `InvalidArgument` | Bad request parameters |
| Other errors | `Internal` | Unexpected server error |

## 8. Migration Strategy

### Phase 1: Parallel Implementation
- Add proto definition
- Implement gRPC server adapter
- Implement gRPC client
- Both HTTP and gRPC available

### Phase 2: Internal Migration
- Update `manager_init.go` to use gRPC
- Update internal consumers (API server, authz)
- Run integration tests

### Phase 3: Deprecate HTTP
- Mark HTTP handler as deprecated
- Remove HTTP handler in future release

## 9. Affected Components

| Component | File | Change |
|-----------|------|--------|
| Proto | `api/proto/query.proto` | New |
| Generated | `api/gen/query/v1/*.go` | New |
| gRPC Server | `internal/query/internal/grpc/server.go` | New |
| gRPC Client | `internal/query/internal/client/client.go` | Replace |
| Conversion | `internal/query/internal/grpc/convert.go` | New |
| Interface | `internal/query/interface.go` | Add factory |
| Manager | `internal/services/manager_init.go` | Update init |
| REST API | `internal/api/rest/handler.go` | Update import |
| Realtime | `internal/api/realtime/server.go` | Update import |
| Authz | `internal/identity/internal/authz/engine.go` | Update import |

## 10. Testing Strategy

- Unit tests for gRPC server adapter
- Unit tests for gRPC client
- Integration tests with actual gRPC connection
- Performance comparison: HTTP vs gRPC

## 11. Open Items

- [ ] Decide on streaming for large query results (optional future enhancement)
- [ ] Health check endpoint in gRPC service
- [ ] Metrics and tracing integration
