# Query Engine and Indexer Integration Design

**Date:** January 11, 2026
**Status:** Design Draft
**Component:** Query Engine + Indexer Integration

## 1. Overview

This document designs the integration between Query Engine and Indexer service.

**Core Principles:**
1. Indexer is a **required dependency** for Query - no fallback to MongoDB
2. **Standalone mode only** (`--standalone`): direct in-process calls allowed
3. **Distributed mode** (default, including `--all`): must use gRPC, even if services are in same process

## 2. Design Rationale

### Why Indexer is Required

1. **Performance guarantee**: All queries go through index, ensuring predictable performance
2. **Clear architecture**: Explicit dependencies, no implicit degradation
3. **Operational visibility**: Query fails immediately if Indexer unavailable
4. **Simplified code**: No fallback logic, reduced complexity

### Why Distributed Mode Must Use gRPC

1. **Consistency**: Behavior is the same regardless of deployment topology
2. **Testability**: Dev environment behaves the same as production
3. **Simplified code**: No "same process or cross-process" branching logic

## 3. Architecture

### 3.1 Mode Determination

| CLI Flag | Config | Mode | Query → Indexer |
|----------|--------|------|-----------------|
| `--standalone` | - | Standalone | Direct call |
| - | `deployment.mode: standalone` | Standalone | Direct call |
| `--all` | - | Distributed | gRPC |
| `--query` | - | Distributed | gRPC |
| (default) | - | Distributed | gRPC |

### 3.2 Standalone Mode (`--standalone`)

```
┌─────────────────────────────────────────────────────┐
│                   Single Process                     │
│                                                      │
│  API ──► Query ──direct call──► Indexer ──► Puller  │
│            │                       │                 │
│            │                       ▼                 │
│            └───────────────────► Storage             │
└─────────────────────────────────────────────────────┘
```

### 3.3 Distributed Mode (default, including `--all`)

```
┌─────────────────┐      gRPC       ┌─────────────────┐
│  API Gateway    │ ───────────────►│  Query Service  │
└─────────────────┘                 └────────┬────────┘
                                             │ gRPC (required)
                                             ▼
                                    ┌─────────────────┐
                                    │ Indexer Service │
                                    └────────┬────────┘
                                             │ gRPC
                                             ▼
                                    ┌─────────────────┐
                                    │ Puller Service  │
                                    └─────────────────┘
```

**Note**: Even with `--all` (all services in same process), Distributed mode must communicate via gRPC.

## 4. Interface Changes

### 4.1 Query Engine

```go
// Before: Indexer optional
func New(storage storage.DocumentStore) *Engine

// After: Indexer required
func New(storage storage.DocumentStore, indexer indexer.Service) *Engine
```

### 4.2 Query Package

```go
// Before
func NewService(store storage.DocumentStore) Service

// After
func NewService(store storage.DocumentStore, idx indexer.Service) Service
```

### 4.3 Error Types

| Error | Meaning |
|-------|---------|
| `ErrIndexerRequired` | Indexer not configured |
| `ErrNoMatchingIndex` | No matching index for query |
| `ErrIndexRebuilding` | Index is rebuilding |
| `ErrIndexNotReady` | Index not ready |

## 5. Configuration

### 5.1 New Config Fields

```yaml
gateway:
  indexer_service_url: ""  # Indexer gRPC address (required for Distributed mode)
```

### 5.2 Startup Commands

```bash
# Standalone - direct in-process calls
syntrix --standalone

# Distributed - all services, but must use gRPC between them
syntrix --all  # requires gateway.indexer_service_url for Query

# Distributed - Query only, requires Indexer gRPC address
syntrix --query  # requires gateway.indexer_service_url
```

## 6. Implementation Tasks

See [tasks/034.2026-01-11-query-indexer-integration.md](/tasks/034.2026-01-11-query-indexer-integration.md)

## 7. Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Indexer down causes query unavailability | Multi-replica deployment + health checks |
| Query fails during index rebuild | Return clear error, client retry |
| Query fails with no matching index | Clear error message, guide to create index |
