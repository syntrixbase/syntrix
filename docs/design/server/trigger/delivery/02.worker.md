# HTTP Delivery Worker

## Overview

The DeliveryWorker executes HTTP webhook requests for delivery tasks.

## Interface

```go
// DeliveryWorker processes delivery tasks by making HTTP requests.
type DeliveryWorker interface {
    ProcessTask(ctx context.Context, task *types.DeliveryTask) error
}
```

## Request Building

### URL

From `task.URL`:

```go
req, err := http.NewRequestWithContext(ctx, "POST", task.URL, body)
```

### Headers

1. **Content-Type**: Always `application/json`
2. **Custom Headers**: From `task.Headers` map
3. **Signature**: HMAC-SHA256 signature (if secret configured)
4. **Authorization**: Bearer token (if auth configured)

```go
// Base headers
req.Header.Set("Content-Type", "application/json")

// Custom headers
for k, v := range task.Headers {
    req.Header.Set(k, v)
}

// Signature
if secret != "" {
    sig := hmacSHA256(body, secret)
    req.Header.Set("X-Syntrix-Signature", sig)
}

// System token
if token != "" {
    req.Header.Set("Authorization", "Bearer " + token)
}
```

### Body

JSON-encoded payload:

```json
{
    "trigger_id": "notify-on-order",
    "database": "myapp",
    "event": "create",
    "collection": "orders",
    "document_id": "order123",
    "payload": {
        "id": "order123",
        "status": "pending",
        "amount": 100
    }
}
```

## Authentication

### Secret Resolution

Secrets are resolved via `SecretsRef`:

```go
if task.SecretsRef != "" {
    secret, err := w.secretProvider.GetSecret(ctx, task.SecretsRef)
    if err != nil {
        return err  // Fail task, retry later
    }
    // Use secret for signing
}
```

**Important**: Secrets are database-scoped. Cross-database reuse is forbidden.

### HMAC Signature

```go
func hmacSHA256(body []byte, secret string) string {
    h := hmac.New(sha256.New, []byte(secret))
    h.Write(body)
    return hex.EncodeToString(h.Sum(nil))
}
```

The signature is set in the `X-Syntrix-Signature` header.

### System Token

For internal services, a system token can be minted:

```go
if w.auth != nil {
    token, err := w.auth.MintToken(ctx, task.Database)
    if err != nil {
        return err
    }
    req.Header.Set("Authorization", "Bearer " + token)
}
```

## Response Handling

### Success (2xx)

```go
if resp.StatusCode >= 200 && resp.StatusCode < 300 {
    return nil  // Success
}
```

### Client Errors (4xx)

```go
if resp.StatusCode >= 400 && resp.StatusCode < 500 {
    if resp.StatusCode == 429 {
        // Rate limited - retry
        return RetryableError{...}
    }
    // Client error - don't retry
    return FatalError{...}
}
```

### Server Errors (5xx)

```go
if resp.StatusCode >= 500 {
    return RetryableError{...}  // Retry
}
```

## Timeout

Tasks have a configurable timeout:

```go
timeout := time.Duration(task.Timeout)
if timeout == 0 {
    timeout = types.DefaultTaskTimeout  // 30s
}

ctx, cancel := context.WithTimeout(ctx, timeout)
defer cancel()
```

## Retry Policy

From `task.RetryPolicy`:

```go
type RetryPolicy struct {
    MaxRetries     int      // Maximum retry attempts
    InitialBackoff Duration // Initial backoff duration
    MaxBackoff     Duration // Maximum backoff duration
    Multiplier     float64  // Backoff multiplier
}
```

### Default Policy

```go
var DefaultRetryPolicy = RetryPolicy{
    MaxRetries:     5,
    InitialBackoff: Duration(1 * time.Second),
    MaxBackoff:     Duration(5 * time.Minute),
    Multiplier:     2.0,
}
```

## Error Types

```go
// RetryableError indicates the task should be retried.
type RetryableError struct {
    Cause   error
    Message string
}

// FatalError indicates the task should not be retried.
type FatalError struct {
    Cause   error
    Message string
}
```

## Observability

### Metrics

| Metric | Tags | Description |
|--------|------|-------------|
| `trigger.worker.request.count` | database, status_code, success | HTTP requests |
| `trigger.worker.request.latency` | database | Request latency |
| `trigger.worker.retry.count` | database | Retry attempts |

### Logging

| Event | Level | Description |
|-------|-------|-------------|
| Request started | Debug | HTTP request initiated |
| Request success | Debug | 2xx response |
| Request failed (retry) | Warn | 5xx or network error |
| Request failed (fatal) | Error | 4xx (non-429) |
| Secret fetch failed | Error | SecretsRef resolution error |

## Implementation Reference

See: `internal/trigger/worker/worker.go`
