# Trigger Service Separation

**Status:** Implemented (2026-01-15)

## Overview

The trigger system is split into two independent services:

| Service | Responsibility | Documentation |
|---------|----------------|---------------|
| **Evaluator** | Watch changes, evaluate conditions, publish tasks | [evaluator/](evaluator/) |
| **Delivery** | Consume tasks, execute HTTP webhooks | [delivery/](delivery/) |

## Why Separate?

1. **Scale services independently** - Delivery workers can scale horizontally
2. **Distributed deployment** - Services can run in separate processes
3. **Clearer ownership** - Each service has focused responsibility

## Implementation

### Code Structure

```
internal/trigger/
├── evaluator/        # Evaluator Service
│   ├── service.go
│   ├── factory.go
│   └── validation.go
├── delivery/         # Delivery Service
│   ├── service.go
│   └── factory.go
├── watcher/          # Document change watcher
├── worker/           # HTTP delivery worker
└── types/            # Shared types
```

### ServiceManager Integration

```go
// Standalone mode - both services in same process
m.initTriggerEvaluator(ctx)
m.initTriggerDelivery(ctx)
```

```yaml
# Distributed mode - separate processes
# evaluator node
services:
  trigger_evaluator: true
  trigger_delivery: false

# delivery node (can scale)
services:
  trigger_evaluator: false
  trigger_delivery: true
```

## Key Design Decisions

### Global Checkpoint

See [evaluator/01.checkpoint.md](evaluator/01.checkpoint.md).

- Uses `sys/checkpoints/trigger_evaluator` (global key)
- Puller returns aggregated progress token
- Database filtering at event level

### NATS JetStream

- Stream: `TRIGGERS` (configurable)
- Subject: `<stream>.<database>.<collection>.<docKey>`
- Shared connection managed by ServiceManager

## Related Tasks

- Implementation: `tasks/037.2026-01-15-trigger-service-separation.md`
