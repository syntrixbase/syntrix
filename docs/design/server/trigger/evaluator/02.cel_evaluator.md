# CEL Evaluator

## Overview

The CEL (Common Expression Language) evaluator validates trigger conditions against document change events.

## Interface

```go
// Evaluator evaluates trigger conditions against events.
type Evaluator interface {
    // Evaluate returns true if the trigger condition matches the event.
    Evaluate(ctx context.Context, trigger *types.Trigger, event events.SyntrixChangeEvent) (bool, error)
}
```

## Condition Syntax

Trigger conditions are CEL expressions that have access to event data:

```yaml
triggers:
  - id: "notify-on-status-change"
    database: "myapp"
    collection: "orders/*"
    events: ["update"]
    condition: 'doc.status == "shipped" && before.status == "pending"'
    url: "https://webhook.example.com/orders"
```

## Available Variables

| Variable | Type | Description |
|----------|------|-------------|
| `event` | string | Event type: "create", "update", "delete" |
| `collection` | string | Document collection path |
| `doc` | map | Current document data (nil for delete) |
| `before` | map | Previous document data (nil for create) |
| `update` | object | Update description (for update events) |

## Collection Matching

The `collection` field supports glob patterns via `path.Match`:

```yaml
# Match specific collection
collection: "users/profiles"

# Match all subcollections
collection: "orders/*"

# Match nested paths
collection: "tenants/*/users"
```

## Examples

### New Document Created

```cel
event == "create" && doc.type == "premium"
```

### Field Changed

```cel
event == "update" && doc.status != before.status
```

### Deleted with Condition

```cel
event == "delete" && before.balance > 0
```

### Complex Condition

```cel
event == "update" &&
doc.status == "approved" &&
before.status == "pending" &&
doc.amount > 1000
```

## Caching

CEL programs are compiled once and cached:

```go
type celEvaluator struct {
    env      *cel.Env
    programs sync.Map  // triggerID -> cel.Program
}
```

## Error Handling

| Scenario | Behavior |
|----------|----------|
| Invalid CEL syntax | Error at trigger load time |
| Runtime evaluation error | Log error, skip trigger (no match) |
| Missing field access | Returns false (safe navigation) |

## Implementation Reference

See: `internal/trigger/evaluator/evaluator.go`
