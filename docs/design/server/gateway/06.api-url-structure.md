# API URL Structure Redesign

**Date:** January 20, 2026
**Status:** Proposed

## 1. Context & Motivation

The current API structure uses implicit database binding via JWT claims:
- Token contains `database` claim
- API paths are `/api/v1/{path}`
- One token can only operate on one database

This design limits flexibility:
- Cannot operate on multiple databases with a single token
- Database context is hidden in token, not visible in URL
- Harder to debug and audit

## 2. Goals

1. **Explicit database in URL** - Database is a visible part of the resource path
2. **Token-database decoupling** - One token can operate on multiple databases
3. **No implicit defaults** - All requests must specify database explicitly
4. **Consistent structure** - All data-plane endpoints follow the same pattern

## 3. New URL Structure

### 3.1 Document Operations

**Old:**
```
GET    /api/v1/{collectionPath}/{id}
POST   /api/v1/{collectionPath}
PUT    /api/v1/{collectionPath}/{id}
PATCH  /api/v1/{collectionPath}/{id}
DELETE /api/v1/{collectionPath}/{id}
```

**New:**
```
GET    /api/v1/databases/{database}/documents/{collectionPath}/{id}
POST   /api/v1/databases/{database}/documents/{collectionPath}
PUT    /api/v1/databases/{database}/documents/{collectionPath}/{id}
PATCH  /api/v1/databases/{database}/documents/{collectionPath}/{id}
DELETE /api/v1/databases/{database}/documents/{collectionPath}/{id}
```

**Examples:**
```
GET    /api/v1/databases/prod/documents/users/user-1
POST   /api/v1/databases/prod/documents/rooms/room-1/messages
PUT    /api/v1/databases/staging/documents/configs/app-config
DELETE /api/v1/databases/prod/documents/rooms/room-1/messages/msg-1
```

### 3.2 Query Operations

**Old:**
```
POST   /api/v1/query
```

**New:**
```
POST   /api/v1/databases/{database}/query
```

**Example:**
```
POST /api/v1/databases/prod/query
{
  "collection": "rooms/room-1/messages",
  "filters": [...],
  "orderBy": [...],
  "limit": 20
}
```

### 3.3 Replication (Internal)

**Old:**
```
GET    /replication/v1/pull
POST   /replication/v1/push
```

**New:**
```
GET    /replication/v1/databases/{database}/pull
POST   /replication/v1/databases/{database}/push
```

### 3.4 Trigger (Internal)

**Old:**
```
POST   /trigger/v1/get
POST   /trigger/v1/query
POST   /trigger/v1/write
```

**New:**
```
POST   /trigger/v1/databases/{database}/get
POST   /trigger/v1/databases/{database}/query
POST   /trigger/v1/databases/{database}/write
```

### 3.5 Unchanged Endpoints

These endpoints operate outside the database context:

```
POST   /auth/v1/signup      - User registration
POST   /auth/v1/login       - User login
POST   /auth/v1/refresh     - Token refresh
POST   /auth/v1/logout      - Token revocation

GET    /admin/users         - List users (global admin)
POST   /admin/users         - Create user (global admin)
...

GET    /health              - Health check
GET    /ready               - Readiness check
```

## 4. Authorization Model Changes

### 4.1 Token Claims

**Old:**
```go
type Claims struct {
    Sub      string `json:"sub"`      // user id
    Username string `json:"username"`
    Role     string `json:"role"`     // "user" | "admin" | "system"
    Database string `json:"database"` // bound to single database
    TenantID string `json:"tid"`
}
```

**New:**
```go
type Claims struct {
    Sub      string   `json:"sub"`      // user id
    Username string   `json:"username"`
    Role     string   `json:"role"`     // "user" | "admin" | "system"
    DBAdmin  []string `json:"db_admin"` // databases with admin access (bypass authz)
    // Database field removed - now extracted from URL
}
```

### 4.2 Authorization Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    Authorization Check                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ role == system? │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │ YES                         │ NO
              ▼                             ▼
        ┌─────────┐              ┌─────────────────┐
        │ ALLOW   │              │ role == admin?  │
        └─────────┘              └────────┬────────┘
                                          │
                          ┌───────────────┴───────────────┐
                          │ YES                           │ NO
                          ▼                               ▼
                    ┌─────────┐              ┌────────────────────┐
                    │ ALLOW   │              │ db in db_admin[]?  │
                    └─────────┘              └──────────┬─────────┘
                                                        │
                                      ┌─────────────────┴─────────────────┐
                                      │ YES                               │ NO
                                      ▼                                   ▼
                                ┌─────────┐                    ┌───────────────────┐
                                │ ALLOW   │                    │ Evaluate AuthZ    │
                                │(bypass) │                    │ Rules (CEL)       │
                                └─────────┘                    └─────────┬─────────┘
                                                                         │
                                                              ┌──────────┴──────────┐
                                                              │ ALLOW               │ DENY
                                                              ▼                     ▼
                                                         ┌─────────┐          ┌─────────┐
                                                         │ ALLOW   │          │ DENY    │
                                                         └─────────┘          └─────────┘
```

### 4.3 Permission Levels

| Role | Scope | Description |
|------|-------|-------------|
| `system` | Global | Internal services, full access to everything |
| `admin` | Global | Global administrator, full access to everything |
| `user` + `db_admin` | Per-database | Database administrator for listed databases, bypasses authz |
| `user` | Per-database | Regular user, controlled by authz rules |

### 4.4 Database Validation

The handler extracts `{database}` from URL and validates:

1. **Format validation** - Database name must match `[a-z0-9][a-z0-9_-]{0,62}[a-z0-9]?`
2. **Existence check** - Database must exist in configuration or be dynamically registered
3. **Authorization** - User must have access (via `db_admin` or authz rules)

## 5. Implementation Plan

### Phase 1: URL Routing
- Update REST handler route registration
- Extract database from URL path
- Update path parsing to handle `/databases/{db}/documents/{path}`

### Phase 2: Token Changes
- Remove `database` from JWT claims
- Add `db_admin` array to claims
- Update token generation/validation

### Phase 3: Authorization
- Update authorization middleware to check `db_admin`
- Modify authz engine to receive database from URL (not token)
- Update rule evaluation context

### Phase 4: Internal Endpoints
- Update replication endpoints
- Update trigger endpoints

### Phase 5: Client & Documentation
- Update SDK/client libraries
- Update API documentation
- Update benchmark tool

## 6. Migration Notes

Since the project is not yet launched, this is a clean-slate change:
- No backward compatibility needed
- No migration scripts required
- All clients updated simultaneously

## 7. Security Considerations

1. **Database enumeration** - Return 403 (not 404) for unauthorized database access to prevent enumeration
2. **Path traversal** - Validate database name strictly, reject `..` or special characters
3. **Token scope expansion** - `db_admin` grants full access; use sparingly
4. **Audit logging** - Include database in all audit log entries

## 8. Examples

### Create a document in production database
```bash
curl -X POST https://api.example.com/api/v1/databases/prod/documents/users \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "Alice", "email": "alice@example.com"}'
```

### Query messages in staging database
```bash
curl -X POST https://api.example.com/api/v1/databases/staging/query \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "collection": "rooms/room-1/messages",
    "filters": [{"field": "timestamp", "op": ">", "value": 1700000000000}],
    "orderBy": [{"field": "timestamp", "direction": "desc"}],
    "limit": 50
  }'
```

### Token with db_admin access
```json
{
  "sub": "user-123",
  "username": "alice",
  "role": "user",
  "db_admin": ["prod", "staging"],
  "iat": 1705700000,
  "exp": 1705700900
}
```
