# Database Management Schema

**Date:** January 2026
**Status:** Draft
**Scope:** PostgreSQL schema design for database metadata storage.

## 1. Overview

Database metadata is stored in PostgreSQL for:
- Strong consistency guarantees
- Transactional integrity
- Alignment with UserStore placement
- Low volume, high importance data

## 2. Table Definition

```sql
CREATE TABLE databases (
    -- Primary identifier (auto-generated: hex(blake3(uuid())[:8]))
    id VARCHAR(16) PRIMARY KEY,

    -- Display information
    display_name VARCHAR(255) NOT NULL,
    description TEXT,

    -- Ownership (matches auth_users.id type: VARCHAR(64))
    owner_id VARCHAR(64) NOT NULL,

    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),

    -- Quota settings (0 = unlimited)
    max_documents BIGINT NOT NULL DEFAULT 0,
    max_storage_bytes BIGINT NOT NULL DEFAULT 0,

    -- Status
    status VARCHAR(20) NOT NULL DEFAULT 'active',

    -- Constraints
    CONSTRAINT fk_databases_owner FOREIGN KEY (owner_id)
        REFERENCES auth_users(id) ON DELETE RESTRICT,
    CONSTRAINT chk_databases_id CHECK (
        id ~ '^[0-9a-f]{16}$' OR id = 'default'
    ),
    CONSTRAINT chk_databases_status CHECK (
        status IN ('active', 'suspended', 'deleting')
    ),
    CONSTRAINT chk_databases_max_documents CHECK (max_documents >= 0),
    CONSTRAINT chk_databases_max_storage CHECK (max_storage_bytes >= 0)
);

-- Performance indexes
CREATE INDEX idx_databases_owner ON databases(owner_id);
CREATE INDEX idx_databases_status ON databases(status);
CREATE INDEX idx_databases_created_at ON databases(created_at DESC);

-- Composite index for common queries
CREATE INDEX idx_databases_owner_status ON databases(owner_id, status);
```

## 3. Column Definitions

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | VARCHAR(16) | NO | - | Auto-generated hex ID |
| `display_name` | VARCHAR(255) | NO | - | Human-readable name |
| `description` | TEXT | YES | NULL | Optional description |
| `owner_id` | VARCHAR(64) | NO | - | Owner user ID (matches auth_users.id) |
| `created_at` | TIMESTAMPTZ | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NO | NOW() | Last update timestamp |
| `max_documents` | BIGINT | NO | 0 | Document limit (0=unlimited) |
| `max_storage_bytes` | BIGINT | NO | 0 | Storage limit (0=unlimited) |
| `status` | VARCHAR(20) | NO | 'active' | Database status |

## 4. Constraints

### 4.1 Primary Key
- `id`: 16-character hex string (auto-generated)

### 4.2 Foreign Keys
- `owner_id` â†’ `auth_users(id)`: Owner must exist
- `ON DELETE RESTRICT`: Cannot delete user with databases

### 4.3 Check Constraints

**ID Format**
```sql
id ~ '^[0-9a-f]{16}$' OR id = 'default'
```
- 16 lowercase hex characters
- Special case: `default` for system database

**Status Values**
```sql
status IN ('active', 'suspended', 'deleting')
```

**Non-negative Quotas**
```sql
max_documents >= 0
max_storage_bytes >= 0
```

## 5. Indexes

| Index | Columns | Purpose |
|-------|---------|---------|
| `pk_databases` | `id` | Primary key lookup |
| `idx_databases_owner` | `owner_id` | List by owner, quota check |
| `idx_databases_status` | `status` | Filter by status |
| `idx_databases_created_at` | `created_at DESC` | Recent databases |
| `idx_databases_owner_status` | `owner_id, status` | Owner + status filter |

## 6. Go Struct Mapping

```go
package database

import (
    "encoding/hex"
    "time"

    "github.com/google/uuid"
    "github.com/zeebo/blake3"
)

type Database struct {
    ID              string         `db:"id"`
    DisplayName     string         `db:"display_name"`
    Description     *string        `db:"description"`
    OwnerID         string         `db:"owner_id"`
    CreatedAt       time.Time      `db:"created_at"`
    UpdatedAt       time.Time      `db:"updated_at"`
    MaxDocuments    int64          `db:"max_documents"`
    MaxStorageBytes int64          `db:"max_storage_bytes"`
    Status          DatabaseStatus `db:"status"`
}

type DatabaseStatus string

const (
    StatusActive    DatabaseStatus = "active"
    StatusSuspended DatabaseStatus = "suspended"
    StatusDeleting  DatabaseStatus = "deleting"
)

// GenerateID creates a new database ID using hex(blake3(uuid())[:8])
// This is consistent with the user ID generation in UserStore.
func GenerateID() string {
    u := uuid.New()
    hash := blake3.Sum256(u[:])
    return hex.EncodeToString(hash[:8])
}
```

## 7. Common Queries

### 7.1 Create Database

```sql
INSERT INTO databases (id, display_name, description, owner_id, max_documents, max_storage_bytes, status)
VALUES ($1, $2, $3, $4, $5, $6, 'active')
RETURNING id, display_name, description, owner_id, created_at, updated_at,
          max_documents, max_storage_bytes, status;
```

### 7.2 Get Database by ID

```sql
SELECT id, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE id = $1;
```

### 7.3 List Databases by Owner

```sql
SELECT id, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE owner_id = $1
  AND status != 'deleting'
ORDER BY created_at DESC
LIMIT $2 OFFSET $3;
```

### 7.4 Count Databases by Owner (Quota Check)

```sql
SELECT COUNT(*) FROM databases
WHERE owner_id = $1
  AND status != 'deleting';
```

### 7.5 Check Database Exists

```sql
SELECT EXISTS(
    SELECT 1 FROM databases
    WHERE id = $1
      AND status = 'active'
);
```

### 7.6 Update Database

```sql
UPDATE databases
SET display_name = COALESCE($2, display_name),
    description = COALESCE($3, description),
    status = COALESCE($4, status),
    max_documents = COALESCE($5, max_documents),
    max_storage_bytes = COALESCE($6, max_storage_bytes),
    updated_at = NOW()
WHERE id = $1
RETURNING id, display_name, description, owner_id, created_at, updated_at,
          max_documents, max_storage_bytes, status;
```

### 7.7 Delete Database (Soft)

```sql
UPDATE databases
SET status = 'deleting',
    updated_at = NOW()
WHERE id = $1
RETURNING id, status;
```

### 7.8 Delete Database (Hard)

```sql
DELETE FROM databases WHERE id = $1;
```

### 7.9 List All Databases (Admin)

```sql
SELECT id, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE ($1::VARCHAR IS NULL OR owner_id = $1)
  AND ($2::VARCHAR IS NULL OR status = $2)
ORDER BY created_at DESC
LIMIT $3 OFFSET $4;
```

### 7.10 Count All Databases (Admin)

```sql
SELECT COUNT(*) FROM databases
WHERE ($1::VARCHAR IS NULL OR owner_id = $1)
  AND ($2::VARCHAR IS NULL OR status = $2);
```

## 8. Migration Script

```sql
-- Migration: 001_create_databases_table.sql

BEGIN;

CREATE TABLE IF NOT EXISTS databases (
    id VARCHAR(16) PRIMARY KEY,
    display_name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id VARCHAR(64) NOT NULL,  -- Matches auth_users.id type
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    max_documents BIGINT NOT NULL DEFAULT 0,
    max_storage_bytes BIGINT NOT NULL DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'active',

    CONSTRAINT fk_databases_owner FOREIGN KEY (owner_id)
        REFERENCES auth_users(id) ON DELETE RESTRICT,
    CONSTRAINT chk_databases_id CHECK (
        id ~ '^[0-9a-f]{16}$' OR id = 'default'
    ),
    CONSTRAINT chk_databases_status CHECK (
        status IN ('active', 'suspended', 'deleting')
    ),
    CONSTRAINT chk_databases_max_documents CHECK (max_documents >= 0),
    CONSTRAINT chk_databases_max_storage CHECK (max_storage_bytes >= 0)
);

CREATE INDEX IF NOT EXISTS idx_databases_owner ON databases(owner_id);
CREATE INDEX IF NOT EXISTS idx_databases_status ON databases(status);
CREATE INDEX IF NOT EXISTS idx_databases_created_at ON databases(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_databases_owner_status ON databases(owner_id, status);

COMMIT;
```

**Note:** The `default` database is created at application startup (not in migration) after the `syntrix` admin user is initialized. See [01.architecture.md](01.architecture.md) Section 5.4 for bootstrap logic.

## 9. Notes

### 9.1 Owner Deletion
- `ON DELETE RESTRICT` prevents deleting users who own databases
- Admin must transfer or delete databases before removing user

### 9.2 Default Database
- ID check constraint allows 'default' as special case
- Created at application startup, owned by `syntrix` admin user
- Cannot be deleted (protected)

### 9.3 Soft Delete
- Deletion sets `status = 'deleting'`
- Background job performs actual cleanup
- Hard delete after cleanup completes

### 9.4 Performance Considerations
- Owner queries use `idx_databases_owner`
- Quota checks are single-column COUNT
- Existence checks hit primary key

## 10. Related Documents

- [01.architecture.md](01.architecture.md) - Architecture overview
- [02.api.md](02.api.md) - API endpoints design
- [04.integration.md](04.integration.md) - Integration with document operations
- [../storage/06.user-store-postgres.md](../storage/06.user-store-postgres.md) - User storage reference
