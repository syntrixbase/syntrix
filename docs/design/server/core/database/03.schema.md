# Database Management Schema

**Date:** January 2026
**Status:** Draft
**Scope:** PostgreSQL schema design for database metadata storage.

## 1. Overview

Database metadata is stored in PostgreSQL for:
- Strong consistency guarantees
- Transactional integrity
- Alignment with UserStore placement
- Low volume, high importance data

## 2. Table Definition

```sql
CREATE TABLE databases (
    -- Primary identifier (auto-generated: hex(blake3(uuid())[:8]))
    id VARCHAR(16) PRIMARY KEY,

    -- URL-friendly identifier (optional, user-defined, immutable once set)
    slug VARCHAR(63) UNIQUE,

    -- Display information
    display_name VARCHAR(255) NOT NULL,
    description TEXT,

    -- Ownership (matches auth_users.id type: VARCHAR(64))
    -- Note: No foreign key constraint - databases and auth_users may be in different PostgreSQL instances
    owner_id VARCHAR(64) NOT NULL,

    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),

    -- Quota settings (0 = unlimited)
    max_documents BIGINT NOT NULL DEFAULT 0,
    max_storage_bytes BIGINT NOT NULL DEFAULT 0,

    -- Status
    status VARCHAR(20) NOT NULL DEFAULT 'active',

    -- Constraints
    CONSTRAINT chk_databases_id CHECK (
        id ~ '^[0-9a-f]{16}$'
    ),
    CONSTRAINT chk_databases_slug CHECK (
        slug IS NULL OR slug ~ '^[a-z][a-z0-9-]{2,62}$'
    ),
    CONSTRAINT chk_databases_status CHECK (
        status IN ('active', 'suspended', 'deleting')
    ),
    CONSTRAINT chk_databases_max_documents CHECK (max_documents >= 0),
    CONSTRAINT chk_databases_max_storage CHECK (max_storage_bytes >= 0)
);

-- Performance indexes
CREATE INDEX idx_databases_owner ON databases(owner_id);
CREATE INDEX idx_databases_status ON databases(status);
CREATE INDEX idx_databases_created_at ON databases(created_at DESC);
CREATE INDEX idx_databases_slug ON databases(slug) WHERE slug IS NOT NULL;

-- Composite index for common queries
CREATE INDEX idx_databases_owner_status ON databases(owner_id, status);
```

## 3. Column Definitions

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | VARCHAR(16) | NO | - | Auto-generated hex ID |
| `slug` | VARCHAR(63) | YES | NULL | URL-friendly identifier (immutable once set) |
| `display_name` | VARCHAR(255) | NO | - | Human-readable name |
| `description` | TEXT | YES | NULL | Optional description |
| `owner_id` | VARCHAR(64) | NO | - | Owner user ID (matches auth_users.id) |
| `created_at` | TIMESTAMPTZ | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NO | NOW() | Last update timestamp |
| `max_documents` | BIGINT | NO | 0 | Document limit (0=unlimited) |
| `max_storage_bytes` | BIGINT | NO | 0 | Storage limit (0=unlimited) |
| `status` | VARCHAR(20) | NO | 'active' | Database status |

## 4. Constraints

### 4.1 Primary Key
- `id`: 16-character hex string (auto-generated)

### 4.2 Unique Constraints
- `slug`: URL-friendly identifier, globally unique when set

### 4.3 Foreign Keys
- **None**: `databases` and `auth_users` tables may reside in different PostgreSQL instances
- Owner validation is performed at the application layer

### 4.4 Check Constraints

**ID Format**
```sql
id ~ '^[0-9a-f]{16}$'
```
- 16 lowercase hex characters
- Auto-generated, never user-specified

**Slug Format**
```sql
slug IS NULL OR slug ~ '^[a-z][a-z0-9-]{2,62}$'
```
- Starts with lowercase letter
- Only lowercase letters, digits, and hyphens
- Length: 3-63 characters
- Optional (can be NULL)
- Immutable once set (enforced at application layer)
- Reserved slugs: `default`, `admin`, `system`, `api`, `auth` (enforced at application layer)

**Status Values**
```sql
status IN ('active', 'suspended', 'deleting')
```

**Non-negative Quotas**
```sql
max_documents >= 0
max_storage_bytes >= 0
```

## 5. Indexes

| Index | Columns | Purpose |
|-------|---------|---------|
| `pk_databases` | `id` | Primary key lookup |
| `idx_databases_slug` | `slug` (partial, WHERE slug IS NOT NULL) | Slug lookup for URL routing |
| `idx_databases_owner` | `owner_id` | List by owner, quota check |
| `idx_databases_status` | `status` | Filter by status |
| `idx_databases_created_at` | `created_at DESC` | Recent databases |
| `idx_databases_owner_status` | `owner_id, status` | Owner + status filter |

## 6. Go Struct Mapping

```go
package database

import (
    "encoding/hex"
    "time"

    "github.com/google/uuid"
    "github.com/zeebo/blake3"
)

type Database struct {
    ID              string         `db:"id"`
    Slug            *string        `db:"slug"`
    DisplayName     string         `db:"display_name"`
    Description     *string        `db:"description"`
    OwnerID         string         `db:"owner_id"`
    CreatedAt       time.Time      `db:"created_at"`
    UpdatedAt       time.Time      `db:"updated_at"`
    MaxDocuments    int64          `db:"max_documents"`
    MaxStorageBytes int64          `db:"max_storage_bytes"`
    Status          DatabaseStatus `db:"status"`
}

type DatabaseStatus string

const (
    StatusActive    DatabaseStatus = "active"
    StatusSuspended DatabaseStatus = "suspended"
    StatusDeleting  DatabaseStatus = "deleting"
)

// GenerateID creates a new database ID using hex(blake3(uuid())[:8])
// This is consistent with the user ID generation in UserStore.
func GenerateID() string {
    u := uuid.New()
    hash := blake3.Sum256(u[:])
    return hex.EncodeToString(hash[:8])
}

// Reserved slugs that cannot be used by regular users
// Note: "default" is reserved for the system-created default database
var ReservedSlugs = map[string]bool{
    "default": true,  // System default database
    "admin":   true,
    "system":  true,
    "api":     true,
    "auth":    true,
}

// ValidateSlug checks if a slug is valid and not reserved
func ValidateSlug(slug string) error {
    if slug == "" {
        return nil // Empty is allowed (optional)
    }
    if ReservedSlugs[slug] {
        return ErrReservedSlug
    }
    // Regex validation: ^[a-z][a-z0-9-]{2,62}$
    if len(slug) < 3 || len(slug) > 63 {
        return ErrInvalidSlugLength
    }
    if slug[0] < 'a' || slug[0] > 'z' {
        return ErrInvalidSlugFormat
    }
    for _, c := range slug[1:] {
        if !((c >= 'a' && c <= 'z') || (c >= '0' && c <= '9') || c == '-') {
            return ErrInvalidSlugFormat
        }
    }
    return nil
}
```

## 7. Common Queries

### 7.1 Create Database

```sql
INSERT INTO databases (id, slug, display_name, description, owner_id, max_documents, max_storage_bytes, status)
VALUES ($1, $2, $3, $4, $5, $6, $7, 'active')
RETURNING id, slug, display_name, description, owner_id, created_at, updated_at,
          max_documents, max_storage_bytes, status;
```

### 7.2 Get Database by ID

```sql
SELECT id, slug, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE id = $1;
```

### 7.3 Get Database by Slug

```sql
SELECT id, slug, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE slug = $1;
```

### 7.4 Resolve Identifier (for URL routing)

Used to resolve a URL path identifier to a database. The identifier can be:
- A slug (e.g., `my-app`)
- An ID with prefix (e.g., `id:a1b2c3d4e5f67890`)

```go
func (s *Store) ResolveIdentifier(ctx context.Context, identifier string) (*Database, error) {
    if strings.HasPrefix(identifier, "id:") {
        return s.GetByID(ctx, identifier[3:])
    }
    return s.GetBySlug(ctx, identifier)
}
```

### 7.5 List Databases by Owner

```sql
SELECT id, slug, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE owner_id = $1
  AND status != 'deleting'
ORDER BY created_at DESC
LIMIT $2 OFFSET $3;
```

### 7.6 Count Databases by Owner (Quota Check)

Note: `deleting` status databases count toward quota to prevent abuse.

```sql
SELECT COUNT(*) FROM databases
WHERE owner_id = $1;
```

### 7.7 Check Database Exists

```sql
SELECT EXISTS(
    SELECT 1 FROM databases
    WHERE id = $1
      AND status = 'active'
);
```

### 7.8 Update Database

Note: Slug can only be set if currently NULL (immutable once set).

```sql
UPDATE databases
SET display_name = COALESCE($2, display_name),
    description = COALESCE($3, description),
    slug = CASE WHEN slug IS NULL THEN $4 ELSE slug END,
    status = COALESCE($5, status),
    max_documents = COALESCE($6, max_documents),
    max_storage_bytes = COALESCE($7, max_storage_bytes),
    updated_at = NOW()
WHERE id = $1
RETURNING id, slug, display_name, description, owner_id, created_at, updated_at,
          max_documents, max_storage_bytes, status;
```

### 7.9 Delete Database (Soft)

```sql
UPDATE databases
SET status = 'deleting',
    updated_at = NOW()
WHERE id = $1
RETURNING id, slug, status;
```

### 7.10 Delete Database (Hard)

```sql
DELETE FROM databases WHERE id = $1;
```

### 7.11 List All Databases (Admin)

```sql
SELECT id, slug, display_name, description, owner_id, created_at, updated_at,
       max_documents, max_storage_bytes, status
FROM databases
WHERE ($1::VARCHAR IS NULL OR owner_id = $1)
  AND ($2::VARCHAR IS NULL OR status = $2)
ORDER BY created_at DESC
LIMIT $3 OFFSET $4;
```

### 7.12 Count All Databases (Admin)

```sql
SELECT COUNT(*) FROM databases
WHERE ($1::VARCHAR IS NULL OR owner_id = $1)
  AND ($2::VARCHAR IS NULL OR status = $2);
```

## 8. Migration Script

```sql
-- Migration: 001_create_databases_table.sql

BEGIN;

CREATE TABLE IF NOT EXISTS databases (
    id VARCHAR(16) PRIMARY KEY,
    slug VARCHAR(63) UNIQUE,
    display_name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id VARCHAR(64) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    max_documents BIGINT NOT NULL DEFAULT 0,
    max_storage_bytes BIGINT NOT NULL DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'active',

    -- No foreign key to auth_users - tables may be in different PostgreSQL instances
    CONSTRAINT chk_databases_id CHECK (
        id ~ '^[0-9a-f]{16}$'
    ),
    CONSTRAINT chk_databases_slug CHECK (
        slug IS NULL OR slug ~ '^[a-z][a-z0-9-]{2,62}$'
    ),
    CONSTRAINT chk_databases_status CHECK (
        status IN ('active', 'suspended', 'deleting')
    ),
    CONSTRAINT chk_databases_max_documents CHECK (max_documents >= 0),
    CONSTRAINT chk_databases_max_storage CHECK (max_storage_bytes >= 0)
);

CREATE INDEX IF NOT EXISTS idx_databases_owner ON databases(owner_id);
CREATE INDEX IF NOT EXISTS idx_databases_status ON databases(status);
CREATE INDEX IF NOT EXISTS idx_databases_created_at ON databases(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_databases_slug ON databases(slug) WHERE slug IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_databases_owner_status ON databases(owner_id, status);

COMMIT;
```

**Note:** The `default` database (slug: `default`) is created at application startup after the `syntrix` admin user is initialized. See [01.architecture.md](01.architecture.md) Section 5.4 for bootstrap logic.

## 9. Notes

### 9.1 Owner Validation
- No foreign key constraint between `databases` and `auth_users` tables
- Owner validation is performed at the application layer
- This allows the tables to reside in different PostgreSQL instances

### 9.2 Default Database
- Created at application startup with slug `default`
- Owned by `syntrix` admin user
- Cannot be deleted (protected)

### 9.3 Slug Immutability
- Slug can be set at creation or added later via update
- Once set, slug cannot be changed (enforced at application layer)
- Deleted databases release their slug for immediate reuse

### 9.4 Quota Counting
- All databases (including `deleting` status) count toward user quota
- This prevents abuse via rapid create/delete cycles

### 9.5 Soft Delete
- Deletion sets `status = 'deleting'`
- Background job performs actual cleanup
- Hard delete after cleanup completes

### 9.6 Performance Considerations
- Slug lookups use `idx_databases_slug` (partial index)
- Owner queries use `idx_databases_owner`
- Quota checks are simple COUNT (includes all statuses)
- Existence checks hit primary key

## 10. Related Documents

- [01.architecture.md](01.architecture.md) - Architecture overview
- [02.api.md](02.api.md) - API endpoints design
- [04.integration.md](04.integration.md) - Integration with document operations
- [../storage/06.user-store-postgres.md](../storage/06.user-store-postgres.md) - User storage reference
