# Database Management API

**Date:** January 2026
**Status:** Draft
**Scope:** REST API endpoints for database management (User and Admin).

## 1. Overview

Two sets of APIs for database management:
- **User API** (`/api/v1/databases`): Users manage their own databases within quota limits
- **Admin API** (`/admin/databases`): Admins manage all databases without restrictions

### Important: Management vs Usage

These APIs are for **database management** (creating, updating, deleting database metadata), not for **database usage** (document operations).

- **Management**: Only the database owner can manage (update/delete) the database
- **Usage**: Any authenticated user can use any database for document operations (subject to security rules)

For example, a user who did not create the `default` database can still read/write documents in it via `/api/v1/databases/default/documents/...`.

## 2. User API (`/api/v1/databases`)

Regular users can manage their own databases within quota limits.

### 2.1 Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/v1/databases` | Create database (within quota) |
| GET | `/api/v1/databases` | List own databases |
| GET | `/api/v1/databases/{identifier}` | Get own database details |
| PATCH | `/api/v1/databases/{identifier}` | Update own database metadata |
| DELETE | `/api/v1/databases/{identifier}` | Delete own database |

**Note on `{identifier}`:** Can be either:
- A slug (e.g., `my-app-prod`)
- An ID with `id:` prefix (e.g., `id:a1b2c3d4e5f67890`)

### 2.2 Create Database

**Request**
```http
POST /api/v1/databases
Content-Type: application/json
Authorization: Bearer <user-token>

{
    "slug": "my-app-prod",
    "display_name": "My App Production",
    "description": "Production database for My App"
}
```

**Fields:**
- `slug` (optional): URL-friendly identifier. If not provided, database can only be accessed via `id:` prefix.
- `display_name` (required): Human-readable name.
- `description` (optional): Description.

**Response (201 Created)**
```json
{
    "id": "a1b2c3d4e5f67890",
    "slug": "my-app-prod",
    "display_name": "My App Production",
    "description": "Production database for My App",
    "owner_id": "user-123",
    "created_at": "2026-01-23T10:00:00Z",
    "updated_at": "2026-01-23T10:00:00Z",
    "status": "active",
    "settings": {
        "max_documents": 0,
        "max_storage_bytes": 0
    }
}
```

**Note:** The `id` is auto-generated and cannot be specified by the user.

**Error Responses**

*400 Bad Request - Missing display_name*
```json
{
    "error": {
        "code": "invalid_request",
        "message": "display_name is required"
    }
}
```

*400 Bad Request - Invalid slug format*
```json
{
    "error": {
        "code": "invalid_slug",
        "message": "Slug must start with a letter and contain only lowercase letters, numbers, and hyphens (3-63 characters)"
    }
}
```

*400 Bad Request - Reserved slug*
```json
{
    "error": {
        "code": "reserved_slug",
        "message": "The slug 'admin' is reserved and cannot be used"
    }
}
```

*409 Conflict - Slug already exists*
```json
{
    "error": {
        "code": "slug_exists",
        "message": "A database with slug 'my-app-prod' already exists"
    }
}
```

*403 Quota Exceeded*
```json
{
    "error": {
        "code": "quota_exceeded",
        "message": "Maximum database limit reached (3/3). Delete an existing database or contact admin."
    }
}
```

### 2.3 List Databases

**Request**
```http
GET /api/v1/databases?limit=10&offset=0
Authorization: Bearer <user-token>
```

**Response (200 OK)**
```json
{
    "databases": [
        {
            "id": "a1b2c3d4e5f67890",
            "slug": "my-app-prod",
            "display_name": "My App Production",
            "owner_id": "user-123",
            "created_at": "2026-01-23T10:00:00Z",
            "status": "active"
        },
        {
            "id": "b2c3d4e5f6789012",
            "slug": null,
            "display_name": "My App Staging",
            "owner_id": "user-123",
            "created_at": "2026-01-22T10:00:00Z",
            "status": "active"
        }
    ],
    "total": 2,
    "quota": {
        "used": 2,
        "limit": 3
    }
}
```

### 2.4 Get Database

**Request**
```http
GET /api/v1/databases/my-app-prod
Authorization: Bearer <user-token>
```

Or using ID:
```http
GET /api/v1/databases/id:a1b2c3d4e5f67890
Authorization: Bearer <user-token>
```

**Response (200 OK)**
```json
{
    "id": "a1b2c3d4e5f67890",
    "slug": "my-app-prod",
    "display_name": "My App Production",
    "description": "Production database for My App",
    "owner_id": "user-123",
    "created_at": "2026-01-23T10:00:00Z",
    "updated_at": "2026-01-23T10:00:00Z",
    "status": "active",
    "settings": {
        "max_documents": 0,
        "max_storage_bytes": 0
    }
}
```

**Error Responses**

*403 Forbidden - Not Owner*
```json
{
    "error": {
        "code": "forbidden",
        "message": "You do not have permission to access this database"
    }
}
```

*404 Not Found*
```json
{
    "error": {
        "code": "database_not_found",
        "message": "Database 'my-app-prod' not found"
    }
}
```

### 2.5 Update Database

**Request**
```http
PATCH /api/v1/databases/my-app-prod
Content-Type: application/json
Authorization: Bearer <user-token>

{
    "display_name": "My App Production (Updated)",
    "description": "Updated description",
    "slug": "my-new-slug"
}
```

**Updatable Fields:**
- `display_name`: Can be changed anytime
- `description`: Can be changed anytime
- `slug`: Can only be set if currently null (immutable once set)

**Response (200 OK)**
```json
{
    "id": "a1b2c3d4e5f67890",
    "slug": "my-new-slug",
    "display_name": "My App Production (Updated)",
    "description": "Updated description",
    "owner_id": "user-123",
    "created_at": "2026-01-23T10:00:00Z",
    "updated_at": "2026-01-23T11:00:00Z",
    "status": "active",
    "settings": {
        "max_documents": 0,
        "max_storage_bytes": 0
    }
}
```

**Error Responses**

*400 Bad Request - Slug already set*
```json
{
    "error": {
        "code": "slug_immutable",
        "message": "Slug cannot be changed once set"
    }
}
```

**Non-Updatable Fields (by user)**
- `id` (immutable)
- `owner_id` (immutable)
- `status` (system-managed)
- `settings` (admin-only)
- `slug` (immutable once set)

### 2.6 Delete Database

**Request**
```http
DELETE /api/v1/databases/my-app-staging
Authorization: Bearer <user-token>
```

Or using ID:
```http
DELETE /api/v1/databases/id:b2c3d4e5f6789012
Authorization: Bearer <user-token>
```

**Response (200 OK)**
```json
{
    "id": "b2c3d4e5f6789012",
    "slug": null,
    "status": "deleting",
    "message": "Database deletion initiated"
}
```

**Error Responses**

*403 Forbidden - Not Owner*
```json
{
    "error": {
        "code": "forbidden",
        "message": "You do not have permission to delete this database"
    }
}
```

*400 Bad Request - Protected Database*
```json
{
    "error": {
        "code": "protected_database",
        "message": "Cannot delete the 'default' database"
    }
}
```

## 3. Admin API (`/admin/databases`)

Admins can manage all databases without quota restrictions.

### 3.1 Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | `/admin/databases` | Create database (no quota) |
| GET | `/admin/databases` | List all databases |
| GET | `/admin/databases/{identifier}` | Get any database details |
| PATCH | `/admin/databases/{identifier}` | Update any database metadata |
| DELETE | `/admin/databases/{identifier}` | Delete any database |

**Note on `{identifier}`:** Same as User API - can be slug or `id:` prefixed ID.

### 3.2 Create Database (Admin)

**Request**
```http
POST /admin/databases
Content-Type: application/json
Authorization: Bearer <admin-token>

{
    "slug": "customer-abc",
    "display_name": "Customer ABC Database",
    "description": "Dedicated database for Customer ABC",
    "owner_id": "user-456",
    "settings": {
        "max_documents": 1000000,
        "max_storage_bytes": 10737418240
    }
}
```

**Response (201 Created)**
```json
{
    "id": "c3d4e5f678901234",
    "slug": "customer-abc",
    "display_name": "Customer ABC Database",
    "description": "Dedicated database for Customer ABC",
    "owner_id": "user-456",
    "created_at": "2026-01-23T10:00:00Z",
    "updated_at": "2026-01-23T10:00:00Z",
    "status": "active",
    "settings": {
        "max_documents": 1000000,
        "max_storage_bytes": 10737418240
    }
}
```

**Admin-Only Fields**
- `slug`: Can specify URL-friendly identifier
- `owner_id`: Can specify any user ID as owner
- `settings`: Can set quota limits per database

### 3.3 List All Databases (Admin)

**Request**
```http
GET /admin/databases?limit=10&offset=0&owner=user-123&status=active
Authorization: Bearer <admin-token>
```

**Query Parameters**
| Parameter | Type | Description |
|-----------|------|-------------|
| `limit` | int | Max results (default: 20, max: 100) |
| `offset` | int | Pagination offset |
| `owner` | string | Filter by owner ID |
| `status` | string | Filter by status (active, suspended, deleting) |

**Response (200 OK)**
```json
{
    "databases": [
        {
            "id": "f1e2d3c4b5a69780",
            "slug": "default",
            "display_name": "Default Database",
            "owner_id": "syntrix-admin-id",
            "created_at": "2026-01-01T00:00:00Z",
            "status": "active"
        },
        {
            "id": "a1b2c3d4e5f67890",
            "slug": "my-app-prod",
            "display_name": "My App Production",
            "owner_id": "user-123",
            "created_at": "2026-01-23T10:00:00Z",
            "status": "active"
        },
        {
            "id": "c3d4e5f678901234",
            "slug": "customer-abc",
            "display_name": "Customer ABC Database",
            "owner_id": "user-456",
            "created_at": "2026-01-23T10:00:00Z",
            "status": "active"
        }
    ],
    "total": 3
}
```

### 3.4 Update Database (Admin)

**Request**
```http
PATCH /admin/databases/customer-abc
Content-Type: application/json
Authorization: Bearer <admin-token>

{
    "display_name": "Customer ABC (Premium)",
    "status": "suspended",
    "settings": {
        "max_documents": 5000000,
        "max_storage_bytes": 53687091200
    }
}
```

**Admin-Updatable Fields**
- `display_name`
- `description`
- `slug` (can only be set if currently null)
- `status` (active, suspended)
- `settings.max_documents`
- `settings.max_storage_bytes`

**Response (200 OK)**
```json
{
    "id": "c3d4e5f678901234",
    "slug": "customer-abc",
    "display_name": "Customer ABC (Premium)",
    "description": "Dedicated database for Customer ABC",
    "owner_id": "user-456",
    "created_at": "2026-01-23T10:00:00Z",
    "updated_at": "2026-01-23T12:00:00Z",
    "status": "suspended",
    "settings": {
        "max_documents": 5000000,
        "max_storage_bytes": 53687091200
    }
}
```

### 3.5 Delete Database (Admin)

**Request**
```http
DELETE /admin/databases/customer-abc
Authorization: Bearer <admin-token>
```

**Response (200 OK)**
```json
{
    "id": "c3d4e5f678901234",
    "slug": "customer-abc",
    "status": "deleting",
    "message": "Database deletion initiated"
}
```

## 4. Common Error Codes

| HTTP Status | Error Code | Description |
|-------------|------------|-------------|
| 400 | `invalid_request` | Malformed request body |
| 400 | `invalid_slug` | Slug format validation failed |
| 400 | `reserved_slug` | Attempted to use a reserved slug |
| 400 | `slug_immutable` | Attempted to change an already-set slug |
| 400 | `protected_database` | Cannot delete protected database |
| 401 | `unauthorized` | Missing or invalid token |
| 403 | `forbidden` | Not owner of database |
| 403 | `quota_exceeded` | User database limit reached |
| 404 | `database_not_found` | Database doesn't exist |
| 409 | `slug_exists` | Slug already taken by another database |
| 500 | `internal_error` | Server error |

## 5. Request/Response Types

### 5.1 CreateDatabaseRequest

```go
type CreateDatabaseRequest struct {
    Slug        *string           `json:"slug,omitempty" validate:"omitempty,min=3,max=63"`
    DisplayName string            `json:"display_name" validate:"required,max=255"`
    Description string            `json:"description,omitempty" validate:"max=1000"`
    OwnerID     string            `json:"owner_id,omitempty"`    // Admin only
    Settings    *DatabaseSettings `json:"settings,omitempty"`    // Admin only
}
```

Note: `id` is not included - it is auto-generated by the server.

### 5.2 UpdateDatabaseRequest

```go
type UpdateDatabaseRequest struct {
    Slug        *string           `json:"slug,omitempty" validate:"omitempty,min=3,max=63"` // Only if currently null
    DisplayName *string           `json:"display_name,omitempty" validate:"omitempty,max=255"`
    Description *string           `json:"description,omitempty" validate:"omitempty,max=1000"`
    Status      *DatabaseStatus   `json:"status,omitempty"`      // Admin only
    Settings    *DatabaseSettings `json:"settings,omitempty"`    // Admin only
}
```

### 5.3 ListDatabasesResponse

```go
type ListDatabasesResponse struct {
    Databases []*DatabaseSummary `json:"databases"`
    Total     int                `json:"total"`
    Quota     *QuotaInfo         `json:"quota,omitempty"` // User API only
}

type DatabaseSummary struct {
    ID          string         `json:"id"`
    Slug        *string        `json:"slug"`
    DisplayName string         `json:"display_name"`
    OwnerID     string         `json:"owner_id"`
    CreatedAt   time.Time      `json:"created_at"`
    Status      DatabaseStatus `json:"status"`
}

type QuotaInfo struct {
    Used  int `json:"used"`
    Limit int `json:"limit"`
}
```

## 6. Related Documents

- [01.architecture.md](01.architecture.md) - Architecture overview
- [03.schema.md](03.schema.md) - PostgreSQL schema design
- [04.integration.md](04.integration.md) - Integration with document operations
