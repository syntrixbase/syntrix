# User Store Migration to PostgreSQL

## 1. Overview

Migrate `UserStore` from MongoDB to PostgreSQL. The `TokenRevocationStore` remains in MongoDB (TTL index for auto-cleanup).

## 2. Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| User.Database field | Remove | Users are globally unique; field unused |
| Profile storage | JSONB | Flexible, supports GIN indexing if needed |
| PG Driver | `github.com/lib/pq` | Stable, widely used |
| Mongo UserStore | Delete | No backwards compatibility needed |
| AuthProvider location | `storage/auth_provider.go` | Cross-backend composition layer |

## 3. User Struct Changes

- Remove `Database` field (unused, users are globally unique)
- Remove `bson` tags (no longer stored in MongoDB)

## 4. PostgreSQL Schema

```sql
CREATE TABLE users (
    id              VARCHAR(32) PRIMARY KEY,
    username        VARCHAR(255) NOT NULL UNIQUE,
    password_hash   TEXT NOT NULL,
    password_algo   VARCHAR(20) NOT NULL DEFAULT 'argon2id',
    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    disabled        BOOLEAN NOT NULL DEFAULT FALSE,
    roles           TEXT[] NOT NULL DEFAULT '{}',
    db_admin        TEXT[] NOT NULL DEFAULT '{}',
    profile         JSONB NOT NULL DEFAULT '{}',
    last_login_at   TIMESTAMPTZ,
    login_attempts  INTEGER NOT NULL DEFAULT 0,
    lockout_until   TIMESTAMPTZ
);

CREATE INDEX idx_users_disabled ON users(disabled) WHERE disabled = TRUE;
```

Notes:
- `id` is `hash(username)[:16]` in hex (32 chars)
- `username` has UNIQUE constraint (replaces MongoDB unique index)
- `roles` and `db_admin` use PostgreSQL native arrays
- `profile` uses JSONB for flexible user metadata

## 5. Directory Structure

```
internal/core/storage/
├── types/
│   └── types.go              # User (no Database, no bson tags)
├── auth_provider.go          # NEW: Combines PG UserStore + Mongo RevocationStore
├── mongo/
│   ├── document_store.go
│   ├── document_provider.go
│   └── revocation_store.go
│   # DELETED: user_store.go, auth_provider.go
└── postgres/                 # NEW
    └── user_store.go
```

## 6. Configuration

```yaml
storage:
  auth:
    postgres:
      dsn: "postgres://user:pass@localhost:5432/syntrix?sslmode=disable"
      max_open_conns: 25
      max_idle_conns: 5
      conn_max_lifetime: 5m
    mongo:
      uri: "mongodb://localhost:27017"
      db: "syntrix_auth"
```

## 7. File Changes Summary

| File | Action |
|------|--------|
| `types/types.go` | Remove User.Database, remove bson tags |
| `mongo/user_store.go` | Delete |
| `mongo/user_store_*_test.go` | Delete |
| `mongo/auth_provider.go` | Delete |
| `mongo/auth_provider_test.go` | Delete |
| `postgres/user_store.go` | Create |
| `postgres/user_store_test.go` | Create |
| `storage/auth_provider.go` | Create |
| `storage/auth_provider_test.go` | Create |
| `storage/config/config.go` | Add AuthStorageConfig |
| `go.mod` | Add `github.com/lib/pq` |
