# Client Details

Date: December 26, 2025
Status: Draft
Scope: HTTP client implementation of `Service`.

## Why
- Provide remote access with the same `Service` interface as local engine.
- Keep request/response shapes aligned with HTTP adapter.

## Responsibilities
- Marshal/unmarshal requests/responses for all `Service` methods.
- Map HTTP status codes to domain errors (e.g., 404→ErrNotFound, 412→ErrPreconditionFailed).
- Stream watch events with line- or JSON-decoding.

## Interfaces (sketch)
- `NewClient(baseURL string) Service`
- Internal helpers: `post(ctx, endpoint, body)`, watch stream reader.

## Dependencies
- stdlib http/json; context.

## Testing (testify)
- Parity with handler via httptest server; error mapping; watch streaming decode and cancellation.

## Open Points
- Retry/backoff policy for transient errors; timeout defaults; watch reconnection strategy (with jitter/backoff).
- Whether to expose client-specific options (timeouts, headers) without widening `Service`; possibly via functional opts while keeping `Service` surface stable.

### Defaults / Execution Notes
- Timeouts: default per-request timeout (e.g., 5s CRUD, 30s query); watch uses longer read timeout (e.g., 2m) with keep-alive.
- Retries: transient 5xx/connection errors retry with jittered backoff (e.g., capped at 5 retries, max 30s total); no retries for 4xx.
- Watch reconnect: on EOF/error, reconnect with backoff/jitter; preserve last cursor if protocol allows (future enhancement).
- Options: functional opts to set timeouts/headers/custom http.Client while preserving `Service` signature.
 - IndexNotReady: treat as retriable after backoff; server may serve bounded fallback scans for very small queries (under `fallback_docs_max` in documents); client does not attempt its own fallback.

### Policy Values (initial)
- CRUD timeout: 5s; Query timeout: 30s; Watch read timeout: 2m.
- Retryable: 5xx and network errors; max 5 retries; backoff base 200ms, factor 2.0, jitter ±20%; max total wait 30s.
- Watch reconnect backoff: same backoff profile as retries; stop on context cancel.
