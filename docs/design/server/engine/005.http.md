# HTTP Adapter Details

Date: December 26, 2025
Status: Draft
Scope: HTTP handler over `Service` (internal API).

## Why
- Keep HTTP layer thin and decoupled; no leakage of internal structs.
- Preserve existing routes/JSON shapes for compatibility.

## Responsibilities
- Map routes to `Service` methods (documents, query, watch, replication, health).
- Stream watch responses with proper flushing and context cancellation.
- Validate/deserialize requests; map errors to HTTP status (404/409/412/etc.).
- Enforce tenant on edge: read `tenant` from the body, apply default tenant only in dev/test, and reject empty tenant in prod paths once callers are updated.

## Interfaces (sketch)
- `NewHTTPHandler(s Service) http.Handler`
- Routes: `/internal/v1/document/*`, `/internal/v1/query/execute`, `/internal/v1/watch`, `/internal/replication/v1/*`, `/health`.

## Dependencies
- `Service`; stdlib http/json; flusher for streaming.

## Testing (testify + httptest)
- Each route success/error paths (status/body mapping).
- Watch streaming: emits events, closes on context, error handling.
- Replication endpoints: status codes and payload shapes.

## Open Points
- Structured error response schema (today plain text); whether to standardize later (e.g., code/message fields) without breaking clients.
- Timeouts/body size limits for streaming watch; guidance for clients on reconnect/backoff.

### Retry/Idempotency Policy (initial)
- Safe to retry: `GetDocument`, `ExecuteQuery`, `Watch` (reconnect), `Pull`.
- Not safe to retry (no idempotency keys yet): `CreateDocument`, `ReplaceDocument`, `PatchDocument`, `DeleteDocument`, `Push`; clients must not auto-retry.
- Missing index/unready: handler returns `IndexNotReady` when the index is absent or the bounded fallback cap (`fallback_docs_max`, default 500 docs) would be exceeded/disabled; otherwise the engine may serve a small bounded fallback scan transparently. Clients may retry after backoff on `IndexNotReady`.

### Defaults / Execution Notes
- Error shape (proposed, backward-compatible opt-in): `{ "code": "NotFound", "message": "..." }`; keep status codes unchanged; allow plain text fallback.
- Timeouts: per-request server timeout (e.g., 5s for CRUD, 30s for query), watch uses context deadline or idle timeout (e.g., 2m) with heartbeat.
- Watch: flush after each event; close on context; if backend fails, terminate stream with log; clients expected to reconnect with backoff.
- Multi-tenant request shape: each POST body already includes `tenant`; keep response bodies tenant-neutral. Consider future header-based auth-derived tenant to reduce payload duplication.
