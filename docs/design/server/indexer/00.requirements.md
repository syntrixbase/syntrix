# Indexer Service Requirements

Date: December 26, 2025
Status: Draft
Scope: Secondary index service for accelerating query execution with pluggable index backends.

## Goals (Why)
- Provide accelerated lookup/ordering for queries while keeping storage (MongoDB) as the source of truth.
- Allow pluggable index backends (in-memory â†’ RocksDB/external KV) without touching Query Engine logic.
- Support index rebuild lifecycle (drop/rebuild, checkpoints, throttling).
- Honor multi-database isolation: indexes are partitioned by database and collection.

## Functional Requirements (How)
- Consume change events from Puller service to maintain index entries.
- Support `Search(plan)` for prefix/range queries with ordering.
- Manage rebuild lifecycle: drop/rebuild from storage scan, checkpoint persistence, throttling.
- Expose health/stats for hit/miss, lag, rebuild progress.
- Index templates define which fields to index per collection pattern.

## Non-Goals / Out of Scope
- Changing query DSL or adding new operators/aggregations.
- Implementing new storage backends (MongoDB stays primary).
- Global secondary index planner or cost-based optimizer in this iteration.
- Multi-region replication changes.

## Constraints
- Index is derived data; storage remains the source of truth.
- Index unavailability should fall back to storage scan (with limits).
- Avoid new external dependencies unless approved.
- Follow package visibility rules: implementations reside under `internal/indexer/...`.
- Keep hot path performance at least on par with fallback behavior.

## Testing & Quality
- Unit tests with `github.com/stretchr/testify`: interface contract tests, upsert/delete idempotency, ordering correctness.
- Ensure change-stream to index pipeline has coverage for ordering, tombstones, and CAS conflicts.
- Rebuild tests with pagination, throttling, and gap detection.

## Open Questions
- Index capability scope for first cut: prefix + single-field range vs early support for composite sort keys.
- Rebuild triggers and throttling: when to rebuild (on-demand vs scheduled), how to rate-limit scans on large collections.
- Hot/warm/cold interplay: policies for dropping indexes on cold collections and on-demand rebuild SLA.
