# Field Naming Conventions

**Date:** December 30, 2025
**Status:** Canonical Reference
**Purpose:** Single source of truth for field names across all system components

## Overview

This document defines the canonical field names used throughout the Syntrix system. All components (storage, API, events, SDK) MUST use these exact names to ensure consistency.

**When in doubt, refer to this document.**

---

## 1. Identifier Fields

### 1.1 Tenant Identifier

| Context | Field Name | JSON Key | BSON Key | Notes |
| ------- | ---------- | -------- | -------- | ----- |
| Storage (Document) | `TenantID` | `tenantId` | `tenant_id` | Stored in MongoDB |
| Storage (Event) | `TenantID` | `tenantId` | - | Change stream events |
| Puller (NormalizedEvent) | `TenantID` | `tenant` | - | **Shorter key for wire format** |
| API Response | - | `tenantId` | - | Matches storage |

**Rationale:** Puller events use shorter `tenant` key to reduce bandwidth on high-volume event streams. All other contexts use `tenantId` for clarity.

### 1.2 Document Identifier

| Context | Field Name | JSON Key | BSON Key | Notes |
| ------- | ---------- | -------- | -------- | ----- |
| Storage (Document) | `Id` | `id` | `_id` | Full path hash: `tenant:hash(fullpath)` |
| Storage (Event) | `Id` | `id` | - | References document ID |
| Puller (NormalizedEvent) | `DocumentID` | `documentId` | - | Explicit name for clarity |
| API Response | - | `id` | - | User-facing document ID |

**Rationale:**
- Storage uses short `id` / `_id` following MongoDB conventions
- Puller uses explicit `documentId` to distinguish from `eventId`

### 1.3 Event Identifier

| Context | Field Name | JSON Key | Notes |
| ------- | ---------- | -------- | ----- |
| Puller (NormalizedEvent) | `EventID` | `eventId` | Unique per event, for deduplication |

**Note:** `EventID` is generated by Puller, not by MongoDB. Format: `{clusterTime.T}-{clusterTime.I}-{documentId}` or similar.

---

## 2. Operation Types

### 2.1 Storage Event Types

Used in `storage.Event.Type`:

| Constant | Value | Description |
| -------- | ----- | ----------- |
| `EventCreate` | `"create"` | New document created |
| `EventUpdate` | `"update"` | Document modified |
| `EventDelete` | `"delete"` | Document deleted (soft delete) |

### 2.2 Puller Operation Types

Used in `NormalizedEvent.OperationType`:

| Constant | Value | MongoDB Source | Description |
| -------- | ----- | -------------- | ----------- |
| `OperationInsert` | `"insert"` | `insert` | New document |
| `OperationUpdate` | `"update"` | `update` | Field update |
| `OperationReplace` | `"replace"` | `replace` | Full document replace |
| `OperationDelete` | `"delete"` | `delete` | Document deleted |

**Mapping from MongoDB to Storage:**

| MongoDB operationType | Storage EventType | Notes |
| --------------------- | ----------------- | ----- |
| `insert` | `create` | Direct mapping |
| `update` | `update` | Direct mapping |
| `replace` | `update` | Treated as update |
| `delete` | `delete` | Direct mapping |

**Important:** Puller preserves MongoDB's original operation type (`insert`, `update`, `replace`, `delete`) for downstream consumers that need the distinction. Storage layer simplifies to three types.

---

## 3. Timestamp Fields

### 3.1 Document Timestamps

| Field | Type | JSON Key | BSON Key | Description |
| ----- | ---- | -------- | -------- | ----------- |
| `CreatedAt` | `int64` | `createdAt` | `created_at` | Unix milliseconds, set once on creation |
| `UpdatedAt` | `int64` | `updatedAt` | `updated_at` | Unix milliseconds, updated on every write |

### 3.2 Event Timestamps

| Context | Field | Type | JSON Key | Description |
| ------- | ----- | ---- | -------- | ----------- |
| Storage Event | `Timestamp` | `int64` | `timestamp` | Unix milliseconds |
| Puller Event | `Timestamp` | `int64` | `timestamp` | Unix milliseconds |
| Puller Event | `ClusterTime` | `primitive.Timestamp` | `clusterTime` | MongoDB cluster time `{T, I}` |

**ClusterTime Format:**
```json
{
  "clusterTime": {
    "T": 1234567890,
    "I": 1
  }
}
```

- `T`: Seconds since Unix epoch
- `I`: Increment within the same second (ordinal, not time-based)

---

## 4. Version Fields

| Field | Type | JSON Key | BSON Key | Description |
| ----- | ---- | -------- | -------- | ----------- |
| `Version` | `int64` | `version` | `version` | Optimistic concurrency control, auto-incremented |

---

## 5. Collection and Path Fields

| Field | Type | JSON Key | BSON Key | Description |
| ----- | ---- | -------- | -------- | ----------- |
| `Collection` | `string` | `collection` | `collection` | Parent collection path |
| `CollectionHash` | `string` | `collectionHash` | `collection_hash` | Compact hash for indexing |
| `Fullpath` | `string` | `-` | `fullpath` | Full document path (internal only) |
| `Parent` | `string` | `-` | `parent` | Parent of collection (internal only) |

**Note:** `Fullpath` and `Parent` are internal fields, not exposed in JSON responses.

---

## 6. Document Content Fields

| Field | Type | JSON Key | BSON Key | Description |
| ----- | ---- | -------- | -------- | ----------- |
| `Data` | `map[string]interface{}` | `data` | `data` | User-defined document content |
| `Deleted` | `bool` | `deleted` | `deleted` | Soft delete flag |

---

## 7. Puller-Specific Fields

### 7.1 NormalizedEvent Schema

This is the canonical event schema for inter-service communication.

```go
type NormalizedEvent struct {
    // Identity
    EventID      string `json:"eventId"`      // Unique event ID
    TenantID     string `json:"tenant"`       // Tenant identifier (short key)
    Collection   string `json:"collection"`   // Collection name
    DocumentID   string `json:"documentId"`   // Document identifier

    // Operation
    OperationType OperationType          `json:"operationType"` // insert/update/replace/delete
    FullDocument  map[string]interface{} `json:"fullDocument,omitempty"`
    UpdateDesc    *UpdateDescription     `json:"updateDescription,omitempty"`

    // Metadata
    ClusterTime   primitive.Timestamp `json:"clusterTime"`
    TxnNumber     *int64              `json:"txnNumber,omitempty"`
    Timestamp     int64               `json:"timestamp"`
}
```

### 7.2 UpdateDescription Schema

```go
type UpdateDescription struct {
    UpdatedFields   map[string]interface{} `json:"updatedFields,omitempty"`
    RemovedFields   []string               `json:"removedFields,omitempty"`
    TruncatedArrays []TruncatedArray       `json:"truncatedArrays,omitempty"`
}

type TruncatedArray struct {
    Field   string `json:"field"`
    NewSize int    `json:"newSize"`
}
```

---

## 8. API Response Fields

### 8.1 Document Response

```json
{
  "id": "doc-123",
  "collection": "users/alice/posts",
  "version": 5,
  "createdAt": 1700000000000,
  "updatedAt": 1700000001000,
  "deleted": false,
  "data": {
    "title": "Hello World",
    "content": "..."
  }
}
```

### 8.2 Error Response

```json
{
  "code": "NOT_FOUND",
  "message": "Document not found",
  "details": {}
}
```

---

## 9. Naming Convention Rules

### 9.1 Go Field Names

- Use `PascalCase` for exported fields
- Use `camelCase` for unexported fields
- Suffix with type for clarity: `TenantID` not `Tenant`, `DocumentID` not `Document`

### 9.2 JSON Keys

- Use `camelCase` for all JSON keys
- Keep keys short but descriptive
- Exception: Puller uses `tenant` (not `tenantId`) for bandwidth optimization

### 9.3 BSON Keys

- Use `snake_case` for all BSON keys
- Exception: `_id` follows MongoDB convention
- Exception: `fullpath` - common developer idiom, kept as single word

### 9.4 Constants

- Use `PascalCase` for Go constants
- String values use `lowercase` (e.g., `EventCreate = "create"`)

---

## 10. Field Mapping Quick Reference

| Concept | Go Field | JSON Key | BSON Key |
| ------- | -------- | -------- | -------- |
| Document ID | `Id` | `id` | `_id` |
| Tenant ID (storage) | `TenantID` | `tenantId` | `tenant_id` |
| Tenant ID (puller) | `TenantID` | `tenant` | - |
| Collection | `Collection` | `collection` | `collection` |
| Version | `Version` | `version` | `version` |
| Created timestamp | `CreatedAt` | `createdAt` | `created_at` |
| Updated timestamp | `UpdatedAt` | `updatedAt` | `updated_at` |
| Document content | `Data` | `data` | `data` |
| Soft delete flag | `Deleted` | `deleted` | `deleted` |
| Event type (storage) | `Type` | `type` | - |
| Operation type (puller) | `OperationType` | `operationType` | - |
| Event ID (puller) | `EventID` | `eventId` | - |
| Document ID (puller) | `DocumentID` | `documentId` | - |
| Cluster time (puller) | `ClusterTime` | `clusterTime` | - |
| Event timestamp | `Timestamp` | `timestamp` | - |

---

## 11. Migration Notes

### From Storage Event to Puller Event

When converting `storage.Event` to `NormalizedEvent`:

| storage.Event Field | NormalizedEvent Field | Transformation |
| ------------------- | --------------------- | -------------- |
| `Id` | `DocumentID` | Direct copy |
| `TenantID` | `TenantID` | Direct copy (JSON key changes) |
| `Type` | `OperationType` | Map: create→insert, update→update, delete→delete |
| `Document.Data` | `FullDocument` | Extract from Document |
| `Timestamp` | `Timestamp` | Direct copy |
| `ResumeToken` | - | Used for checkpointing, not in event |

---

## 12. References

- [Architecture Overview](001_architecture.md) - System architecture
- [Puller Architecture](puller/001.architecture.md) - Puller service design
- [Storage Types](../../../internal/storage/types/types.go) - Go type definitions
