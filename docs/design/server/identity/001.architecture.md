# Identity Architecture

**Date:** December 25, 2025
**Scope:** High-level architecture for Authentication (AuthN) and Authorization (AuthZ) under Identity.

## 1) Why (Goals & Constraints)

- Unify AuthN and AuthZ documents under Identity for discoverability.
- Self-hosted, single-tenant focus; JWT-based.
- Deny-by-default via data-driven rules (CEL subset), consistent with Firestore-style semantics.

## 2) Components (How)

- Auth Service: issues/validates JWT (access + optional refresh), manages revocation, password auth (exposed as `identity.AuthN`).
- Rules Engine: evaluates CEL rules on requests, path-matched; deny on missing rules or eval errors (exposed as `identity.AuthZ`).
- JWKS Publisher: exposes signing keys for gateway/query services; supports rotation.
- Revocation Store: shared KV + node LRU for token revoke/disable checks.
- Admin/Console: manages rules publish/rollback and user lifecycle (admin-only).

## 2.1) Public Interface Contract (identity.AuthN / identity.AuthZ)

- Why: reduce coupling to storage/JWT/CEL details, allow backend swap and enforcement in multiple entrypoints (REST/WS) with a single contract.
- How: expose only two interfaces via the top-level `identity` package; everything else remains internal/private.
    - **AuthN** (`identity.AuthN`, backed by `authn`): `SignIn(ctx, LoginRequest) -> TokenPair`, `Refresh(ctx, RefreshRequest) -> TokenPair`, `Logout(ctx, refreshToken)`, `GenerateSystemToken(serviceName)`, `Middleware(next)`, `MiddlewareOptional(next)`. Admin-only surface (user list/update) stays behind an admin handler and is not part of the public SDK.
    - **AuthZ** (`identity.AuthZ`, backed by `authz`): `Evaluate(ctx, path, action, Request, *Resource) (bool, error)`, `LoadRules(path)`, `UpdateRules(content)`, `GetRules()`. CEL env, query prefetch, and program cache remain hidden.
    - Context contract: typed keys for `userID`, `username`, `roles` set by `Middleware`; callers treat them as read-only claims.
    - Construction: `NewAuthN(userStore, revocationStore, tokenService)` and `NewAuthZ(querySvc)` (to be added) are the only exported constructors; helpers (password hashing, key IO, rule validation) remain unexported/internal. AuthZ constructor to include rule validation/ambiguity checks; AuthN constructor to assume explicit signup (no auto-register).

## 3) Request Flow (API/Realtime)

1) Client calls Gateway (REST/WS/SSE) with bearer token.
2) Gateway validates JWT (sig, exp/nbf, kid lookup via JWKS, revocation, disabled flag).
3) Gateway matches rule by document path; prefetches needed docs for `get/exists` hints.
4) Rules Engine evaluates CEL; deny-by-default, short-circuits on missing index before rule eval.
5) On allow, request proceeds to Query Engine/Storage.

## 4) Token Lifecycle & Rotation

- Access TTL ~15m; Refresh TTL ~7d (feature-flagged). Short TTL bounds blast radius.
- Rotation: new `kid` published via JWKS; overlap window until old tokens expire.
- Revocation: refresh `jti` (and optional access `jti`) stored in shared KV with TTL; broadcast to peers.

## 5) Reliability & Degradation

- Fail-closed on JWKS/revocation backend outages by default; emergency fail-open is feature-flagged and audited.
- Cache strategy: in-memory LRU for JWKS and revocation with background refresh.
- Rule validation: size/AST depth limits, bounded `get/exists`, forbidden functions; reject ambiguous path overlaps.

## 6) Observability

- Metrics: auth allow/deny, JWKS fetch errors/latency, revocation hit/miss, rule eval latency/result, index-miss counts.
- Logs (sampled): token validation failures, rule denies (redacted), kid misses.
- Traces: tags for `auth.result`, `rules_version`, `kid`, `revocation.checked`.

## 7) Diagram (ASCII)

```text
Client -> Gateway/Realtime -> [Auth Validate] -> [Rule Match/Eval] -> Query Engine -> Storage
                              | JWKS Cache |   | CEL + Prefetch |
                              | Revocation |   | Deny-by-default|
```

## 8) Related Docs

- AuthN details: [002.authentication.md](002.authentication.md)
- AuthZ rules: [003.authorization.md](003.authorization.md)
- Console/admin flows: see server console doc (010).
