# Puller Service Architecture

**Date:** December 29, 2025
**Status:** Design Draft
**Component:** Change Stream Puller (Fan-out Service)

## 1. Overview

The Puller is a standalone service that acts as a centralized fan-out layer between MongoDB and multiple event consumers. It watches MongoDB change streams, normalizes events, manages checkpoints, and distributes events to downstream consumers via JetStream.

### 1.1 Design Goals

- **Single MongoDB Connection**: Minimize load on MongoDB by maintaining only one change stream connection per backend
- **Fan-out**: Distribute events to multiple independent consumers (Engine Index, Streamer, Trigger Service)
- **Reliability**: Ensure no event loss through checkpoint management and resume token persistence
- **Scalability**: Support horizontal scaling through partitioning
- **Observability**: Provide metrics and health checks for monitoring

### 1.2 Position in Architecture

```text
┌─────────────────────────────────────────────────┐
│                   MongoDB                        │
│         (Primary + Replicas, Change Streams)     │
└──────────────────┬──────────────────────────────┘
                   │ (1 change stream per backend)
                   ▼
┌─────────────────────────────────────────────────┐
│              Puller Service                      │
│  ┌──────────────────────────────────────────┐   │
│  │ Change Stream Consumer                   │   │
│  │  • Watch MongoDB                         │   │
│  │  • Handle resume tokens                  │   │
│  │  • Detect gaps                           │   │
│  └──────────┬───────────────────────────────┘   │
│             │                                    │
│  ┌──────────▼───────────────────────────────┐   │
│  │ Event Normalizer                         │   │
│  │  • Convert BSON to internal format       │   │
│  │  • Flatten nested documents              │   │
│  │  • Add metadata (tenant, collection)     │   │
│  └──────────┬───────────────────────────────┘   │
│             │                                    │
│  ┌──────────▼───────────────────────────────┐   │
│  │ Partitioner                              │   │
│  │  • Partition by (tenant, collection, id) │   │
│  │  • Assign partition IDs                  │   │
│  └──────────┬───────────────────────────────┘   │
│             │                                    │
│  ┌──────────▼───────────────────────────────┐   │
│  │ Checkpoint Manager                       │   │
│  │  • Track resume tokens per partition     │   │
│  │  • Persist to etcd/MongoDB               │   │
│  │  • Recovery on restart                   │   │
│  └──────────┬───────────────────────────────┘   │
│             │                                    │
│  ┌──────────▼───────────────────────────────┐   │
│  │ JetStream Publisher                      │   │
│  │  • Publish to subjects by partition      │   │
│  │  • Handle backpressure                   │   │
│  │  • Batch writes                          │   │
│  └──────────┬───────────────────────────────┘   │
└─────────────┼───────────────────────────────────┘
              │ NATS JetStream
              │ Subject: puller.events.{collection}.{partition}
              │
     ┌────────┼────────┬────────────┬──────────┐
     ▼        ▼        ▼            ▼          ▼
┌─────────┐ ┌──────┐ ┌─────────┐ ┌──────┐  ┌────┐
│ Engine  │ │Stream│ │ Trigger │ │Custom│  │... │
│ (Index) │ │  er  │ │ Service │ │Consum│  │    │
└─────────┘ └──────┘ └─────────┘ └──────┘  └────┘
```

## 2. Core Components

### 2.1 Change Stream Consumer

Establishes and maintains MongoDB change stream connection, handles connection failures and automatic reconnection, applies resume tokens on startup and after failures, and detects gaps in event stream.

### 2.2 Event Normalizer

Converts MongoDB change stream events to internal event format, extracts tenant information, flattens nested document structures, and computes event hashes for deduplication.

### 2.3 Partitioner

Assigns events to partitions based on tenant, collection, and document key. Ensures consistent partition assignment for same document. Includes tenant ID in hash for tenant isolation.

### 2.4 Checkpoint Manager

Persists resume tokens per partition, recovers resume tokens on startup, and provides atomic checkpoint updates. Supports both etcd and MongoDB backends.

### 2.5 JetStream Publisher

Publishes normalized events to JetStream, handles backpressure from JetStream, batches events for efficiency, and retries on transient failures.

## 3. Canonical Event Schema

**IMPORTANT**: This section defines the Puller event schema. For the complete field naming conventions across all system components, see [Field Naming Conventions](../002_field_naming.md).

### 3.1 JSON Wire Format

```json
{
  "eventId": "unique-event-id",
  "tenant": "tenant-id",
  "collection": "collection-name",
  "documentId": "document-id",
  "operationType": "insert",
  "fullDocument": { },
  "updateDescription": {
    "updatedFields": { },
    "removedFields": ["field1"],
    "truncatedArrays": []
  },
  "clusterTime": { "T": 1234567890, "I": 1 },
  "txnNumber": null,
  "timestamp": 1234567890000
}
```

### 3.2 Field Specifications

| Field | JSON Key | Type | Required | Notes |
| ----- | -------- | ---- | -------- | ----- |
| Event ID | `eventId` | string | Yes | Unique identifier for deduplication |
| Tenant ID | `tenant` | string | Yes | NOT "tenantId" - shorter key |
| Collection | `collection` | string | Yes | Collection name |
| Document ID | `documentId` | string | Yes | NOT "documentKey" |
| Operation Type | `operationType` | string | Yes | lowercase: "insert", "update", "replace", "delete" |
| Full Document | `fullDocument` | object | No | Present for insert/update/replace |
| Update Description | `updateDescription` | object | No | Present for update operations |
| Cluster Time | `clusterTime` | object | Yes | MongoDB timestamp {T, I} |
| Transaction Number | `txnNumber` | int64 | No | Present if in transaction |
| Timestamp | `timestamp` | int64 | Yes | Unix milliseconds |

### 3.3 Operation Types

All operation types are **lowercase**:

- `"insert"` - New document created
- `"update"` - Document fields updated
- `"replace"` - Document replaced entirely
- `"delete"` - Document deleted

### 3.4 Go Type Definition

```go
// NormalizedEvent is the canonical event schema published by Puller.
// All consumers MUST use this definition.
type NormalizedEvent struct {
    // Identity
    EventID      string `json:"eventId"`
    TenantID     string `json:"tenant"`      // JSON: "tenant" (NOT "tenantId")
    Collection   string `json:"collection"`
    DocumentID   string `json:"documentId"`  // JSON: "documentId" (NOT "documentKey")

    // Operation
    Type         OperationType          `json:"operationType"` // lowercase
    FullDocument map[string]interface{} `json:"fullDocument,omitempty"`
    UpdateDesc   *UpdateDescription     `json:"updateDescription,omitempty"`

    // Metadata
    ClusterTime  primitive.Timestamp `json:"clusterTime"`
    TxnNumber    *int64              `json:"txnNumber,omitempty"`
    Timestamp    int64               `json:"timestamp"` // Unix milliseconds

    // Routing (internal, not serialized to JSON)
    PartitionKey string `json:"-"`
    PartitionID  int    `json:"-"`
}

type OperationType string

const (
    OperationInsert  OperationType = "insert"
    OperationUpdate  OperationType = "update"
    OperationReplace OperationType = "replace"
    OperationDelete  OperationType = "delete"
)

type UpdateDescription struct {
    UpdatedFields   map[string]interface{} `json:"updatedFields,omitempty"`
    RemovedFields   []string               `json:"removedFields,omitempty"`
    TruncatedArrays []TruncatedArray       `json:"truncatedArrays,omitempty"`
}

type TruncatedArray struct {
    Field   string `json:"field"`
    NewSize int    `json:"newSize"`
}
```

## 4. Event Flow

### 4.1 Normal Flow

1. MongoDB emits change event
2. ChangeStreamConsumer receives event
3. EventNormalizer converts to internal format
4. Partitioner assigns partition ID
5. JetStreamPublisher publishes to subject
6. CheckpointManager saves resume token (async)
7. Consumers receive from JetStream

### 4.2 Startup Recovery Flow

1. Puller starts
2. CheckpointManager loads resume tokens
3. For each partition:
   - If resume token exists → resume from token
   - If no resume token → start from "now"
4. ChangeStreamConsumer establishes connection
5. Begin processing events

### 4.3 Gap Detection and Recovery

1. GapDetector monitors time between events per partition
2. If gap exceeds threshold (default: 5 minutes):
   - Alert operators via metrics/logs
   - Mark partition as "stale"
   - Downstream consumers trigger rebuild
   - Resume from checkpoint after rebuild completes

## 5. Subject Patterns

### 5.1 Single Backend

```text
puller.events.{collection}.{partition}

Examples:
- puller.events.messages.0
- puller.events.messages.1
- puller.events.users.0
- puller.events.orders.3
```

### 5.2 Multi-Backend

```text
puller.events.{backend}.{collection}.{partition}

Examples:
- puller.events.default.messages.0
- puller.events.vip_a.messages.0
```

## 6. Key Design Decisions

### 6.1 JetStream Retention Policy

We use `LimitsPolicy` (not `InterestPolicy`) because:

- Events are retained for the full retention window regardless of consumer acknowledgment
- New consumers can catch up from any point within the retention window
- Simpler operational model - no need to pre-register consumers

### 6.2 Partition Key Includes Tenant

Including `tenantID` in the partition hash ensures:

1. Same document IDs in different tenants don't correlate to the same partition
2. Partition-level metrics remain tenant-isolated
3. Future per-tenant partition policies are possible

### 6.3 At-Least-Once Delivery

- Puller publishes events to JetStream with persistence
- Consumers must be idempotent (handle duplicate events)
- Events may be delivered multiple times on retry, reconnect, etc.

## 7. Related Documents

- [Field Naming Conventions](../002_field_naming.md) - **Single source of truth** for field names
- [Design Details](002.design-details.md) - Implementation details, configuration, deployment
- [Engine Integration with Puller](../engine/007.puller.md) - How Engine consumes from Puller
- [Engine Architecture](../engine/001.architecture.md) - Overall Engine architecture
- [Streamer Architecture](../streamer/001.architecture.md) - Streamer service design
