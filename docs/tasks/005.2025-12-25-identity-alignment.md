# Identity Alignment (AuthN/AuthZ)

Date: December 25, 2025
Status: Completed
Scope: Align identity documentation, interfaces, and implementation for AuthN/AuthZ.

## Goals

- Expose only `identity.AuthN` and `identity.AuthZ` as public surfaces; hide internal details.
- Eliminate gaps between docs and implementation for AuthN/AuthZ behaviors.
- Ensure docs, constructors, and context contracts are consistent and test-covered.

## Current Gaps

1) Sign-up vs auto-registration: code auto-registers on first login; `/auth/v1/signup` not implemented.
2) Password policy: code enforces length >=8; target is >=12 with complexity and breached password checks.
3) Throttling/lockout: doc assumes shared KV and per-IP; code stores counters on user record, lacks per-IP.
4) AuthZ precedence: doc promises most-specific-first + ambiguity rejection; engine iterates map order, no validation.
5) Public constructors: doc mentions `identity.NewAuthN/NewAuthZ`; code only has `authn.NewAuthService` and `authz.NewEngine`.
6) Context shape: middleware injects `userID/username/roles`; docs reference `request.authn.Username` conceptually.

## Decisions Needed

- Keep auto-registration or require explicit `/auth/v1/signup`? **Chosen:** explicit signup; disable auto-register.
- Enforce full password policy now vs staged rollout (min length + breached list). **Chosen:** enforce full policy.
- Implement KV-backed throttle + per-IP limits now or document weaker interim behavior. **Chosen:** KV-backed per-username/per-IP planned; leave interface/TODO, not implemented in this iteration.
- Implement AuthZ path sorting + conflict validation vs document weaker semantics temporarily. **Chosen:** implement deterministic ordering + ambiguity rejection.
- Public constructors and exposure. **Chosen:** add `identity` package with `AuthN`/`AuthZ` interfaces and `NewAuthN/NewAuthZ` constructors; hide helpers.
- Context keys. **Chosen:** typed context keys in `identity`; middleware writes them.

## Plan

- Docs: finalize semantics chosen above; update AuthN/AuthZ/Architecture accordingly.
- Interfaces: add `identity` package with `AuthN`/`AuthZ` interfaces and `NewAuthN/NewAuthZ` constructors; keep helpers unexported.
- Context: define typed context keys in `identity` and update middleware to use them; update docs to match actual keys.
- AuthN behavior: implement explicit signup (disable auto-register); align password policy enforcement; add per-IP + per-username throttling backed by shared store (interfaces/TODO this iteration); document interim behavior.
- AuthZ behavior: add deterministic match ordering (specificity) and publish-time ambiguity validation; update tests.
- Tests: add/extend unit tests (testify) for new constructors, middleware context keys, password policy, throttle/lockout, and AuthZ match ordering/ambiguity handling.
- API status: update Implementation Status when signup lands.
- Constructors: ensure `NewAuthN` assumes explicit signup and `NewAuthZ` performs validation/ambiguity checks; add TODOs if staged.
- Test coverage: new logic must reach >85% coverage; ensure critical paths (signup, password policy, throttling interfaces, AuthZ ordering/validation) are exercised.

## Implementation Notes / Risks

- Algorithms: current RS256; EdDSA plannedâ€”add config/keys and tests when implemented.
- Password policy: implement length + complexity now; provide pluggable breached-password checker (TODO) to add later.
- Throttling/lockout: planned KV-backed per-username/per-IP; ensure interfaces/TODOs are explicit so behavior is not assumed deployed.
- AuthZ matching: implement planned ordering (more concrete > fewer wildcards > longer path > declaration order) plus ambiguity rejection.
- Context keys: use typed keys in `identity`, match middleware injection, and map request fields accordingly.
- API status: after signup lands, update Implementation Status in design doc.

## Verification

- Unit tests (Go, testify) covering new constructors, context keys, password policy, throttle/lockout, AuthZ ordering/validation.
- Update docs (001/002/003) and task index once changes land.

## Status Log

- 2025-12-25: Task created, status set to In Progress.
- 2025-12-25: Implemented `identity` package, `SignUp`, deterministic AuthZ matching, and updated tests. Status set to Completed.
