name: syntrix

services:
  # =============================================================================
  # Core Infrastructure
  # =============================================================================

  mongodb:
    image: mongo:8.0
    container_name: syntrix-mongodb
    command:
      - "--replSet"
      - "rs0"
      - "--bind_ip_all"
      # WiredTiger cache configuration
      - "--wiredTigerCacheSizeGB"
      - "1"
      # Disable diagnostic data collection
      - "--setParameter"
      - "diagnosticDataCollectionEnabled=false"
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/init.js:ro
    healthcheck:
      test: |
        mongosh --eval "try { rs.status() } catch (e) { rs.initiate({_id:'rs0',members:[{_id:0,host:'localhost:27017'}]}) }"
      interval: 30s  # Reduced from 10s
      timeout: 10s
      retries: 3     # Reduced from 5
      start_period: 30s
    networks:
      - syntrix-net

  postgres:
    image: postgres:18-bookworm
    container_name: syntrix-postgres
    environment:
      POSTGRES_USER: syntrix
      POSTGRES_PASSWORD: syntrix
      POSTGRES_DB: syntrix
    ports:
      - "5432:5432"
    volumes:
      # PostgreSQL 18+ uses major-version-specific subdirectories under /var/lib/postgresql
      # Mount at /var/lib/postgresql to support pg_upgrade --link
      - postgres_data:/var/lib/postgresql
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./scripts/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U syntrix -d syntrix"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - syntrix-net

  nats:
    image: nats:2.12-alpine
    container_name: syntrix-nats
    command: ["--jetstream", "--store_dir=/data", "-m", "8222"]
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 30s  # Reduced from 10s
      timeout: 5s
      retries: 3
    networks:
      - syntrix-net

  # =============================================================================
  # Monitoring Stack
  # =============================================================================

  prometheus:
    image: prom/prometheus:v3.9.1
    container_name: syntrix-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"  # Reduced from 15d
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
      - "--storage.tsdb.min-block-duration=2h"  # Reduce write frequency
      - "--storage.tsdb.max-block-duration=2h"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s  # Reduced from 10s
      timeout: 5s
      retries: 3
    networks:
      - syntrix-net

  grafana:
    image: grafana/grafana:12.3.1
    container_name: syntrix-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      # Reduce CPU usage when idle
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_DASHBOARDS_MIN_REFRESH_INTERVAL=30s
      # Disable alerting to reduce CPU usage
      - GF_ALERTING_ENABLED=false
      - GF_UNIFIED_ALERTING_ENABLED=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s  # Reduced from 10s
      timeout: 5s
      retries: 3
    networks:
      - syntrix-net

  # =============================================================================
  # Syntrix Application (Optional - for local development, run outside Docker)
  # =============================================================================

  # Uncomment to run Syntrix in Docker
  # syntrix:
  #   build:
  #     context: ../..
  #     dockerfile: Dockerfile
  #   container_name: syntrix-server
  #   ports:
  #     - "8080:8080"   # HTTP API + /metrics
  #     - "9000:9000"   # gRPC
  #   environment:
  #     - MONGO_URI=mongodb://mongodb:27017
  #     - NATS_URL=nats://nats:4222
  #     - DB_NAME=syntrix
  #   depends_on:
  #     mongodb:
  #       condition: service_healthy
  #     nats:
  #       condition: service_healthy
  #   networks:
  #     - syntrix-net

networks:
  syntrix-net:
    driver: bridge

volumes:
  mongodb_data:
  postgres_data:
  nats_data:
  prometheus_data:
  grafana_data:
